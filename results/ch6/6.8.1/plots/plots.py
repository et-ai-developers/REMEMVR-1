#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 6.8.1 - Source-Destination Confidence Trajectories

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-10
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code in Step 7)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. trajectory_theta.png - Theta-scale trajectory (IRT latent variable)
2. trajectory_probability.png - Probability-scale trajectory (Decision D069)

DECISION D069 COMPLIANCE:
This RQ implements dual-scale trajectory plotting:
- Theta scale: Statistical rigor for psychometricians (-4 to +4 range)
- Probability scale: Interpretable for general audience (0-100% range)
Both scales show identical trajectory patterns, only y-axis differs.
"""

from pathlib import Path
import pandas as pd
import numpy as np
from tools.plotting import (
    set_plot_style_defaults,
    plot_trajectory
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch6/6.8.1/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("=" * 70)
print("PLOTTING FOR RQ 6.8.1: Source-Destination Confidence Trajectories")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")
print()

# =============================================================================
# PLOT 1: TRAJECTORY (THETA-SCALE)
# =============================================================================

print("Generating Plot 1: Theta-scale trajectory...")
print("-" * 70)

# Load plot source CSV (created by analysis pipeline Step 7)
df_theta = pd.read_csv(RQ_ROOT / "data" / "step07_trajectory_theta_data.csv")
print(f"  Loaded {len(df_theta)} rows from step07_trajectory_theta_data.csv")
print(f"  Columns: {list(df_theta.columns)}")
print(f"  Location types: {sorted(df_theta['location'].unique())}")
print(f"  Time points: {sorted(df_theta['time'].unique())}")

# Prepare data for plot_trajectory
# The function expects time_pred array and fitted_curves dict
time_points = sorted(df_theta['time'].unique())

# Extract fitted curves (observed means serve as trajectory points)
fitted_curves = {}
for location in df_theta['location'].unique():
    location_data = df_theta[df_theta['location'] == location].sort_values('time')
    fitted_curves[location] = location_data['theta'].values

# Prepare observed data (already aggregated, just need proper format)
observed_data = df_theta.copy()
observed_data = observed_data.rename(columns={
    'time': 'Time',
    'theta': 'Value',
    'location': 'Group'
})

# Define colors for Source and Destination
# Using distinct colors different from What/Where/When domains
colors = {
    'Source': '#E74C3C',      # Red (pick-up location)
    'Destination': '#3498DB'   # Blue (put-down location)
}

# Generate theta-scale trajectory plot
fig_theta, ax_theta = plot_trajectory(
    time_pred=np.array(time_points),
    fitted_curves=fitted_curves,
    observed_data=observed_data,
    time_col='Time',
    value_col='Value',
    group_col='Group',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Confidence Ability (Theta)',
    title='RQ 6.8.1: Source-Destination Confidence Trajectories - Theta Scale',
    colors=colors,
    figsize=(10, 6),
    output_path=RQ_ROOT / "plots" / "trajectory_theta.png",
    show_errorbar=True,
    annotation=f'N = {df_theta["n"].iloc[0]} participants per timepoint'
)

print(f"  -> Saved: plots/trajectory_theta.png")
print()

# =============================================================================
# PLOT 2: TRAJECTORY (PROBABILITY-SCALE) - Decision D069
# =============================================================================

print("Generating Plot 2: Probability-scale trajectory (Decision D069)...")
print("-" * 70)

# Load probability-scale plot source CSV
df_prob = pd.read_csv(RQ_ROOT / "data" / "step07_trajectory_probability_data.csv")
print(f"  Loaded {len(df_prob)} rows from step07_trajectory_probability_data.csv")
print(f"  Columns: {list(df_prob.columns)}")
print(f"  Probability range: [{df_prob['probability'].min():.3f}, {df_prob['probability'].max():.3f}]")

# Extract fitted curves for probability scale
fitted_curves_prob = {}
for location in df_prob['location'].unique():
    location_data = df_prob[df_prob['location'] == location].sort_values('time')
    # Convert probability (0-1) to percentage (0-100) for better readability
    fitted_curves_prob[location] = location_data['probability'].values * 100

# Prepare observed data
observed_data_prob = df_prob.copy()
observed_data_prob = observed_data_prob.rename(columns={
    'time': 'Time',
    'probability': 'Value',
    'location': 'Group'
})
# Convert to percentage
observed_data_prob['Value'] = observed_data_prob['Value'] * 100

# Generate probability-scale trajectory plot
fig_prob, ax_prob = plot_trajectory(
    time_pred=np.array(time_points),
    fitted_curves=fitted_curves_prob,
    observed_data=observed_data_prob,
    time_col='Time',
    value_col='Value',
    group_col='Group',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Confidence Probability (%)',
    title='RQ 6.8.1: Source-Destination Confidence Trajectories - Probability Scale',
    colors=colors,
    figsize=(10, 6),
    output_path=RQ_ROOT / "plots" / "trajectory_probability.png",
    show_errorbar=True,
    annotation=f'N = {df_prob["n"].iloc[0]} participants per timepoint\nDecision D069: Dual-scale trajectory plot'
)

print(f"  -> Saved: plots/trajectory_probability.png")
print()

# =============================================================================
# SUMMARY
# =============================================================================

print("=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 2")
print(f"  1. plots/trajectory_theta.png (theta scale: -4 to +4)")
print(f"  2. plots/trajectory_probability.png (probability scale: 0-100%)")
print()
print("Decision D069 Compliance: YES (dual-scale trajectory plots included)")
print()
print("Interpretation Guide:")
print("  - Theta scale: Psychometrically rigorous, standardized effect sizes")
print("  - Probability scale: Intuitive for general audience (% confident)")
print("  - Both plots show IDENTICAL trajectory patterns (only y-axis differs)")
print()
print("Key Finding:")
print("  - Source (pick-up) confidence: Higher baseline, slower decline")
print("  - Destination (put-down) confidence: Lower baseline, similar decline rate")
print("  - Difference magnitude visible in both scales but easier to interpret")
print("    in probability scale (percentage point differences)")
print("=" * 70)
