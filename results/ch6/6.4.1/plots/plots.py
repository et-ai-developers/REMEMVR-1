#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 6.4.1 - Paradigm Confidence Trajectories

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-10
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code Step 7)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. trajectory_theta.png - Theta-scale trajectory (IRT latent variable)
2. trajectory_probability.png - Probability-scale trajectory (Decision D069)
"""

from pathlib import Path
import pandas as pd
import numpy as np
from tools.plotting import set_plot_style_defaults, plot_trajectory

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch6/6.4.1/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("=" * 70)
print("STARTING PLOTTING FOR RQ 6.4.1: PARADIGM CONFIDENCE TRAJECTORIES")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")

# Paradigm colors (consistent with REMEMVR paradigm scheme)
PARADIGM_COLORS = {
    'IFR': '#E74C3C',  # Red - Interactive Free Recall
    'ICR': '#3498DB',  # Blue - Interactive Cued Recall
    'IRE': '#2ECC71'   # Green - Interactive Recognition
}

# =============================================================================
# PLOT 1: TRAJECTORY (THETA-SCALE)
# =============================================================================

print("\n" + "-" * 70)
print("PLOT 1: THETA-SCALE TRAJECTORY")
print("-" * 70)

# Load plot source CSV (created by analysis pipeline Step 7)
df_theta = pd.read_csv(RQ_ROOT / "data" / "step07_trajectory_theta_data.csv")
print(f"Loaded {len(df_theta)} rows from step07_trajectory_theta_data.csv")
print(f"Columns: {list(df_theta.columns)}")
print(f"Paradigms: {df_theta['paradigm'].unique()}")
print(f"Time range: {df_theta['time'].min():.1f} to {df_theta['time'].max():.1f} hours")

# Prepare fitted curves dictionary (using CI_lower/CI_upper for error representation)
# For plot_trajectory, we need time_pred array and fitted_curves dict
# Since CSV has aggregated data, we use the observed data directly

# Create time prediction array for smooth curves
time_pred = np.linspace(df_theta['time'].min(), df_theta['time'].max(), 100)

# Prepare fitted curves by paradigm
# Note: CSV has aggregated means, we'll use these as "fitted" values
fitted_curves = {}
for paradigm in ['IFR', 'ICR', 'IRE']:
    paradigm_data = df_theta[df_theta['paradigm'] == paradigm].sort_values('time')
    # Interpolate for smooth curve
    fitted_curves[paradigm] = np.interp(
        time_pred,
        paradigm_data['time'].values,
        paradigm_data['theta'].values
    )

# Prepare observed data in format expected by plot_trajectory
# The function expects columns: time_col, value_col, group_col for errorbar plotting
observed_data = df_theta.copy()
observed_data = observed_data.rename(columns={
    'time': 'Time',
    'theta': 'Value',
    'paradigm': 'Group'
})

# Generate plot
fig_theta, ax_theta = plot_trajectory(
    time_pred=time_pred,
    fitted_curves=fitted_curves,
    observed_data=observed_data,
    time_col='Time',
    value_col='Value',
    group_col='Group',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Confidence Ability (Theta)',
    title='RQ 6.4.1: Confidence Trajectory - Theta Scale',
    colors=PARADIGM_COLORS,
    figsize=(10, 6),
    output_path=RQ_ROOT / "plots" / "trajectory_theta.png",
    show_errorbar=True
)

print(f"-> Saved: plots/trajectory_theta.png")

# =============================================================================
# PLOT 2: TRAJECTORY (PROBABILITY-SCALE) - Decision D069
# =============================================================================

print("\n" + "-" * 70)
print("PLOT 2: PROBABILITY-SCALE TRAJECTORY (Decision D069)")
print("-" * 70)

# Load plot source CSV (already transformed to probability scale by Step 7)
df_prob = pd.read_csv(RQ_ROOT / "data" / "step07_trajectory_probability_data.csv")
print(f"Loaded {len(df_prob)} rows from step07_trajectory_probability_data.csv")
print(f"Columns: {list(df_prob.columns)}")
print(f"Probability range: {df_prob['probability'].min():.3f} to {df_prob['probability'].max():.3f}")

# Prepare fitted curves by paradigm (probability scale)
fitted_curves_prob = {}
for paradigm in ['IFR', 'ICR', 'IRE']:
    paradigm_data = df_prob[df_prob['paradigm'] == paradigm].sort_values('time')
    fitted_curves_prob[paradigm] = np.interp(
        time_pred,
        paradigm_data['time'].values,
        paradigm_data['probability'].values
    )

# Prepare observed data
observed_data_prob = df_prob.copy()
observed_data_prob = observed_data_prob.rename(columns={
    'time': 'Time',
    'probability': 'Value',
    'paradigm': 'Group'
})

# Generate plot
fig_prob, ax_prob = plot_trajectory(
    time_pred=time_pred,
    fitted_curves=fitted_curves_prob,
    observed_data=observed_data_prob,
    time_col='Time',
    value_col='Value',
    group_col='Group',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Probability of High Confidence',
    title='RQ 6.4.1: Confidence Trajectory - Probability Scale',
    colors=PARADIGM_COLORS,
    figsize=(10, 6),
    output_path=RQ_ROOT / "plots" / "trajectory_probability.png",
    show_errorbar=True
)

# Set y-axis to 0-1 range for probability scale
ax_prob.set_ylim(0, 1)
# Update y-axis label to percentage
ax_prob.set_ylabel('Probability of High Confidence')
# Resave with updated y-axis
fig_prob.savefig(RQ_ROOT / "plots" / "trajectory_probability.png", dpi=300, bbox_inches='tight')

print(f"-> Saved: plots/trajectory_probability.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 2")
print(f"  - plots/trajectory_theta.png (theta scale)")
print(f"  - plots/trajectory_probability.png (probability scale, D069)")
print("\nDecision D069 Compliance: YES (dual-scale trajectory plots included)")
print("All plots saved with 300 DPI publication quality.")
print("=" * 70)
