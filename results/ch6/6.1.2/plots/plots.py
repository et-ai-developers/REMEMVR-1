#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 6.1.2 - Two-Phase Pattern in Confidence Decline

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-10
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. twophase_trajectory.png - Dual-scale (theta + probability) two-phase trajectory plot
   - Top row: Theta-scale trajectories (Early segment left, Late segment right)
   - Bottom row: Probability-scale trajectories (Early segment left, Late segment right)
   - Decision D069 compliance: Both scales shown for interpretability
"""

from pathlib import Path
import sys
import pandas as pd
import numpy as np

# Add project root to path
PROJECT_ROOT = Path(__file__).resolve().parents[3]
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import (
    set_plot_style_defaults,
    plot_piecewise_trajectory
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch6/6.1.2/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("=" * 70)
print("PLOTTING FOR RQ 6.1.2: Two-Phase Pattern in Confidence Decline")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")
print()

# =============================================================================
# LOAD PLOT SOURCE CSVS
# =============================================================================

print("Loading plot source CSVs...")

# Load theta-scale plot data
df_theta = pd.read_csv(RQ_ROOT / "data" / "step06_twophase_theta_data.csv")
print(f"  Loaded theta data: {len(df_theta)} rows")
print(f"  Columns: {list(df_theta.columns)}")

# Load probability-scale plot data (Decision D069 dual-scale requirement)
df_prob = pd.read_csv(RQ_ROOT / "data" / "step06_twophase_probability_data.csv")
print(f"  Loaded probability data: {len(df_prob)} rows")
print(f"  Columns: {list(df_prob.columns)}")

# =============================================================================
# DATA PREPARATION FOR PLOT_PIECEWISE_TRAJECTORY
# =============================================================================

print("\nPreparing data for piecewise trajectory plotting...")

# The plot_piecewise_trajectory function expects specific column names:
# - segment_col (Segment - already present)
# - paradigm_col (need to add a dummy since we don't have factor grouping)
# - time_col (TSVR_hours - already present)
# - theta_obs_col (theta_confidence - need to rename)
# - theta_pred_col (fitted - already present)
# - ci_lower_col (CI_lower - already present)
# - ci_upper_col (CI_upper - already present)
# - data_type_col (need to add 'observed' vs 'predicted' markers)
# - slope_col (optional - we'll skip this for simplicity)

# Add dummy paradigm column (overall confidence, no factor split)
df_theta['paradigm'] = 'Confidence'
df_prob['paradigm'] = 'Confidence'

# Add data_type column (all rows are 'observed' since we have observed means)
# The fitted column provides model predictions
df_theta['data_type'] = 'observed'
df_prob['data_type'] = 'observed'

# Rename columns to match function expectations
# theta_confidence -> theta_observed (obs_col parameter)
# fitted stays as fitted (pred_col parameter)
df_theta = df_theta.rename(columns={'theta_confidence': 'theta_observed'})
df_prob = df_prob.rename(columns={'probability': 'prob_observed'})

# The function also expects prediction rows separate from observed
# We need to create prediction grid rows
# For simplicity, we'll use the existing fitted values as predictions
# and mark them as 'predicted' data type

# Create prediction rows by duplicating observed rows and marking as 'predicted'
df_theta_pred = df_theta.copy()
df_theta_pred['data_type'] = 'predicted'
df_theta_pred['theta_observed'] = np.nan  # No observed values for prediction rows
df_theta_pred['CI_lower'] = np.nan
df_theta_pred['CI_upper'] = np.nan

df_prob_pred = df_prob.copy()
df_prob_pred['data_type'] = 'predicted'
df_prob_pred['prob_observed'] = np.nan
df_prob_pred['CI_lower'] = np.nan
df_prob_pred['CI_upper'] = np.nan

# Combine observed and predicted rows
df_theta_combined = pd.concat([df_theta, df_theta_pred], ignore_index=True)
df_prob_combined = pd.concat([df_prob, df_prob_pred], ignore_index=True)

# Rename fitted column to match expected pred_col names
df_theta_combined = df_theta_combined.rename(columns={'fitted': 'theta_predicted'})
df_prob_combined = df_prob_combined.rename(columns={'fitted': 'prob_predicted'})

print(f"  Theta data prepared: {len(df_theta_combined)} rows (observed + predicted)")
print(f"  Probability data prepared: {len(df_prob_combined)} rows (observed + predicted)")

# =============================================================================
# PLOT: DUAL-SCALE TWO-PHASE TRAJECTORY (Decision D069)
# =============================================================================

print("\nGenerating dual-scale two-phase trajectory plot...")
print("  Decision D069: Both theta and probability scales for interpretability")

# Create 2x2 plot (theta scale top row, probability scale bottom row)
# Early segment left column, Late segment right column
fig, axes = plot_piecewise_trajectory(
    theta_data=df_theta_combined,
    prob_data=df_prob_combined,
    segment_col='Segment',
    paradigm_col='paradigm',
    time_col='TSVR_hours',
    theta_obs_col='theta_observed',
    theta_pred_col='theta_predicted',
    prob_obs_col='prob_observed',
    prob_pred_col='prob_predicted',
    ci_lower_col='CI_lower',
    ci_upper_col='CI_upper',
    data_type_col='data_type',
    segment_order=['Early', 'Late'],
    paradigm_colors={'Confidence': '#9B59B6'},  # Purple for confidence
    figsize=(14, 10),  # Larger for 2x2 grid
    output_path=RQ_ROOT / "plots" / "twophase_trajectory.png",
    title='Two-Phase Confidence Trajectory',
    suptitle='RQ 6.1.2: Two-Phase Pattern in Confidence Decline (Early vs Late Segments)'
)

print(f"  Plot saved: plots/twophase_trajectory.png")
print(f"  Layout: 2 rows (theta, probability) x 2 columns (Early, Late)")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print("Plots generated: 1")
print("  - plots/twophase_trajectory.png (2x2 grid: theta + probability scales)")
print()
print("Decision D069 Compliance: YES")
print("  - Theta scale (top row): Psychometrician-interpretable")
print("  - Probability scale (bottom row): General audience-interpretable")
print()
print("Two-Phase Pattern Visualization:")
print("  - Early segment (left): 0-48 hours (rapid consolidation)")
print("  - Late segment (right): 48-144 hours (slower decay)")
print("  - Separate slopes allow visual inspection of two-phase hypothesis")
print()
print("All plots saved with 300 DPI publication quality.")
print("=" * 70)
