#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 6.3.1 - Domain Confidence Trajectories

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-10
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. trajectory_theta.png - Theta-scale trajectory (IRT latent variable)
2. trajectory_probability.png - Probability-scale trajectory (Decision D069)

RESEARCH QUESTION:
Do What/Where/When episodic memory domains show different confidence decline
patterns across a 6-day retention interval?

NULL HYPOTHESIS: Domain x Time interaction non-significant (domain-invariant pattern)
"""

from pathlib import Path
import pandas as pd
import numpy as np
import sys

# Add project root to path for tools import
project_root = Path(__file__).resolve().parents[3]
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

from tools.plotting import (
    set_plot_style_defaults,
    plot_trajectory
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch6/6.3.1/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("="*70)
print("PLOTTING FOR RQ 6.3.1 - DOMAIN CONFIDENCE TRAJECTORIES")
print("="*70)
print(f"RQ root: {RQ_ROOT}")
print()

# Define domain colors (What/Where/When standard palette)
DOMAIN_COLORS = {
    'What': '#E74C3C',   # Red - Semantic memory
    'Where': '#3498DB',  # Blue - Spatial memory
    'When': '#2ECC71'    # Green - Temporal memory
}

# =============================================================================
# PLOT 1: TRAJECTORY (THETA-SCALE)
# =============================================================================

print("Generating Plot 1: Theta-scale trajectory...")
print("-" * 70)

# Load plot source CSV (created by analysis pipeline)
theta_data_path = RQ_ROOT / "data" / "step07_trajectory_theta_data.csv"
df_theta = pd.read_csv(theta_data_path)
print(f"  Loaded {len(df_theta)} rows from trajectory_theta_data.csv")
print(f"  Columns: {list(df_theta.columns)}")
print(f"  Domains: {sorted(df_theta['domain'].unique())}")
print(f"  Time points: {sorted(df_theta['time'].unique())}")

# Prepare data for plot_trajectory function
# Function expects:
# - time_pred: array of x-values for fitted curves (smooth)
# - fitted_curves: dict of {domain: y_values}
# - observed_data: DataFrame with time_col, value_col, group_col

# Create smooth time array for fitted curves (0 to 160 hours)
time_pred = np.linspace(df_theta['time'].min(), df_theta['time'].max(), 100)

# Create fitted curves dict (we'll use observed theta as fitted curve approximation)
# For true fitted curves from LMM, would load model predictions
# Here using observed means as trajectory curves
fitted_curves = {}
for domain in sorted(df_theta['domain'].unique()):
    domain_data = df_theta[df_theta['domain'] == domain].sort_values('time')
    # Interpolate to create smooth curve
    fitted_curves[domain] = np.interp(
        time_pred,
        domain_data['time'].values,
        domain_data['theta'].values
    )

# Prepare observed data format (long format for errorbar plotting)
# Need: time_col, value_col, group_col, plus CI bounds
observed_data = df_theta.copy()
observed_data = observed_data.rename(columns={
    'time': 'Time',
    'theta': 'Value',
    'domain': 'Group'
})

# Generate plot
fig_theta, ax_theta = plot_trajectory(
    time_pred=time_pred,
    fitted_curves=fitted_curves,
    observed_data=observed_data,
    time_col='Time',
    value_col='Value',
    group_col='Group',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Confidence Ability (Theta)',
    title='RQ 6.3.1: Confidence Trajectory - Theta Scale',
    colors=DOMAIN_COLORS,
    figsize=(10, 6),
    output_path=RQ_ROOT / "plots" / "trajectory_theta.png",
    show_errorbar=True,
    annotation='Confidence ratings: TC_* items (5-level ordinal)\nIRT: Graded Response Model (3-factor)'
)

print(f"  -> Saved: plots/trajectory_theta.png")
print()

# =============================================================================
# PLOT 2: TRAJECTORY (PROBABILITY-SCALE) - Decision D069
# =============================================================================

print("Generating Plot 2: Probability-scale trajectory (Decision D069)...")
print("-" * 70)

# Load probability-scale plot source CSV
prob_data_path = RQ_ROOT / "data" / "step07_trajectory_probability_data.csv"
df_prob = pd.read_csv(prob_data_path)
print(f"  Loaded {len(df_prob)} rows from trajectory_probability_data.csv")
print(f"  Columns: {list(df_prob.columns)}")
print(f"  Probability range: [{df_prob['probability'].min():.3f}, {df_prob['probability'].max():.3f}]")

# Create smooth time array for fitted curves
time_pred_prob = np.linspace(df_prob['time'].min(), df_prob['time'].max(), 100)

# Create fitted curves dict for probability scale
fitted_curves_prob = {}
for domain in sorted(df_prob['domain'].unique()):
    domain_data = df_prob[df_prob['domain'] == domain].sort_values('time')
    # Interpolate probability values
    fitted_curves_prob[domain] = np.interp(
        time_pred_prob,
        domain_data['time'].values,
        domain_data['probability'].values
    )

# Prepare observed data format
observed_data_prob = df_prob.copy()
observed_data_prob = observed_data_prob.rename(columns={
    'time': 'Time',
    'probability': 'Value',
    'domain': 'Group'
})

# Convert probability to percentage scale (0-1 -> 0-100%)
observed_data_prob['Value'] = observed_data_prob['Value'] * 100
observed_data_prob['CI_lower'] = observed_data_prob['CI_lower'] * 100
observed_data_prob['CI_upper'] = observed_data_prob['CI_upper'] * 100

# Scale fitted curves to percentage
fitted_curves_prob_pct = {
    domain: values * 100
    for domain, values in fitted_curves_prob.items()
}

# Generate plot
fig_prob, ax_prob = plot_trajectory(
    time_pred=time_pred_prob,
    fitted_curves=fitted_curves_prob_pct,
    observed_data=observed_data_prob,
    time_col='Time',
    value_col='Value',
    group_col='Group',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Probability Correct (%)',
    title='RQ 6.3.1: Confidence Trajectory - Probability Scale (D069)',
    colors=DOMAIN_COLORS,
    figsize=(10, 6),
    output_path=RQ_ROOT / "plots" / "trajectory_probability.png",
    show_errorbar=True,
    annotation='IRT theta -> probability via 2PL transformation\nInterpretable scale for non-psychometricians'
)

# Set y-axis limits for probability scale (0-100%)
ax_prob.set_ylim(0, 100)

# Save with updated limits
fig_prob.savefig(RQ_ROOT / "plots" / "trajectory_probability.png", dpi=300, bbox_inches='tight')

print(f"  -> Saved: plots/trajectory_probability.png")
print()

# =============================================================================
# SUMMARY
# =============================================================================

print("="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 2")
print(f"  - plots/trajectory_theta.png (theta scale: IRT latent ability)")
print(f"  - plots/trajectory_probability.png (probability scale: Decision D069)")
print()
print("Decision D069 compliance: YES (dual-scale trajectory plots included)")
print()
print("Hypothesis Test:")
print("  - NULL: Domain x Time interaction non-significant")
print("  - Expected: Domain-invariant confidence decline (all domains parallel)")
print("  - Visual inspection: Check if trajectories parallel or diverge")
print()
print("All plots saved with 300 DPI publication quality.")
print("="*70)
