#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.6 - Schema Congruence Consolidation vs Decay

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-11-25
PURPOSE: Create publication-ready two-panel piecewise trajectory plot

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code during step06)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. piecewise_trajectory.png - Two-panel plot (Early | Late segments)
   - Early panel: Days 0-1 (consolidation window with one night's sleep)
   - Late panel: Days 1-6 (decay-dominated phase)
   - Three congruence types: Common (baseline), Congruent, Incongruent

DESIGN NOTE:
- Decision D069: NOT applicable (piecewise segment comparison, not dual-scale)
- Uses matplotlib for two-panel layout + plot_trajectory() for trajectory logic
- Shows observed means with 95% CI + model predictions from piecewise LMM
"""

from pathlib import Path
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import sys

# Add project root to path for tools import
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/rq6/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("=" * 70)
print("RQ 5.6 PLOTTING: Schema Congruence Consolidation vs Decay")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")

# Congruence type colors (NOT standard WWW domain colors)
CONGRUENCE_COLORS = {
    "Common": "#7F8C8D",      # Gray - Common (baseline)
    "Congruent": "#27AE60",   # Green - Congruent (schema-consistent)
    "Incongruent": "#E74C3C"  # Red - Incongruent (schema-inconsistent)
}

# =============================================================================
# LOAD PLOT SOURCE DATA
# =============================================================================

print("\nLoading plot source CSVs...")

# Early segment data (Days 0-1, consolidation window)
df_early = pd.read_csv(RQ_ROOT / "plots" / "step06_piecewise_early_data.csv")
print(f"  Early segment: {len(df_early)} rows from step06_piecewise_early_data.csv")
print(f"    Columns: {list(df_early.columns)}")
print(f"    Congruence types: {sorted(df_early['Congruence'].unique())}")
print(f"    Days_within range: [{df_early['Days_within'].min():.2f}, {df_early['Days_within'].max():.2f}]")

# Late segment data (Days 1-6, decay-dominated phase)
df_late = pd.read_csv(RQ_ROOT / "plots" / "step06_piecewise_late_data.csv")
print(f"  Late segment: {len(df_late)} rows from step06_piecewise_late_data.csv")
print(f"    Columns: {list(df_late.columns)}")
print(f"    Congruence types: {sorted(df_late['Congruence'].unique())}")
print(f"    Days_within range: [{df_late['Days_within'].min():.2f}, {df_late['Days_within'].max():.2f}]")

# =============================================================================
# PLOT: TWO-PANEL PIECEWISE TRAJECTORY
# =============================================================================

print("\nGenerating Plot: Two-panel piecewise trajectory...")

# Create two-panel figure (Early | Late)
fig, (ax_early, ax_late) = plt.subplots(1, 2, figsize=(16, 6))

# -----------------------------------------------------------------------------
# Panel 1: Early Segment (Days 0-1, Consolidation Window)
# -----------------------------------------------------------------------------

print("  Panel 1: Early segment (Days 0-1)...")

for congruence in ["Common", "Congruent", "Incongruent"]:
    # Filter data for this congruence type
    df_cong = df_early[df_early['Congruence'] == congruence].copy()

    # Sort by Days_within for smooth plotting
    df_cong = df_cong.sort_values('Days_within')

    # Extract observed data (non-NaN theta_observed values)
    df_obs = df_cong[df_cong['theta_observed'].notna()].copy()

    # Plot model predictions (smooth line)
    ax_early.plot(
        df_cong['Days_within'],
        df_cong['theta_predicted'],
        color=CONGRUENCE_COLORS[congruence],
        linewidth=2.5,
        label=f'{congruence} (predicted)',
        alpha=0.9
    )

    # Plot observed means with error bars
    if len(df_obs) > 0:
        ax_early.errorbar(
            df_obs['Days_within'],
            df_obs['theta_observed'],
            yerr=[
                df_obs['theta_observed'] - df_obs['CI_lower_observed'],
                df_obs['CI_upper_observed'] - df_obs['theta_observed']
            ],
            fmt='o',
            color=CONGRUENCE_COLORS[congruence],
            markersize=8,
            capsize=5,
            capthick=2,
            alpha=0.7,
            label=f'{congruence} (observed)'
        )

# Early panel formatting
ax_early.set_xlabel('Days Since VR Encoding (within segment)', fontweight='bold', fontsize=12)
ax_early.set_ylabel('Memory Ability (Theta)', fontweight='bold', fontsize=12)
ax_early.set_title('Early Segment (Days 0-1)\nConsolidation Window', fontweight='bold', fontsize=13, pad=15)
ax_early.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax_early.grid(True, alpha=0.3)
ax_early.set_xlim(-0.05, 1.05)

# Add annotation for consolidation window
ax_early.text(
    0.02, 0.02,
    'One night\'s sleep\n(~24 hours)',
    transform=ax_early.transAxes,
    fontsize=9,
    style='italic',
    bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.3),
    verticalalignment='bottom'
)

print(f"    [PASS] Early panel complete")

# -----------------------------------------------------------------------------
# Panel 2: Late Segment (Days 1-6, Decay-Dominated Phase)
# -----------------------------------------------------------------------------

print("  Panel 2: Late segment (Days 1-6)...")

for congruence in ["Common", "Congruent", "Incongruent"]:
    # Filter data for this congruence type
    df_cong = df_late[df_late['Congruence'] == congruence].copy()

    # Sort by Days_within for smooth plotting
    df_cong = df_cong.sort_values('Days_within')

    # Extract observed data (non-NaN theta_observed values)
    df_obs = df_cong[df_cong['theta_observed'].notna()].copy()

    # Plot model predictions (smooth line)
    ax_late.plot(
        df_cong['Days_within'],
        df_cong['theta_predicted'],
        color=CONGRUENCE_COLORS[congruence],
        linewidth=2.5,
        label=f'{congruence} (predicted)',
        alpha=0.9
    )

    # Plot observed means with error bars
    if len(df_obs) > 0:
        ax_late.errorbar(
            df_obs['Days_within'],
            df_obs['theta_observed'],
            yerr=[
                df_obs['theta_observed'] - df_obs['CI_lower_observed'],
                df_obs['CI_upper_observed'] - df_obs['theta_observed']
            ],
            fmt='o',
            color=CONGRUENCE_COLORS[congruence],
            markersize=8,
            capsize=5,
            capthick=2,
            alpha=0.7,
            label=f'{congruence} (observed)'
        )

# Late panel formatting
ax_late.set_xlabel('Days Since Day 1 (within segment)', fontweight='bold', fontsize=12)
ax_late.set_ylabel('Memory Ability (Theta)', fontweight='bold', fontsize=12)
ax_late.set_title('Late Segment (Days 1-6)\nDecay-Dominated Phase', fontweight='bold', fontsize=13, pad=15)
ax_late.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax_late.grid(True, alpha=0.3)
ax_late.set_xlim(-0.1, 6.1)

# Add annotation for decay phase
ax_late.text(
    0.02, 0.02,
    'Post-consolidation\ndecay phase',
    transform=ax_late.transAxes,
    fontsize=9,
    style='italic',
    bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.3),
    verticalalignment='bottom'
)

print(f"    [PASS] Late panel complete")

# -----------------------------------------------------------------------------
# Save Figure
# -----------------------------------------------------------------------------

plt.tight_layout()

output_path = RQ_ROOT / "plots" / "piecewise_trajectory.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')

print(f"  [PASS] Saved: plots/piecewise_trajectory.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 1")
print(f"  - plots/piecewise_trajectory.png (two-panel: Early | Late)")
print(f"\nPlot structure:")
print(f"  - Early panel: Days 0-1 (consolidation window)")
print(f"  - Late panel: Days 1-6 (decay-dominated phase)")
print(f"  - Three congruence types: Common, Congruent, Incongruent")
print(f"  - Observed means with 95% CI + model predictions from piecewise LMM")
print(f"\nDecision D069: NOT applicable (piecewise segment comparison, not dual-scale)")
print("All plots saved with 300 DPI publication quality.")
print("=" * 70)
