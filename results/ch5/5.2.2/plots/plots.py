#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.2.2 - Differential Consolidation Across Memory Domains

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-11-23
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code during step05)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. piecewise_trajectory_theta.png - Theta-scale piecewise trajectory (IRT latent variable)
2. piecewise_trajectory_probability.png - Probability-scale piecewise trajectory (Decision D069)

DESIGN NOTE:
- Uses plot_trajectory() with pre-computed fitted curves from analysis step
- Shows Early/Late segment structure with consolidation boundary at ~24 hours
- Three domains: What (red), Where (blue), When (green)
"""

from pathlib import Path
import pandas as pd
import numpy as np
import sys

# Add project root to path for tools import
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import (
    set_plot_style_defaults,
    plot_trajectory
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.2.2/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("=" * 70)
print("RQ 5.2.2 PLOTTING: Differential Consolidation Across Memory Domains")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")

# Domain colors (consistent across all RQs)
DOMAIN_COLORS = {
    "what": "#E74C3C",   # Red - What domain
    "where": "#3498DB",  # Blue - Where domain
    "when": "#2ECC71"    # Green - When domain
}

# =============================================================================
# PLOT 1: PIECEWISE TRAJECTORY (THETA-SCALE)
# =============================================================================

print("\nGenerating Plot 1: Piecewise theta-scale trajectory...")

# Load plot source CSV (created by analysis pipeline step05)
df_theta = pd.read_csv(RQ_ROOT / "plots" / "step05_piecewise_theta_data.csv")
print(f"  Loaded {len(df_theta)} rows from step05_piecewise_theta_data.csv")
print(f"  Columns: {list(df_theta.columns)}")
print(f"  Domains: {sorted(df_theta['domain'].unique())}")
print(f"  Segments: {sorted(df_theta['Segment'].unique())}")

# Prepare time prediction array (smooth curve across full time range)
# Using actual time values from data for observed points
time_pred = np.linspace(df_theta['time'].min(), df_theta['time'].max(), 100)

# Prepare fitted curves dict from predicted_theta column
# Each domain gets its own fitted curve based on piecewise model predictions
fitted_curves = {}
for domain in df_theta['domain'].unique():
    domain_data = df_theta[df_theta['domain'] == domain].sort_values('time')
    # Use actual predicted values at each time point
    fitted_curves[domain] = domain_data['predicted_theta'].values

# Prepare observed data in long format for plot_trajectory
# Need columns: Time, Value, Group
observed_data = df_theta[['time', 'mean_theta', 'domain']].copy()
observed_data.columns = ['Time', 'Value', 'Group']

# For fitted curves, we need continuous time_pred array matching fitted_curves length
# Since we have discrete time points (4 per domain), use those directly
time_pred_per_domain = df_theta[df_theta['domain'] == 'what'].sort_values('time')['time'].values

# Generate plot
fig_theta, ax_theta = plot_trajectory(
    time_pred=time_pred_per_domain,
    fitted_curves={domain: df_theta[df_theta['domain'] == domain].sort_values('time')['predicted_theta'].values
                   for domain in df_theta['domain'].unique()},
    observed_data=observed_data,
    time_col='Time',
    value_col='Value',
    group_col='Group',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Memory Ability (Theta)',
    title='RQ 5.2: Piecewise Forgetting Trajectory - Theta Scale',
    colors=DOMAIN_COLORS,
    figsize=(10, 6),
    output_path=RQ_ROOT / "plots" / "piecewise_trajectory_theta.png",
    annotation="Early: Day 0-1 (consolidation) | Late: Day 1-6 (decay)"
)

print(f"  [PASS] Saved: plots/piecewise_trajectory_theta.png")

# =============================================================================
# PLOT 2: PIECEWISE TRAJECTORY (PROBABILITY-SCALE) - Decision D069
# =============================================================================

print("\nGenerating Plot 2: Piecewise probability-scale trajectory (Decision D069)...")

# Load probability-scale plot source CSV
df_prob = pd.read_csv(RQ_ROOT / "plots" / "step05_piecewise_probability_data.csv")
print(f"  Loaded {len(df_prob)} rows from step05_piecewise_probability_data.csv")

# Convert probability to percentage scale for interpretability
df_prob['mean_probability_pct'] = df_prob['mean_probability'] * 100
df_prob['predicted_probability_pct'] = df_prob['predicted_probability'] * 100

# Prepare observed data in long format
observed_data_prob = df_prob[['time', 'mean_probability_pct', 'domain']].copy()
observed_data_prob.columns = ['Time', 'Value', 'Group']

# Prepare fitted curves (probability percentage scale)
time_pred_prob = df_prob[df_prob['domain'] == 'what'].sort_values('time')['time'].values

# Generate plot
fig_prob, ax_prob = plot_trajectory(
    time_pred=time_pred_prob,
    fitted_curves={domain: df_prob[df_prob['domain'] == domain].sort_values('time')['predicted_probability_pct'].values
                   for domain in df_prob['domain'].unique()},
    observed_data=observed_data_prob,
    time_col='Time',
    value_col='Value',
    group_col='Group',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Probability Correct (%)',
    title='RQ 5.2: Piecewise Forgetting Trajectory - Probability Scale',
    colors=DOMAIN_COLORS,
    figsize=(10, 6),
    output_path=RQ_ROOT / "plots" / "piecewise_trajectory_probability.png",
    annotation="Decision D069: Dual-scale for interpretability"
)

# Set y-axis limits for probability plot (0-100%)
ax_prob.set_ylim(0, 100)

# Re-save with y-axis adjustment
fig_prob.savefig(RQ_ROOT / "plots" / "piecewise_trajectory_probability.png", dpi=300, bbox_inches='tight')

print(f"  [PASS] Saved: plots/piecewise_trajectory_probability.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 2")
print(f"  - plots/piecewise_trajectory_theta.png (theta scale)")
print(f"  - plots/piecewise_trajectory_probability.png (probability scale, Decision D069)")
print("\nAll plots saved with 300 DPI publication quality.")
print("Decision D069 compliance: BOTH theta + probability scale plots generated.")
print("=" * 70)
