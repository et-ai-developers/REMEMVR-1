#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.4.4: IRT-CTT Convergence for Schema Congruence-Specific Forgetting

GENERATED BY: Master (matching 5.3.5 style)
DATE: 2025-12-04
PURPOSE: Create publication-ready plots from individual-level data

PLOTS GENERATED:
1. scatterplot_irt_ctt.png - IRT theta vs CTT mean by congruence
2. trajectory_irt.png - IRT theta trajectories by congruence
3. trajectory_ctt.png - CTT mean trajectories by congruence
4. trajectory_comparison.png - Side-by-side IRT vs CTT
"""

from pathlib import Path
import sys
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import patsy
from scipy import stats

# Add project root to path for tools import
RQ_ROOT = Path(__file__).parent.parent
PROJECT_ROOT = RQ_ROOT.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

PLOTS_DIR = RQ_ROOT / "plots"
DATA_DIR = RQ_ROOT / "data"

# Apply consistent plotting theme
set_plot_style_defaults()

print("=" * 70)
print("RQ 5.4.4: IRT-CTT Convergence - Plotting (5.2.1 Style)")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")
print(f"Plots directory: {PLOTS_DIR}")

# Plot style constants (matching 5.2.1)
RESIDUAL_SCATTER_POINT_ALPHA = 0.15
MEAN_CI_ALPHA = 0.2
IRT_LINE_STYLE = 'dashed'

# Congruence color scheme
COLORS = {
    "common": "#E74C3C",        # Red - Common items
    "congruent": "#3498DB",     # Blue - Congruent items
    "incongruent": "#2ECC71",   # Green - Incongruent items
}

CONGRUENCE_LABELS = {
    "common": "Common",
    "congruent": "Congruent",
    "incongruent": "Incongruent"
}

# =============================================================================
# LOAD DATA AND MODELS
# =============================================================================

print("\n" + "-" * 70)
print("Loading data and models...")
print("-" * 70)

# Load LMM input data (individual-level observations)
irt_input = pd.read_csv(DATA_DIR / "step03_irt_lmm_input.csv")
ctt_input = pd.read_csv(DATA_DIR / "step03_ctt_lmm_input.csv")
print(f"  Loaded IRT input: {len(irt_input)} rows")
print(f"  Loaded CTT input: {len(ctt_input)} rows")

# Re-fit models (pickle loading has issues in this context)
import statsmodels.formula.api as smf

print("  Fitting IRT model...")
irt_model = smf.mixedlm(
    "theta ~ C(congruence) * log_TSVR",
    data=irt_input,
    groups=irt_input['UID'],
    re_formula="~log_TSVR"
).fit(reml=False, method='powell')
print(f"  IRT model fitted: AIC = {irt_model.aic:.2f}")

print("  Fitting CTT model...")
ctt_model = smf.mixedlm(
    "CTT_mean ~ C(congruence) * log_TSVR",
    data=ctt_input,
    groups=ctt_input['UID'],
    re_formula="~log_TSVR"
).fit(reml=False, method='powell')
print(f"  CTT model fitted: AIC = {ctt_model.aic:.2f}")

# Load merged data for scatterplot
merged_df = pd.read_csv(DATA_DIR / "step02_merged_irt_ctt.csv")
print(f"  Loaded merged data: {len(merged_df)} rows")

# =============================================================================
# HELPER: Create prediction grid with CIs
# =============================================================================

def create_pred_grid_with_ci(lmm_results, df_long, time_range):
    """Create prediction grid with 95% CI from LMM covariance matrix."""

    congruences = df_long['congruence'].unique()

    pred_grid = pd.DataFrame([
        (t, c) for c in congruences for t in time_range
    ], columns=['TSVR_hours', 'congruence'])

    pred_grid['log_TSVR'] = np.log(pred_grid['TSVR_hours'] + 1)

    # Get formula RHS and create design matrix
    formula_rhs = lmm_results.model.formula.split('~')[1].strip()
    design_matrix = patsy.dmatrix(formula_rhs, pred_grid, return_type='dataframe')

    # Predict mean
    pred_grid['mean'] = lmm_results.predict(pred_grid)

    # Calculate CI from fixed effects covariance
    fe_cov = lmm_results.cov_params().loc[lmm_results.fe_params.index, lmm_results.fe_params.index]
    design_matrix = design_matrix[fe_cov.columns]

    pred_var = np.sum((design_matrix @ fe_cov) * design_matrix, axis=1)
    pred_se = np.sqrt(pred_var)

    pred_grid['ci_lower'] = pred_grid['mean'] - 1.96 * pred_se
    pred_grid['ci_upper'] = pred_grid['mean'] + 1.96 * pred_se

    return pred_grid

# =============================================================================
# PLOT 1: SCATTERPLOT (IRT vs CTT)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 1: IRT vs CTT Scatterplot by Congruence...")
print("-" * 70)

fig, ax = plt.subplots(figsize=(10, 8))

for congruence in ['common', 'congruent', 'incongruent']:
    theta_col = f'theta_{congruence}'
    ctt_col = f'CTT_{congruence}'

    if theta_col not in merged_df.columns or ctt_col not in merged_df.columns:
        continue

    color = COLORS.get(congruence, '#333333')
    label = CONGRUENCE_LABELS.get(congruence, congruence)

    # Scatter points
    ax.scatter(
        merged_df[theta_col],
        merged_df[ctt_col],
        c=color,
        alpha=0.5,
        s=30,
        edgecolors='white',
        linewidth=0.5,
        label=label
    )

    # Add regression line
    valid = merged_df[[theta_col, ctt_col]].dropna()
    z = np.polyfit(valid[theta_col], valid[ctt_col], 1)
    p = np.poly1d(z)
    x_line = np.linspace(valid[theta_col].min(), valid[theta_col].max(), 100)

    r, _ = stats.pearsonr(valid[theta_col], valid[ctt_col])

    ax.plot(x_line, p(x_line), color=color, linestyle='--', linewidth=2,
            label=f'{label} (r={r:.2f})')

# Add annotation
ax.text(0.05, 0.95, 'Strong IRT-CTT convergence:\nr = 0.87-0.91 across congruence levels',
        transform=ax.transAxes, fontsize=10, verticalalignment='top',
        bbox=dict(boxstyle='round', facecolor='white', alpha=0.8))

ax.set_xlabel('IRT Theta Score', fontsize=12)
ax.set_ylabel('CTT Proportion Correct', fontsize=12)
ax.set_title('RQ 5.4.4: IRT-CTT Convergence by Schema Congruence', fontsize=14, fontweight='bold')
ax.legend(loc='lower right', framealpha=0.95)
ax.grid(True, linestyle='--', alpha=0.6)

plt.tight_layout()
fig.savefig(PLOTS_DIR / "scatterplot_irt_ctt.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'scatterplot_irt_ctt.png'}")

# =============================================================================
# PLOT 2: IRT TRAJECTORY (5.2.1 Style)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 2: IRT Theta Trajectory (5.2.1 style)...")
print("-" * 70)

# Create prediction grid with CI
time_range = np.linspace(irt_input['TSVR_hours'].min(), irt_input['TSVR_hours'].max(), 100)
irt_pred_grid = create_pred_grid_with_ci(irt_model, irt_input, time_range)

fig, ax = plt.subplots(figsize=(10, 6))

for congruence in ['common', 'congruent', 'incongruent']:
    color = COLORS.get(congruence, '#333333')
    label = CONGRUENCE_LABELS.get(congruence, congruence)

    # 1. Plot faded scatter points (individual observations)
    cong_data = irt_input[irt_input['congruence'] == congruence]
    ax.scatter(
        cong_data['TSVR_hours'],
        cong_data['theta'],
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get predictions for this congruence level
    cong_pred = irt_pred_grid[irt_pred_grid['congruence'] == congruence]

    # 3. Plot shaded CI band
    ax.fill_between(
        cong_pred['TSVR_hours'],
        cong_pred['ci_lower'],
        cong_pred['ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot dashed fitted curve
    ax.plot(
        cong_pred['TSVR_hours'],
        cong_pred['mean'],
        color=color,
        linestyle=IRT_LINE_STYLE,
        linewidth=2.5,
        label=label
    )

ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Memory Ability (Theta)', fontsize=12)
ax.set_title('RQ 5.4.4: Schema Congruence Forgetting Trajectories - IRT Theta Scale', fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, irt_input['TSVR_hours'].max() + 5)

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_irt.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_irt.png'}")

# =============================================================================
# PLOT 3: CTT TRAJECTORY (5.2.1 Style)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 3: CTT Proportion Trajectory (5.2.1 style)...")
print("-" * 70)

# Create prediction grid with CI for CTT
ctt_pred_grid = create_pred_grid_with_ci(ctt_model, ctt_input, time_range)

fig, ax = plt.subplots(figsize=(10, 6))

for congruence in ['common', 'congruent', 'incongruent']:
    color = COLORS.get(congruence, '#333333')
    label = CONGRUENCE_LABELS.get(congruence, congruence)

    # 1. Plot faded scatter points (individual observations)
    cong_data = ctt_input[ctt_input['congruence'] == congruence]
    ax.scatter(
        cong_data['TSVR_hours'],
        cong_data['CTT_mean'] * 100,  # Convert to percentage
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get predictions for this congruence level
    cong_pred = ctt_pred_grid[ctt_pred_grid['congruence'] == congruence].copy()

    # 3. Plot shaded CI band (convert to percentage)
    ax.fill_between(
        cong_pred['TSVR_hours'],
        cong_pred['ci_lower'] * 100,
        cong_pred['ci_upper'] * 100,
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot dashed fitted curve
    ax.plot(
        cong_pred['TSVR_hours'],
        cong_pred['mean'] * 100,
        color=color,
        linestyle=IRT_LINE_STYLE,
        linewidth=2.5,
        label=label
    )

ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Proportion Correct (%)', fontsize=12)
ax.set_title('RQ 5.4.4: Schema Congruence Forgetting Trajectories - CTT Scale', fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, ctt_input['TSVR_hours'].max() + 5)
ax.set_ylim(0, 100)

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_ctt.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_ctt.png'}")

# =============================================================================
# PLOT 4: SIDE-BY-SIDE COMPARISON (IRT vs CTT)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 4: Side-by-side IRT vs CTT Trajectory Comparison...")
print("-" * 70)

fig, axes = plt.subplots(1, 2, figsize=(14, 6))

# Left panel: IRT
ax = axes[0]
for congruence in ['common', 'congruent', 'incongruent']:
    color = COLORS.get(congruence, '#333333')
    label = CONGRUENCE_LABELS.get(congruence, congruence)

    # Scatter
    cong_data = irt_input[irt_input['congruence'] == congruence]
    ax.scatter(cong_data['TSVR_hours'], cong_data['theta'],
               c=color, alpha=RESIDUAL_SCATTER_POINT_ALPHA, s=15, edgecolors='none')

    # CI band
    cong_pred = irt_pred_grid[irt_pred_grid['congruence'] == congruence]
    ax.fill_between(cong_pred['TSVR_hours'], cong_pred['ci_lower'], cong_pred['ci_upper'],
                    color=color, alpha=MEAN_CI_ALPHA, edgecolor='none')

    # Fitted curve
    ax.plot(cong_pred['TSVR_hours'], cong_pred['mean'],
            color=color, linestyle=IRT_LINE_STYLE, linewidth=2.5, label=label)

ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Memory Ability (Theta)', fontsize=12)
ax.set_title('IRT Theta Scale', fontsize=13, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=9)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, irt_input['TSVR_hours'].max() + 5)

# Right panel: CTT
ax = axes[1]
for congruence in ['common', 'congruent', 'incongruent']:
    color = COLORS.get(congruence, '#333333')
    label = CONGRUENCE_LABELS.get(congruence, congruence)

    # Scatter
    cong_data = ctt_input[ctt_input['congruence'] == congruence]
    ax.scatter(cong_data['TSVR_hours'], cong_data['CTT_mean'] * 100,
               c=color, alpha=RESIDUAL_SCATTER_POINT_ALPHA, s=15, edgecolors='none')

    # CI band
    cong_pred = ctt_pred_grid[ctt_pred_grid['congruence'] == congruence].copy()
    ax.fill_between(cong_pred['TSVR_hours'], cong_pred['ci_lower'] * 100, cong_pred['ci_upper'] * 100,
                    color=color, alpha=MEAN_CI_ALPHA, edgecolor='none')

    # Fitted curve
    ax.plot(cong_pred['TSVR_hours'], cong_pred['mean'] * 100,
            color=color, linestyle=IRT_LINE_STYLE, linewidth=2.5, label=label)

ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Proportion Correct (%)', fontsize=12)
ax.set_title('CTT Proportion Scale', fontsize=13, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=9)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, ctt_input['TSVR_hours'].max() + 5)
ax.set_ylim(0, 100)

fig.suptitle('RQ 5.4.4: IRT-CTT Convergence - Schema Congruence Forgetting Trajectories',
             fontsize=14, fontweight='bold', y=1.02)

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_comparison.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_comparison.png'}")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 4")
print(f"  - {PLOTS_DIR / 'scatterplot_irt_ctt.png'}")
print(f"  - {PLOTS_DIR / 'trajectory_irt.png'}")
print(f"  - {PLOTS_DIR / 'trajectory_ctt.png'}")
print(f"  - {PLOTS_DIR / 'trajectory_comparison.png'}")
print("\nPlot style (matching 5.2.1):")
print("  - Faded scatter points (individual observations, alpha=0.15)")
print("  - Dashed fitted curves (LMM predictions)")
print("  - Shaded 95% CI bands (from LMM covariance matrix)")
print("\nAll plots saved with 300 DPI publication quality.")
print("=" * 70)
