#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.3.9 - Paradigm x Item Difficulty Interaction

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-04
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

ARCHITECTURE:
- Plot source CSV created by analysis pipeline (step04)
- This script ONLY reads CSV and creates matplotlib plot
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. difficulty_trajectories.png - Forgetting trajectories by item difficulty and paradigm
"""

from pathlib import Path
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import warnings

# Suppress future warnings for cleaner output
warnings.filterwarnings('ignore', category=FutureWarning)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.3.9/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.dpi'] = 300
plt.rcParams['font.size'] = 10
plt.rcParams['axes.labelsize'] = 11
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['legend.fontsize'] = 9

print("Starting plotting for RQ 5.3.9...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: DIFFICULTY TRAJECTORIES BY PARADIGM
# =============================================================================

print("\nGenerating Plot 1: Difficulty trajectories by paradigm...")

# Load plot source CSV (created by analysis pipeline step04)
df = pd.read_csv(RQ_ROOT / "data" / "step04_difficulty_trajectories_data.csv")
print(f"  Loaded {len(df)} rows from step04_difficulty_trajectories_data.csv")
print(f"  Columns: {list(df.columns)}")

# Define colors for paradigms
colors = {
    'IFR': '#E74C3C',  # Red - Free Recall (hardest)
    'ICR': '#3498DB',  # Blue - Cued Recall (medium)
    'IRE': '#2ECC71'   # Green - Recognition (easiest)
}

# Define line styles for difficulty levels
line_styles = {
    'Easy (-1SD)': '-',    # Solid for easy
    'Hard (+1SD)': '--'    # Dashed for hard
}

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Plot each trajectory (3 paradigms x 2 difficulty levels = 6 lines)
for paradigm in ['IFR', 'ICR', 'IRE']:
    for difficulty in ['Easy (-1SD)', 'Hard (+1SD)']:
        # Filter data for this combination
        subset = df[(df['paradigm'] == paradigm) &
                   (df['difficulty_level'] == difficulty)]

        if len(subset) > 0:
            # Sort by time for proper line plotting
            subset = subset.sort_values('time_days')

            # Plot predicted response line
            ax.plot(subset['time_days'],
                   subset['predicted_response'],
                   color=colors[paradigm],
                   linestyle=line_styles[difficulty],
                   linewidth=2,
                   label=f"{paradigm} - {difficulty.split()[0]}")

            # Add 95% CI shaded area if available
            if not subset['CI_lower'].isna().all() and not subset['CI_upper'].isna().all():
                ax.fill_between(subset['time_days'],
                              subset['CI_lower'],
                              subset['CI_upper'],
                              color=colors[paradigm],
                              alpha=0.15)

            # Plot observed means as markers if available
            if not subset['observed_mean'].isna().all():
                # Only plot non-missing observed means
                obs_subset = subset[~subset['observed_mean'].isna()]
                if len(obs_subset) > 0:
                    ax.scatter(obs_subset['time_days'],
                             obs_subset['observed_mean'],
                             color=colors[paradigm],
                             marker='o' if difficulty == 'Easy (-1SD)' else 's',
                             s=60,
                             edgecolors='white',
                             linewidths=1.5,
                             alpha=0.8,
                             zorder=5)

# Customize plot
ax.set_xlabel('Days Since VR Encoding', fontsize=11, fontweight='bold')
ax.set_ylabel('Probability Correct', fontsize=11, fontweight='bold')
ax.set_title('RQ 5.3.9: Forgetting Trajectories by Item Difficulty and Paradigm',
            fontsize=12, fontweight='bold', pad=15)

# Set x-axis ticks to actual time points
ax.set_xticks([0, 1, 3, 6])
ax.set_xticklabels(['Day 0\n(Encoding)', 'Day 1', 'Day 3', 'Day 6'])

# Set y-axis limits and format
ax.set_ylim([0.3, 0.95])
ax.set_yticks([0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9])
ax.yaxis.set_major_formatter(plt.FuncFormatter(lambda y, _: f'{y:.1f}'))

# Add grid for readability
ax.grid(True, alpha=0.3, linestyle='--', linewidth=0.5)

# Create legend with paradigm and difficulty information
# Order legend entries: IFR Easy, IFR Hard, ICR Easy, ICR Hard, IRE Easy, IRE Hard
handles, labels = ax.get_legend_handles_labels()
# Reorder to group by paradigm
legend_order = []
legend_labels = []
for paradigm in ['IFR', 'ICR', 'IRE']:
    for difficulty in ['Easy', 'Hard']:
        for i, label in enumerate(labels):
            if paradigm in label and difficulty in label:
                legend_order.append(handles[i])
                legend_labels.append(label)
                break

ax.legend(legend_order, legend_labels,
         loc='upper right',
         framealpha=0.95,
         edgecolor='black',
         title='Paradigm - Difficulty',
         title_fontsize=9)

# Add note about significance
# From status.yaml context_dump: 3-way interaction NOT significant
ax.text(0.02, 0.02,
       'Note: 3-way interaction Time x Difficulty x Paradigm not significant (p_bonf > 0.0033)',
       transform=ax.transAxes,
       fontsize=8,
       verticalalignment='bottom',
       bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.3))

# Tight layout
plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "difficulty_trajectories.png"
plt.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  -> Saved: {output_path}")

# Close figure to free memory
plt.close(fig)

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/difficulty_trajectories.png")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
