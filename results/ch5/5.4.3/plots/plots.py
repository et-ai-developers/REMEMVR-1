#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.4.3 - Age x Schema Interactions

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-02
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. age_congruence_trajectories.png - 3-panel plot (one per age tertile)
   showing memory trajectories across congruence levels
"""

from pathlib import Path
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.4.3/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.4.3...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: AGE × CONGRUENCE TRAJECTORIES (3-PANEL)
# =============================================================================

print("\nGenerating Plot 1: Age × Congruence trajectories (3-panel)...")

# Load plot source CSV (created by analysis pipeline step05)
df_plot = pd.read_csv(RQ_ROOT / "data" / "step05_age_effects_plot_data.csv")
print(f"  Loaded {len(df_plot)} rows from step05_age_effects_plot_data.csv")
print(f"  Columns: {list(df_plot.columns)}")

# Define color scheme for congruence levels
colors = {
    'Common': '#95A5A6',      # Gray - neutral baseline
    'Congruent': '#2ECC71',   # Green - schema-consistent (positive)
    'Incongruent': '#E74C3C'  # Red - schema-inconsistent (negative)
}

# Age tertile order for plotting
tertile_order = ['Young', 'Middle', 'Older']

# Create 1×3 panel plot
fig, axes = plt.subplots(1, 3, figsize=(15, 5), sharey=True)

for idx, tertile in enumerate(tertile_order):
    ax = axes[idx]

    # Filter data for this tertile
    df_tertile = df_plot[df_plot['age_tertile'] == tertile]

    # Plot each congruence level
    for congruence in ['Common', 'Congruent', 'Incongruent']:
        df_cong = df_tertile[df_tertile['congruence'] == congruence]

        if len(df_cong) == 0:
            continue

        # Sort by time for clean line plot
        df_cong = df_cong.sort_values('TSVR_hours')

        color = colors[congruence]

        # Plot observed data with error bars (CI as shaded region)
        ax.plot(df_cong['TSVR_hours'], df_cong['mean_theta_observed'],
               'o-', color=color, linewidth=2.5, markersize=8,
               label=congruence, alpha=0.9)

        # Add confidence interval shading
        ax.fill_between(df_cong['TSVR_hours'],
                       df_cong['CI_lower'],
                       df_cong['CI_upper'],
                       color=color, alpha=0.2)

    # Panel formatting
    ax.set_xlabel('Hours Since VR Encoding (TSVR)', fontweight='bold')
    if idx == 0:
        ax.set_ylabel('Memory Ability (Theta)', fontweight='bold')
    ax.set_title(f'{tertile} Adults', fontweight='bold', fontsize=12)
    ax.grid(True, alpha=0.3)

    # Legend only on rightmost panel
    if idx == 2:
        ax.legend(loc='upper right', framealpha=0.95, title='Schema Congruence')

# Overall title
fig.suptitle('RQ 5.4.3: Age × Schema Congruence Interactions - NULL Result',
            fontweight='bold', fontsize=14, y=1.02)

# Add annotation about NULL finding
fig.text(0.5, -0.02,
        'Note: No significant Age × Congruence × Time interactions (all p_bonferroni > 0.025). '
        'Forgetting patterns similar across congruence levels regardless of age.',
        ha='center', fontsize=10, style='italic', wrap=True)

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "age_congruence_trajectories.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')

print(f"  [PASS] Saved: plots/age_congruence_trajectories.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/age_congruence_trajectories.png (3-panel: Young/Middle/Older)")
print("\nKey Finding: NULL RESULT")
print("  No significant Age × Congruence × Time interactions")
print("  Forgetting patterns are similar across schema congruence levels")
print("  regardless of participant age.")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
