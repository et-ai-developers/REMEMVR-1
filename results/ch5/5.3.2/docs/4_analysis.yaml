# ============================================================================
# ANALYSIS RECIPE - COMPLETE SPECIFICATION
# ============================================================================
# Generated: 2025-11-24
# RQ: ch5/5.3.2
# Agent: rq_analysis v4.0.0
# Purpose: Self-contained recipe for g_code agent (reads ONLY this file)
# ============================================================================

metadata:
  rq_id: "ch5/5.3.2"
  total_steps: 4
  analysis_type: "Secondary Analysis - Linear Trend Contrast on RQ 5.3 LMM"
  generated_by: "rq_analysis v4.0.0"
  timestamp: "2025-11-24T13:30:00"

  dependencies:
    - rq: "ch5/5.3.1"
      required_status: "rq_results: success"
      files:
        - "results/ch5/5.3.1/data/step05_lmm_fitted_model.pkl"
        - "results/ch5/5.3.1/data/step04_lmm_input.csv"
        - "results/ch5/5.3.1/data/step05_model_comparison.csv"

  decisions_applied:
    - id: "D068"
      description: "Dual p-value reporting (uncorrected + Bonferroni-corrected)"
    - id: "D070"
      description: "TSVR as time variable (inherited from RQ 5.3 model)"

# ============================================================================
# ANALYSIS STEPS - COMPLETE SPECIFICATIONS
# ============================================================================

steps:
  # --------------------------------------------------------------------------
  # STEP 0: Load RQ 5.3 Outputs
  # --------------------------------------------------------------------------
  - name: "step00_load_rq53_outputs"
    step_number: "00"
    description: "Load fitted LMM model and theta data from RQ 5.3 for contrast analysis"

    analysis_call:
      type: "stdlib"
      operations:
        - "Load LMM model: joblib.load('../rq3/data/step05_lmm_fitted_model.pkl')"
        - "Load theta data: pd.read_csv('../rq3/data/step04_lmm_input.csv')"
        - "Load model comparison: pd.read_csv('../rq3/data/step05_model_comparison.csv')"
        - "Verify best model is Log model (check model_comparison)"
        - "Verify model has attributes: params, cov_params, nobs"
        - "Map paradigm names to ordered categories: Free_Recall=1, Cued_Recall=2, Recognition=3"
        - "Write confirmation to data/step00_model_loaded.txt"

      input_files:
        - path: "../5.3.1/data/step05_lmm_fitted_model.pkl"
          absolute_path: "results/ch5/5.3.1/data/step05_lmm_fitted_model.pkl"
          description: "Fitted MixedLM model object from RQ 5.3 (Log model, best AIC)"
          variable_name: "lmm_model"
          source: "RQ 5.3 Step 5"
        - path: "../5.3.1/data/step04_lmm_input.csv"
          absolute_path: "results/ch5/5.3.1/data/step04_lmm_input.csv"
          description: "LMM input data with theta scores and TSVR"
          variable_name: "theta_data"
          required_columns: ["composite_ID", "UID", "test", "TSVR_hours", "TSVR_hours_log", "paradigm", "theta"]
          expected_rows: 1200
          source: "RQ 5.3 Step 4"
        - path: "../5.3.1/data/step05_model_comparison.csv"
          absolute_path: "results/ch5/5.3.1/data/step05_model_comparison.csv"
          description: "Model comparison results (AIC, delta_AIC, AIC_weight)"
          variable_name: "model_comparison"
          required_columns: ["model_name", "AIC", "delta_AIC", "AIC_weight", "converged"]
          source: "RQ 5.3 Step 5"

      output_files:
        - path: "data/step00_model_loaded.txt"
          variable_name: "confirmation_file"
          description: "Text file confirming successful model load"
          expected_content: "Model name, number of observations, paradigm levels"

      parameters:
        verify_model_type: "Log model (best AIC from RQ 5.3)"
        verify_attributes: ["params", "cov_params", "nobs"]
        expected_paradigms: ["Free_Recall", "Cued_Recall", "Recognition"]

      returns:
        type: "Tuple[MixedLMResults, pd.DataFrame, pd.DataFrame]"
        unpacking: "lmm_model, theta_data, model_comparison"

    validation_call:
      type: "catalogued"
      module: "tools.validation"
      function: "validate_lmm_convergence"
      signature: "validate_lmm_convergence(lmm_result: MixedLMResults) -> Dict[str, Any]"

      input_files:
        - path: "loaded model object (in memory)"
          variable_name: "lmm_model"
          source: "analysis call output"

      parameters:
        lmm_result: "lmm_model"

      returns:
        type: "Dict[str, Any]"
        variable_name: "validation_result"
        fields:
          converged: "bool"
          message: "str"
          warnings: "list"

      criteria:
        - "Model converged (no convergence warnings)"
        - "Model has valid parameters (not None, not NaN)"
        - "Model has accessible covariance matrix"
        - "Dependency files exist (pkl, csv)"
        - "Data has exactly 3 paradigm levels"
        - "Data has ~1200 observations"

      on_failure:
        action: "raise ValueError(validation_result['message'])"
        log_to: "logs/step00_load_rq53_outputs.log"
        message: "RQ 5.3 dependency missing or invalid - ensure RQ 5.3 completed successfully"

    log_file: "logs/step00_load_rq53_outputs.log"

  # --------------------------------------------------------------------------
  # STEP 1: Extract Marginal Means at Day 3 Midpoint
  # --------------------------------------------------------------------------
  - name: "step01_extract_marginal_means"
    step_number: "01"
    description: "Extract paradigm-specific marginal means (predicted theta) at Day 3 midpoint"

    analysis_call:
      type: "stdlib"
      operations:
        - "Determine Day 3 timepoint: TSVR_hours=72 or TSVR_hours_log=log(3)=1.099 for Log model"
        - "Create prediction grid: 3 paradigms x Day 3 timepoint"
        - "For each paradigm: Compute predicted theta using model.predict() or manual coefficient extraction"
        - "Extract model fixed effects coefficients for paradigm terms"
        - "Compute marginal mean = intercept + paradigm_effect + time_effect*log(3)"
        - "Compute standard errors from model covariance matrix using delta method"
        - "Compute 95% CI: mean +/- 1.96*SE"
        - "Create summary DataFrame with columns: paradigm, marginal_mean, SE, CI_lower, CI_upper"
        - "Save to data/step01_marginal_means.csv"

      input_files:
        - path: "data/step00_model_loaded.txt"
          description: "Confirmation of successful model load"
          variable_name: "confirmation_file"
          source: "Step 0"
        - path: "loaded LMM model object (in memory)"
          variable_name: "lmm_model"
          source: "Step 0"

      output_files:
        - path: "data/step01_marginal_means.csv"
          variable_name: "marginal_means"
          description: "Paradigm-level predictions at Day 3 midpoint"
          columns:
            - {name: "paradigm", type: "str", values: ["Free_Recall", "Cued_Recall", "Recognition"]}
            - {name: "marginal_mean", type: "float", range: [-3, 3], description: "Predicted theta at Day 3"}
            - {name: "SE", type: "float", range: [0.01, 1.0], description: "Standard error of prediction"}
            - {name: "CI_lower", type: "float", range: [-3, 3], description: "95% CI lower bound"}
            - {name: "CI_upper", type: "float", range: [-3, 3], description: "95% CI upper bound"}
          expected_rows: 3

      parameters:
        timepoint_nominal: "Day 3 (72 hours post-encoding)"
        timepoint_log: 1.099  # log(3) for Log model
        confidence_level: 0.95
        z_critical: 1.96
        paradigms:
          - "Free_Recall"
          - "Cued_Recall"
          - "Recognition"

      returns:
        type: "pd.DataFrame"
        variable_name: "marginal_means"

    validation_call:
      type: "stdlib"
      operations:
        - "Check file exists: data/step01_marginal_means.csv"
        - "Load CSV and verify shape: (3, 5)"
        - "Verify all 3 paradigms present"
        - "Verify no NaN values"
        - "Verify marginal_mean in range [-3, 3]"
        - "Verify SE > 0 and SE < 1"
        - "Verify CI_lower < marginal_mean < CI_upper for all rows"
        - "Verify no duplicate paradigm rows"

      input_files:
        - path: "data/step01_marginal_means.csv"
          variable_name: "marginal_means"
          source: "analysis call output"

      parameters:
        expected_rows: 3
        expected_columns: ["paradigm", "marginal_mean", "SE", "CI_lower", "CI_upper"]
        value_ranges:
          marginal_mean: [-3, 3]
          SE: [0.01, 1.0]

      returns:
        type: "bool"
        variable_name: "valid"

      criteria:
        - "Output file exists: data/step01_marginal_means.csv"
        - "Exactly 3 rows (one per paradigm)"
        - "All 3 paradigms present: Free_Recall, Cued_Recall, Recognition"
        - "No NaN values in any column"
        - "marginal_mean in [-3, 3]"
        - "SE in [0.01, 1.0]"
        - "CI_lower < marginal_mean < CI_upper"

      on_failure:
        action: "raise ValueError('Marginal means validation failed: ' + error_message)"
        log_to: "logs/step01_extract_marginal_means.log"

    log_file: "logs/step01_extract_marginal_means.log"

  # --------------------------------------------------------------------------
  # STEP 2: Compute Linear Trend Contrast
  # --------------------------------------------------------------------------
  - name: "step02_compute_linear_trend_contrast"
    step_number: "02"
    description: "Test linear trend contrast within RQ 5.3 LMM using polynomial weights [-1, 0, +1]"

    analysis_call:
      type: "stdlib"
      operations:
        - "Define linear contrast weights: Free_Recall=-1, Cued_Recall=0, Recognition=+1"
        - "Extract paradigm coefficient names from model (C(paradigm)[T.Cued_Recall], C(paradigm)[T.Recognition])"
        - "Compute contrast estimate using coefficient weighted sum"
        - "For linear contrast on slope: weight Recognition slope - weight Free slope"
        - "Extract relevant entries from model covariance matrix"
        - "Compute contrast SE using variance propagation formula"
        - "Compute z-statistic: estimate / SE"
        - "Compute p-value (two-tailed): 2 * scipy.stats.norm.sf(abs(z))"
        - "Apply Bonferroni correction: p_bonferroni = min(1.0, p_uncorrected * 15)"
        - "Determine significance: uncorrected (p < 0.05), corrected (p < 0.0033)"
        - "Compute 95% CI: estimate +/- 1.96*SE"
        - "Save results to results/step02_linear_trend_contrast.csv"
        - "Generate plain-language interpretation and save to results/step02_contrast_interpretation.txt"

      input_files:
        - path: "loaded LMM model object (in memory)"
          variable_name: "lmm_model"
          source: "Step 0"
        - path: "data/step01_marginal_means.csv"
          description: "Marginal means for reference/verification"
          variable_name: "marginal_means"
          source: "Step 1"

      output_files:
        - path: "data/step02_linear_trend_contrast.csv"
          variable_name: "contrast_results"
          description: "Linear trend contrast test results"
          columns:
            - {name: "contrast_name", type: "str", value: "Linear_Trend"}
            - {name: "estimate", type: "float", description: "Contrast estimate (weighted sum of coefficients)"}
            - {name: "SE", type: "float", range: [0.01, 1.0], description: "Standard error of contrast"}
            - {name: "z_value", type: "float", description: "z-statistic"}
            - {name: "p_value_uncorrected", type: "float", range: [0, 1], description: "Two-tailed p-value"}
            - {name: "p_value_bonferroni", type: "float", range: [0, 1], description: "Bonferroni-corrected p-value"}
            - {name: "significant_uncorrected", type: "bool", description: "p < 0.05"}
            - {name: "significant_bonferroni", type: "bool", description: "p < 0.0033"}
            - {name: "CI_lower", type: "float", description: "95% CI lower bound"}
            - {name: "CI_upper", type: "float", description: "95% CI upper bound"}
          expected_rows: 1
        - path: "data/step02_contrast_interpretation.txt"
          variable_name: "interpretation"
          description: "Plain-language interpretation of contrast results"
          expected_content: "Contrast estimate, direction, significance, theoretical interpretation"

      parameters:
        contrast_weights:
          Free_Recall: -1
          Cued_Recall: 0
          Recognition: 1
        bonferroni_n_tests: 15
        bonferroni_alpha: 0.0033
        alpha_uncorrected: 0.05
        z_critical: 1.96
        decision_D068: "Dual p-value reporting (uncorrected + Bonferroni)"

      returns:
        type: "pd.DataFrame"
        variable_name: "contrast_results"

    validation_call:
      type: "stdlib"
      operations:
        - "Check file exists: data/step02_linear_trend_contrast.csv"
        - "Check file exists: data/step02_contrast_interpretation.txt"
        - "Load CSV and verify shape: (1, 10)"
        - "Verify contrast_name == 'Linear_Trend'"
        - "Verify SE > 0"
        - "Verify p_value_uncorrected in [0, 1]"
        - "Verify p_value_bonferroni in [0, 1]"
        - "Verify p_value_bonferroni >= p_value_uncorrected"
        - "Verify CI_lower < estimate < CI_upper"
        - "Verify no NaN values"

      input_files:
        - path: "data/step02_linear_trend_contrast.csv"
          variable_name: "contrast_results"
          source: "analysis call output"
        - path: "data/step02_contrast_interpretation.txt"
          variable_name: "interpretation"
          source: "analysis call output"

      parameters:
        expected_rows: 1
        expected_columns: ["contrast_name", "estimate", "SE", "z_value", "p_value_uncorrected",
                          "p_value_bonferroni", "significant_uncorrected", "significant_bonferroni",
                          "CI_lower", "CI_upper"]

      returns:
        type: "bool"
        variable_name: "valid"

      criteria:
        - "Output file exists: data/step02_linear_trend_contrast.csv"
        - "Output file exists: data/step02_contrast_interpretation.txt"
        - "Exactly 1 row (single contrast test)"
        - "SE > 0 (standard error must be positive)"
        - "p_value_uncorrected in [0, 1]"
        - "p_value_bonferroni in [0, 1]"
        - "p_value_bonferroni >= p_value_uncorrected (Bonferroni more conservative)"
        - "CI_lower < estimate < CI_upper"
        - "No NaN values in any column"

      on_failure:
        action: "raise ValueError('Linear trend contrast validation failed: ' + error_message)"
        log_to: "logs/step02_compute_linear_trend_contrast.log"

    log_file: "logs/step02_compute_linear_trend_contrast.log"

  # --------------------------------------------------------------------------
  # STEP 3: Prepare Visualization Data
  # --------------------------------------------------------------------------
  - name: "step03_prepare_paradigm_plot_data"
    step_number: "03"
    description: "Create plot source CSV for bar plot with linear trend overlay"

    analysis_call:
      type: "stdlib"
      operations:
        - "Load marginal means from data/step01_marginal_means.csv"
        - "Load contrast results from data/step02_linear_trend_contrast.csv"
        - "Add paradigm_code column: Free_Recall=1, Cued_Recall=2, Recognition=3"
        - "Compute fitted linear trend line values using contrast slope"
        - "Trend line: For each paradigm_code x, compute trend_value = intercept + slope*(x - 2)"
        - "Where slope = contrast_estimate / 2 (since weights span -1 to +1)"
        - "And intercept = mean of marginal means (at paradigm_code=2)"
        - "Merge trend_line column into plot data"
        - "Save plot data to plots/step03_paradigm_forgetting_rates_data.csv"
        - "Format contrast annotation text (p-value, significance)"
        - "Save annotation to plots/step03_contrast_annotation.txt"

      input_files:
        - path: "data/step01_marginal_means.csv"
          description: "Marginal means from Step 1"
          variable_name: "marginal_means"
          required_columns: ["paradigm", "marginal_mean", "SE", "CI_lower", "CI_upper"]
          source: "Step 1"
        - path: "data/step02_linear_trend_contrast.csv"
          description: "Contrast results from Step 2"
          variable_name: "contrast_results"
          required_columns: ["estimate", "z_value", "p_value_uncorrected", "p_value_bonferroni"]
          source: "Step 2"

      output_files:
        - path: "plots/step03_paradigm_forgetting_rates_data.csv"
          variable_name: "plot_data"
          description: "Plot source CSV for bar plot with trend line"
          columns:
            - {name: "paradigm", type: "str", values: ["Free_Recall", "Cued_Recall", "Recognition"]}
            - {name: "paradigm_code", type: "int", values: [1, 2, 3]}
            - {name: "marginal_mean", type: "float", range: [-3, 3], description: "Predicted theta at Day 3 (y-axis for bars)"}
            - {name: "SE", type: "float", range: [0.01, 1.0], description: "Standard error (for error bars)"}
            - {name: "CI_lower", type: "float", range: [-3, 3], description: "95% CI lower bound"}
            - {name: "CI_upper", type: "float", range: [-3, 3], description: "95% CI upper bound"}
            - {name: "trend_line", type: "float", range: [-3, 3], description: "Fitted linear trend values (for overlay line)"}
          expected_rows: 3
        - path: "plots/step03_contrast_annotation.txt"
          variable_name: "annotation"
          description: "Plot annotation text with contrast statistics"
          expected_content: "Linear trend: estimate, z, p (formatted for plot subtitle)"

      parameters:
        paradigm_ordering:
          Free_Recall: 1
          Cued_Recall: 2
          Recognition: 3
        annotation_format: "Linear trend: beta = {estimate:.3f}, z = {z:.2f}, p = {p:.4f}"

      returns:
        type: "pd.DataFrame"
        variable_name: "plot_data"

    validation_call:
      type: "stdlib"
      operations:
        - "Check file exists: plots/step03_paradigm_forgetting_rates_data.csv"
        - "Check file exists: plots/step03_contrast_annotation.txt"
        - "Load CSV and verify shape: (3, 7)"
        - "Verify all 3 paradigms present"
        - "Verify paradigm_code correctly ordered: Free_Recall=1, Cued_Recall=2, Recognition=3"
        - "Verify no NaN values"
        - "Verify CI_lower < CI_upper for all rows"
        - "Verify marginal_mean in [-3, 3]"
        - "Verify trend_line in [-3, 3]"
        - "Verify no duplicate paradigm rows"

      input_files:
        - path: "plots/step03_paradigm_forgetting_rates_data.csv"
          variable_name: "plot_data"
          source: "analysis call output"
        - path: "plots/step03_contrast_annotation.txt"
          variable_name: "annotation"
          source: "analysis call output"

      parameters:
        expected_rows: 3
        expected_columns: ["paradigm", "paradigm_code", "marginal_mean", "SE", "CI_lower", "CI_upper", "trend_line"]
        value_ranges:
          paradigm_code: [1, 3]
          marginal_mean: [-3, 3]
          SE: [0.01, 1.0]
          trend_line: [-3, 3]

      returns:
        type: "bool"
        variable_name: "valid"

      criteria:
        - "Output file exists: plots/step03_paradigm_forgetting_rates_data.csv"
        - "Output file exists: plots/step03_contrast_annotation.txt"
        - "Exactly 3 rows (one per paradigm)"
        - "All 3 paradigms present: Free_Recall, Cued_Recall, Recognition"
        - "paradigm_code correctly ordered: Free_Recall=1, Cued_Recall=2, Recognition=3"
        - "No NaN values"
        - "CI_lower < CI_upper for all rows"
        - "marginal_mean in [-3, 3]"
        - "trend_line in [-3, 3]"

      on_failure:
        action: "raise ValueError('Plot data validation failed: ' + error_message)"
        log_to: "logs/step03_prepare_paradigm_plot_data.log"

    log_file: "logs/step03_prepare_paradigm_plot_data.log"

# ============================================================================
# END OF ANALYSIS RECIPE
# ============================================================================
