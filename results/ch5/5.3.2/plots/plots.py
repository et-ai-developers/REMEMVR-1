#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.4 - Linear Trend in Forgetting Rate Across Paradigms

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-11-24
PURPOSE: Create publication-ready bar plot showing paradigm-level forgetting rates

OPTION B ARCHITECTURE:
- Plot source CSV created by analysis pipeline (g_code)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. paradigm_forgetting_rates.png - Bar chart showing marginal means at Day 3
   with 95% CI error bars and linear trend line overlay

NOTE: Decision D069 (dual-scale trajectory) does NOT apply to RQ 5.4.
This RQ uses bar charts for cross-paradigm comparison, not trajectory curves.
"""

from pathlib import Path
import sys

# Add project root to path for tools import
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from tools.plotting import (
    set_plot_style_defaults,
    save_plot_with_data
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/rq4/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.4...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: PARADIGM FORGETTING RATES BAR CHART
# =============================================================================

print("\nGenerating Plot 1: Paradigm forgetting rates bar chart...")

# Load plot source CSV (created by analysis pipeline)
df = pd.read_csv(RQ_ROOT / "plots" / "step03_paradigm_forgetting_rates_data.csv")
print(f"  Loaded {len(df)} rows from step03_paradigm_forgetting_rates_data.csv")
print(f"  Columns: {list(df.columns)}")

# Load contrast annotation for plot subtitle
annotation_path = RQ_ROOT / "plots" / "step03_contrast_annotation.txt"
with open(annotation_path, 'r') as f:
    annotation_lines = f.readlines()

# Extract main annotation line (linear trend statistics)
main_annotation = None
for line in annotation_lines:
    if line.startswith("Linear trend:"):
        main_annotation = line.strip()
        break

print(f"  Annotation: {main_annotation}")

# Define colors for paradigms (consistent with REMEMVR theme)
colors = {
    'free_recall': '#E74C3C',    # Red
    'cued_recall': '#3498DB',    # Blue
    'recognition': '#2ECC71'     # Green
}

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Sort by paradigm_code to ensure correct order
df = df.sort_values('paradigm_code')

# Bar positions
x_positions = df['paradigm_code'].values
bar_colors = [colors.get(p, '#888888') for p in df['paradigm'].values]

# Create bar chart with error bars
bars = ax.bar(
    x_positions,
    df['marginal_mean'].values,
    yerr=1.96 * df['SE'].values,  # 95% CI
    color=bar_colors,
    edgecolor='black',
    linewidth=1.2,
    alpha=0.8,
    capsize=6,
    error_kw={'elinewidth': 2, 'capthick': 2}
)

# Add linear trend line
trend_line_values = df['trend_line'].values
ax.plot(
    x_positions,
    trend_line_values,
    'k--',
    linewidth=2,
    label='Linear Trend',
    alpha=0.7
)

# Add horizontal reference line at zero
ax.axhline(y=0, color='gray', linestyle='-', linewidth=1, alpha=0.5)

# Formatting
ax.set_xlabel('Retrieval Paradigm', fontweight='bold', fontsize=12)
ax.set_ylabel('Marginal Mean Theta (Day 3)', fontweight='bold', fontsize=12)
ax.set_title('RQ 5.4: Linear Trend in Forgetting Rate Across Paradigms',
             fontweight='bold', fontsize=13, pad=15)

# Set x-axis ticks with readable labels
paradigm_labels = ['Free Recall', 'Cued Recall', 'Recognition']
ax.set_xticks(x_positions)
ax.set_xticklabels(paradigm_labels, fontsize=11)

# Add subtitle with linear trend statistics
if main_annotation:
    ax.text(0.5, -0.12, main_annotation,
            transform=ax.transAxes,
            ha='center', va='top',
            fontsize=10, style='italic',
            color='#555555')

# Add legend
ax.legend(loc='upper right', framealpha=0.95)

# Grid
ax.grid(True, alpha=0.3, axis='y')

# Set y-axis limits with some padding
y_min = min(df['CI_lower'].min(), df['trend_line'].min()) - 0.1
y_max = max(df['CI_upper'].max(), df['trend_line'].max()) + 0.1
ax.set_ylim(y_min, y_max)

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "paradigm_forgetting_rates.png"
save_plot_with_data(
    fig=fig,
    output_path=output_path,
    data=df,
    dpi=300
)
print(f"  [PASS] Saved: plots/paradigm_forgetting_rates.png")

plt.close(fig)

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/paradigm_forgetting_rates.png")
print(f"")
print(f"Decision D069 (dual-scale trajectory): NOT APPLICABLE")
print(f"  -> This RQ uses bar charts for paradigm comparison, not trajectories")
print(f"")
print(f"Linear Trend Results:")
print(f"  - Estimate: b = -0.127")
print(f"  - z = -2.47, p = 0.01 (uncorrected)")
print(f"  - p = 0.20 (Bonferroni corrected)")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
