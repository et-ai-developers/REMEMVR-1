#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.2.6 - Domain-Specific Variance Decomposition

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-09
PURPOSE: Create publication-ready barplot from MODEL-AVERAGED ICC estimates

CRITICAL CHANGE (2025-12-09):
- NOW uses step08_averaged_iccs.csv (model-averaged ICCs across competitive models)
- PREVIOUS version used step07_domain_icc_barplot_data.csv (single Log-only model)
- Model-averaged ICC_slope_simple values:
  - What: 16.50% (vs 1.1% Log-only)
  - Where: 22.84% (vs 0.8% Log-only)
- This reflects multi-model uncertainty and improves robustness

OPTION B ARCHITECTURE:
- Plot source CSV created by analysis pipeline (g_code step 8)
- This script reads CSV and creates visualization
- Minimal inline transformation (reformatting for plot requirements)

PLOTS GENERATED:
1. domain_icc_barplot.png - ICC slope simple comparison across domains (MODEL-AVERAGED)

WHEN DOMAIN EXCLUSION APPLIED:
- When domain excluded due to floor effect (RQ 5.2.1)
- Only 2 domains plotted: What, Where
"""

from pathlib import Path
import sys
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.2.6/plots/)
RQ_ROOT = Path(__file__).parent.parent
PROJECT_ROOT = RQ_ROOT.parent.parent.parent

# Add project root to path to import tools
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.2.6...")
print(f"RQ root: {RQ_ROOT}")
print("\nNOTE: When domain excluded due to floor effect (per RQ 5.2.1)")
print("      Only What and Where domains plotted.")
print("\nCRITICAL: Using MODEL-AVERAGED ICCs from step08_averaged_iccs.csv")
print("          (reflects uncertainty across competitive models)\n")

# =============================================================================
# PLOT 1: DOMAIN ICC BARPLOT (MODEL-AVERAGED)
# =============================================================================

print("\nGenerating Plot 1: Domain ICC Comparison Barplot (Model-Averaged)...")

# Load model-averaged ICC data (created by analysis pipeline step 8)
df_iccs = pd.read_csv(RQ_ROOT / "data" / "step08_averaged_iccs.csv")
print(f"  Loaded {len(df_iccs)} rows from step08_averaged_iccs.csv")
print(f"  Columns: {list(df_iccs.columns)}")
print(f"  Domains: {df_iccs['domain'].tolist()}")

# Prepare plot data inline (minimal transformation for visualization)
# Extract ICC_slope_simple for plotting
plot_data = []
for _, row in df_iccs.iterrows():
    domain = row['domain']
    icc_value = row['ICC_slope_simple']

    # Characterize ICC magnitude (thresholds from 2_plan.md)
    if icc_value < 0.20:
        interpretation = 'Low'
    elif icc_value < 0.40:
        interpretation = 'Moderate'
    else:
        interpretation = 'Substantial'

    plot_data.append({
        'domain': domain,
        'icc_slope_simple': icc_value,
        'interpretation': interpretation
    })

df_plot = pd.DataFrame(plot_data)
print(f"\nPlot data prepared: {len(df_plot)} domains")
for _, row in df_plot.iterrows():
    print(f"  {row['domain']}: ICC={row['icc_slope_simple']:.4f} ({row['interpretation']})")

# Define color mapping based on interpretation categories
color_map = {
    'Low': '#E74C3C',          # Red - below 0.20
    'Moderate': '#F39C12',     # Orange - 0.20-0.40
    'Substantial': '#2ECC71'   # Green - >= 0.40
}

# Get bar colors based on interpretation
bar_colors = [color_map.get(interp, '#95A5A6') for interp in df_plot['interpretation']]

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Create barplot
x_positions = np.arange(len(df_plot))
bars = ax.bar(x_positions, df_plot['icc_slope_simple'],
              color=bar_colors, alpha=0.8, edgecolor='black', linewidth=1.5)

# Add threshold lines
threshold_moderate = 0.20  # Low/Moderate boundary
threshold_substantial = 0.40  # Moderate/Substantial boundary
ax.axhline(y=threshold_moderate, color='gray', linestyle=':', linewidth=1.5,
           label=f'Moderate Threshold ({threshold_moderate})', alpha=0.6)
ax.axhline(y=threshold_substantial, color='black', linestyle='--', linewidth=2,
           label=f'Substantial Threshold ({threshold_substantial})', alpha=0.7)

# Formatting
ax.set_xlabel('Memory Domain', fontweight='bold', fontsize=12)
ax.set_ylabel('ICC (Slope Simple) - Model Averaged', fontweight='bold', fontsize=12)
ax.set_title('RQ 5.2.6: Domain-Specific Variance Decomposition\n'
             'Model-Averaged ICC Slope Simple by Domain',
             fontweight='bold', fontsize=13, pad=15)
ax.set_xticks(x_positions)
ax.set_xticklabels(df_plot['domain'])
ax.set_ylim(0, 0.50)  # Focus on 0-50% range for better visibility
ax.grid(True, alpha=0.3, axis='y')

# Add value labels on top of bars
for i, (bar, value) in enumerate(zip(bars, df_plot['icc_slope_simple'])):
    height = bar.get_height()
    ax.text(bar.get_x() + bar.get_width()/2., height + 0.01,
            f'{value:.2%}',  # Format as percentage
            ha='center', va='bottom', fontweight='bold', fontsize=11)

# Create custom legend
from matplotlib.patches import Patch
legend_elements = [
    Patch(facecolor=color_map['Substantial'], edgecolor='black', label='Substantial (>= 40%)'),
    Patch(facecolor=color_map['Moderate'], edgecolor='black', label='Moderate (20-40%)'),
    Patch(facecolor=color_map['Low'], edgecolor='black', label='Low (< 20%)'),
    plt.Line2D([0], [0], color='black', linestyle='--', linewidth=2,
               label=f'Substantial Threshold ({threshold_substantial})'),
    plt.Line2D([0], [0], color='gray', linestyle=':', linewidth=1.5,
               label=f'Moderate Threshold ({threshold_moderate})')
]
ax.legend(handles=legend_elements, loc='upper right', framealpha=0.95, fontsize=9)

# Add interpretation note
note_text = ("Model-Averaged ICCs\n"
             "When domain excluded (floor effect)\n"
             "What: 16.50% | Where: 22.84%")
ax.text(0.02, 0.98, note_text, transform=ax.transAxes,
        fontsize=9, verticalalignment='top', style='italic',
        bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.3))

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "domain_icc_barplot.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"\n  -> Saved: plots/domain_icc_barplot.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/domain_icc_barplot.png")
print(f"\nDomains plotted: {', '.join(df_plot['domain'].tolist())}")
print(f"ICC range: [{df_plot['icc_slope_simple'].min():.2%}, "
      f"{df_plot['icc_slope_simple'].max():.2%}]")
print(f"Thresholds: Moderate >= {threshold_moderate}, Substantial >= {threshold_substantial}")
print(f"Domains meeting substantial threshold: "
      f"{(df_plot['icc_slope_simple'] >= threshold_substantial).sum()}/{len(df_plot)}")
print("\nModel-Averaged ICCs (key improvement over single-model estimates):")
for _, row in df_plot.iterrows():
    print(f"  {row['domain']}: {row['icc_slope_simple']:.2%} ({row['interpretation']})")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
