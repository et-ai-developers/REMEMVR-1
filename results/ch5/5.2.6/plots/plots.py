#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.2.6 - Domain-Specific Variance Decomposition

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-03
PURPOSE: Create publication-ready barplot from pre-aggregated plot source CSV

OPTION B ARCHITECTURE:
- Plot source CSV created by analysis pipeline (g_code step 7)
- This script ONLY reads CSV and creates visualization
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. domain_icc_barplot.png - ICC slope conditional comparison across domains

WHEN DOMAIN EXCLUSION APPLIED:
- When domain excluded due to floor effect (RQ 5.2.1)
- Only 2 domains plotted: What, Where
"""

from pathlib import Path
import sys
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.2.6/plots/)
RQ_ROOT = Path(__file__).parent.parent
PROJECT_ROOT = RQ_ROOT.parent.parent.parent

# Add project root to path to import tools
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.2.6...")
print(f"RQ root: {RQ_ROOT}")
print("\nNOTE: When domain excluded due to floor effect (per RQ 5.2.1)")
print("      Only What and Where domains plotted.\n")

# =============================================================================
# PLOT 1: DOMAIN ICC BARPLOT
# =============================================================================

print("\nGenerating Plot 1: Domain ICC Comparison Barplot...")

# Load plot source CSV (created by analysis pipeline step 7)
df_plot = pd.read_csv(RQ_ROOT / "data" / "step07_domain_icc_barplot_data.csv")
print(f"  Loaded {len(df_plot)} rows from step07_domain_icc_barplot_data.csv")
print(f"  Columns: {list(df_plot.columns)}")
print(f"  Domains: {df_plot['domain'].tolist()}")

# Define color mapping based on interpretation categories
color_map = {
    'Low': '#E74C3C',          # Red - below 0.20
    'Moderate': '#F39C12',     # Orange - 0.20-0.40
    'Substantial': '#2ECC71'   # Green - >= 0.40
}

# Get bar colors based on interpretation
bar_colors = [color_map.get(interp, '#95A5A6') for interp in df_plot['interpretation']]

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Create barplot
x_positions = np.arange(len(df_plot))
bars = ax.bar(x_positions, df_plot['icc_slope_conditional'],
              color=bar_colors, alpha=0.8, edgecolor='black', linewidth=1.5)

# Add threshold line at 0.40
threshold = df_plot['threshold_line'].iloc[0]  # Should be 0.40 for all rows
ax.axhline(y=threshold, color='black', linestyle='--', linewidth=2,
           label=f'Substantial Threshold ({threshold})', alpha=0.7)

# Formatting
ax.set_xlabel('Memory Domain', fontweight='bold', fontsize=12)
ax.set_ylabel('ICC (Slope Conditional)', fontweight='bold', fontsize=12)
ax.set_title('RQ 5.2.6: Domain-Specific Variance Decomposition\nICC Slope Conditional by Domain',
             fontweight='bold', fontsize=13, pad=15)
ax.set_xticks(x_positions)
ax.set_xticklabels(df_plot['domain'])
ax.set_ylim(0, 1.0)  # ICC bounded [0,1]
ax.grid(True, alpha=0.3, axis='y')

# Add value labels on top of bars
for i, (bar, value) in enumerate(zip(bars, df_plot['icc_slope_conditional'])):
    height = bar.get_height()
    ax.text(bar.get_x() + bar.get_width()/2., height + 0.02,
            f'{value:.3f}',
            ha='center', va='bottom', fontweight='bold', fontsize=10)

# Create custom legend
from matplotlib.patches import Patch
legend_elements = [
    Patch(facecolor=color_map['Substantial'], edgecolor='black', label='Substantial (>= 0.40)'),
    Patch(facecolor=color_map['Moderate'], edgecolor='black', label='Moderate (0.20-0.40)'),
    Patch(facecolor=color_map['Low'], edgecolor='black', label='Low (< 0.20)'),
    plt.Line2D([0], [0], color='black', linestyle='--', linewidth=2,
               label=f'Threshold ({threshold})')
]
ax.legend(handles=legend_elements, loc='upper right', framealpha=0.95, fontsize=9)

# Add interpretation note
note_text = "When domain excluded (floor effect)\nOnly What and Where analyzed"
ax.text(0.02, 0.98, note_text, transform=ax.transAxes,
        fontsize=9, verticalalignment='top', style='italic',
        bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.3))

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "domain_icc_barplot.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  âœ“ Saved: plots/domain_icc_barplot.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/domain_icc_barplot.png")
print(f"\nDomains plotted: {', '.join(df_plot['domain'].tolist())}")
print(f"ICC range: [{df_plot['icc_slope_conditional'].min():.3f}, {df_plot['icc_slope_conditional'].max():.3f}]")
print(f"Threshold: {threshold}")
print(f"Domains meeting threshold: {(df_plot['icc_slope_conditional'] >= threshold).sum()}/{len(df_plot)}")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
