#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.1.1 - Functional Form of Forgetting Trajectories

GENERATED BY: Manual regeneration (2025-12-08)
DATE: 2025-12-08
PURPOSE: Create publication-ready plots from MODEL-AVERAGED predictions

ARCHITECTURE: Multi-model inference (Burnham & Anderson, 2002)
- Plot source CSV: step07b_averaged_trajectory_data.csv (model-averaged predictions)
- This script reads observed data (400 points) + averaged predictions (100 points)
- Shows power-law functional form from weighted average of 16 competitive models

PLOTS GENERATED:
1. functional_form_theta.png - Theta-scale trajectory (model-averaged, α_eff=0.410)
2. functional_form_probability.png - Probability-scale trajectory (Decision D069)

KEY MESSAGE:
- NOT single best model (PowerLaw_04 weight=5.6%, extreme uncertainty)
- Model-averaged trajectory from 16 models within ΔAIC<2
- Effective α=0.410 (power-law functional form, Wixted & Ebbesen 1991)
- 95% CI bands from between-model variance (uncertainty quantification)
"""

from pathlib import Path
import sys
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# Add project root to path (plots.py is in results/ch5/5.1.1/plots/)
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.1.1/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("="*70)
print("RQ 5.1.1 - MODEL-AVERAGED FORGETTING TRAJECTORY")
print("="*70)
print(f"RQ root: {RQ_ROOT}")
print()
print("Multi-model inference approach:")
print("  - 16 competitive models averaged (ΔAIC < 2)")
print("  - Effective α = 0.410 (power-law functional form)")
print("  - 95% CI from between-model variance")
print()

# =============================================================================
# LOAD MODEL-AVERAGED DATA
# =============================================================================

print("Loading model-averaged trajectory data...")
print()

csv_path = RQ_ROOT / "plots" / "step07b_averaged_trajectory_data.csv"
df = pd.read_csv(csv_path)

print(f"  Loaded {len(df)} rows from step07b_averaged_trajectory_data.csv")
print(f"  Columns: {list(df.columns)}")
print()

# Separate observed data from model-averaged predictions
df_observed = df[df['data_type'] == 'observed'].copy()
df_predicted = df[df['data_type'] == 'predicted'].copy()

print(f"  Observed data points: {len(df_observed)} (100 participants × 4 tests)")
print(f"  Prediction grid points: {len(df_predicted)}")
print()

# Convert TSVR_hours to Days for interpretability
df_observed['Days'] = df_observed['TSVR_hours'] / 24.0
df_predicted['Days'] = df_predicted['TSVR_hours'] / 24.0

# =============================================================================
# PLOT 1: THETA-SCALE TRAJECTORY (MODEL-AVERAGED)
# =============================================================================

print("Generating Plot 1: Theta-scale model-averaged trajectory...")
print()

fig1, ax1 = plt.subplots(figsize=(10, 6))

# Plot observed data points (individual observations, N=400)
ax1.scatter(
    df_observed['Days'],
    df_observed['theta'],
    alpha=0.3,
    s=30,
    color='#3498DB',
    label='Observed data (N=400)',
    zorder=2
)

# Plot model-averaged prediction line
ax1.plot(
    df_predicted['Days'],
    df_predicted['theta'],
    color='#E74C3C',
    linewidth=2.5,
    label='Model-averaged prediction\n(α_eff=0.410, 16 models)',
    zorder=3
)

# Plot 95% confidence band (between-model uncertainty)
ax1.fill_between(
    df_predicted['Days'],
    df_predicted['theta_lower'],
    df_predicted['theta_upper'],
    alpha=0.2,
    color='#E74C3C',
    label='95% CI (between-model variance)',
    zorder=1
)

# Labels and formatting
ax1.set_xlabel('Days Since VR Encoding', fontsize=12, fontweight='bold')
ax1.set_ylabel('Memory Ability (Theta)', fontsize=12, fontweight='bold')
ax1.set_title(
    'RQ 5.1.1: Functional Form of Forgetting - Theta Scale\n'
    'Power-Law Trajectory from Multi-Model Inference',
    fontsize=13,
    fontweight='bold'
)
ax1.legend(loc='best', frameon=True, fontsize=10)
ax1.grid(True, alpha=0.3, linestyle='--')
ax1.spines['top'].set_visible(False)
ax1.spines['right'].set_visible(False)

# Add annotation with key findings
annotation_text = (
    'Multi-model inference:\n'
    '  • 16 competitive models (ΔAIC<2)\n'
    '  • Effective α = 0.410\n'
    '  • Power-law form (Wixted & Ebbesen, 1991)'
)
ax1.text(
    0.98, 0.02,
    annotation_text,
    transform=ax1.transAxes,
    fontsize=9,
    verticalalignment='bottom',
    horizontalalignment='right',
    bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5)
)

# Save theta-scale plot
output_path_theta = RQ_ROOT / "plots" / "functional_form_theta.png"
fig1.savefig(output_path_theta, dpi=300, bbox_inches='tight')
print(f"  [PASS] Saved: {output_path_theta}")
print()

# =============================================================================
# PLOT 2: PROBABILITY-SCALE TRAJECTORY (Decision D069)
# =============================================================================

print("Generating Plot 2: Probability-scale model-averaged trajectory (Decision D069)...")
print()

# Transform theta to probability using IRT 2PL formula
# p = 1 / (1 + exp(-1.7 * theta))
def theta_to_probability(theta):
    """Convert theta (IRT latent variable) to probability using 2PL formula."""
    return 1.0 / (1.0 + np.exp(-1.7 * theta))

# Apply transformation
df_observed['probability'] = theta_to_probability(df_observed['theta'])
df_predicted['probability'] = theta_to_probability(df_predicted['theta'])
df_predicted['probability_lower'] = theta_to_probability(df_predicted['theta_lower'])
df_predicted['probability_upper'] = theta_to_probability(df_predicted['theta_upper'])

print(f"  Theta → Probability transformation complete")
print(f"  Observed probability range: [{df_observed['probability'].min():.3f}, {df_observed['probability'].max():.3f}]")
print(f"  Predicted probability range: [{df_predicted['probability'].min():.3f}, {df_predicted['probability'].max():.3f}]")
print()

fig2, ax2 = plt.subplots(figsize=(10, 6))

# Plot observed data points
ax2.scatter(
    df_observed['Days'],
    df_observed['probability'],
    alpha=0.3,
    s=30,
    color='#3498DB',
    label='Observed data (N=400)',
    zorder=2
)

# Plot model-averaged prediction line
ax2.plot(
    df_predicted['Days'],
    df_predicted['probability'],
    color='#E74C3C',
    linewidth=2.5,
    label='Model-averaged prediction\n(α_eff=0.410, 16 models)',
    zorder=3
)

# Plot 95% confidence band
ax2.fill_between(
    df_predicted['Days'],
    df_predicted['probability_lower'],
    df_predicted['probability_upper'],
    alpha=0.2,
    color='#E74C3C',
    label='95% CI (between-model variance)',
    zorder=1
)

# Labels and formatting
ax2.set_xlabel('Days Since VR Encoding', fontsize=12, fontweight='bold')
ax2.set_ylabel('Probability Correct', fontsize=12, fontweight='bold')
ax2.set_title(
    'RQ 5.1.1: Functional Form of Forgetting - Probability Scale\n'
    'Power-Law Trajectory from Multi-Model Inference',
    fontsize=13,
    fontweight='bold'
)
ax2.legend(loc='best', frameon=True, fontsize=10)
ax2.grid(True, alpha=0.3, linestyle='--')
ax2.spines['top'].set_visible(False)
ax2.spines['right'].set_visible(False)

# Set y-axis to probability scale [0, 1]
ax2.set_ylim(-0.05, 1.05)
ax2.yaxis.set_major_formatter(plt.FuncFormatter(lambda y, _: f'{y:.1%}'))

# Add annotation
annotation_text = (
    'Multi-model inference:\n'
    '  • 16 competitive models (ΔAIC<2)\n'
    '  • Effective α = 0.410\n'
    '  • Decision D069: Dual-scale reporting'
)
ax2.text(
    0.98, 0.02,
    annotation_text,
    transform=ax2.transAxes,
    fontsize=9,
    verticalalignment='bottom',
    horizontalalignment='right',
    bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5)
)

# Save probability-scale plot
output_path_prob = RQ_ROOT / "plots" / "functional_form_probability.png"
fig2.savefig(output_path_prob, dpi=300, bbox_inches='tight')
print(f"  [PASS] Saved: {output_path_prob}")
print()

# =============================================================================
# SUMMARY
# =============================================================================

print("="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 2")
print(f"  - functional_form_theta.png")
print(f"  - functional_form_probability.png (Decision D069)")
print()
print(f"Approach: Multi-model inference (Burnham & Anderson, 2002)")
print(f"  Models averaged: 16 competitive models (ΔAIC < 2)")
print(f"  Effective α: 0.410 (power-law functional form)")
print(f"  Best single model weight: 5.6% (extreme uncertainty)")
print()
print(f"Observed data: {len(df_observed)} points (100 participants × 4 tests)")
print(f"Prediction grid: {len(df_predicted)} time points (0 to ~10 days)")
print()
print("All plots saved with 300 DPI publication quality.")
print("Decision D069 compliance: BOTH theta and probability scales generated.")
print("="*70)
