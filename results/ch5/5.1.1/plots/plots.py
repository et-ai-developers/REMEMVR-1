#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.1.1 - Functional Form of Forgetting Trajectories

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-07
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

ARCHITECTURE: Option B (plot source CSVs created by analysis pipeline)
- Plot source CSVs created by Step 7 (g_code)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. functional_form_theta.png - Theta-scale trajectory (best model: Logarithmic)
2. functional_form_probability.png - Probability-scale trajectory (Decision D069)

NOTE: Step 7 workaround due to pickle unpickling issues - only best model
predictions included in source CSVs (not all 5 candidate models).
"""

from pathlib import Path
import sys
import pandas as pd
import numpy as np

# Add project root to path (plots.py is in results/ch5/5.1.1/plots/)
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import (
    set_plot_style_defaults,
    plot_trajectory
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.1.1/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("="*70)
print("PLOTTING FOR RQ 5.1.1 - Functional Form of Forgetting Trajectories")
print("="*70)
print(f"RQ root: {RQ_ROOT}")
print()

# =============================================================================
# PLOT 1: FUNCTIONAL FORM TRAJECTORY (THETA-SCALE)
# =============================================================================

print("Generating Plot 1: Theta-scale functional form trajectory...")
print()

# Load plot source CSV (created by Step 7)
csv_path_theta = RQ_ROOT / "plots" / "step07_functional_form_theta_data.csv"
df_theta = pd.read_csv(csv_path_theta)
print(f"  Loaded {len(df_theta)} rows from step07_functional_form_theta_data.csv")
print(f"  Columns: {list(df_theta.columns)}")

# Identify best model from data
best_model = df_theta['best_model'].iloc[0]
print(f"  Best model: {best_model}")
print()

# Separate observed data (has non-NaN observed_theta) from predictions
df_observed = df_theta[df_theta['observed_theta'].notna()].copy()
df_predictions = df_theta[df_theta['pred_Log'].notna()].copy()

print(f"  Observed data points: {len(df_observed)}")
print(f"  Prediction grid points: {len(df_predictions)}")
print()

# Prepare data for plot_trajectory function
# Need to create fitted_curves dict and observed_data DataFrame

# Fitted curves: {model_name: predicted_values_array}
time_pred = df_predictions['Days'].values
fitted_curves = {
    best_model: df_predictions['pred_Log'].values
}

# Observed data: Need long format with columns [Days, theta, group]
# For single-factor RQ, group column is constant (we'll use best_model name)
observed_data = pd.DataFrame({
    'Days': df_observed['Days'].values,
    'theta': df_observed['observed_theta'].values,
    'Group': [best_model] * len(df_observed)  # Single group
})

# Generate plot
fig_theta, ax_theta = plot_trajectory(
    time_pred=time_pred,
    fitted_curves=fitted_curves,
    observed_data=observed_data,
    time_col='Days',
    value_col='theta',
    group_col='Group',
    xlabel='Days Since VR Encoding',
    ylabel='Memory Ability (Theta)',
    title='RQ 5.1.1: Functional Form of Forgetting - Theta Scale',
    colors={best_model: '#2C3E50'},  # Single dark color for best model
    figsize=(10, 6),
    output_path=RQ_ROOT / "plots" / "functional_form_theta.png",
    show_errorbar=True,
    annotation=f'Best model: {best_model} (AIC selection)'
)

print(f"  [PASS] Saved: plots/functional_form_theta.png")
print()

# =============================================================================
# PLOT 2: FUNCTIONAL FORM TRAJECTORY (PROBABILITY-SCALE) - Decision D069
# =============================================================================

print("Generating Plot 2: Probability-scale functional form trajectory (Decision D069)...")
print()

# Load plot source CSV (created by Step 7)
csv_path_prob = RQ_ROOT / "plots" / "step07_functional_form_probability_data.csv"
df_prob = pd.read_csv(csv_path_prob)
print(f"  Loaded {len(df_prob)} rows from step07_functional_form_probability_data.csv")
print(f"  Columns: {list(df_prob.columns)}")
print()

# Separate observed data from predictions
df_observed_prob = df_prob[df_prob['observed_prob'].notna()].copy()
df_predictions_prob = df_prob[df_prob['pred_Log_prob'].notna()].copy()

print(f"  Observed data points: {len(df_observed_prob)}")
print(f"  Prediction grid points: {len(df_predictions_prob)}")
print()

# Prepare data for plot_trajectory function
time_pred_prob = df_predictions_prob['Days'].values
fitted_curves_prob = {
    best_model: df_predictions_prob['pred_Log_prob'].values
}

# Observed data (probability scale)
observed_data_prob = pd.DataFrame({
    'Days': df_observed_prob['Days'].values,
    'probability': df_observed_prob['observed_prob'].values,
    'Group': [best_model] * len(df_observed_prob)
})

# Generate plot
fig_prob, ax_prob = plot_trajectory(
    time_pred=time_pred_prob,
    fitted_curves=fitted_curves_prob,
    observed_data=observed_data_prob,
    time_col='Days',
    value_col='probability',
    group_col='Group',
    xlabel='Days Since VR Encoding',
    ylabel='Probability Correct',
    title='RQ 5.1.1: Functional Form of Forgetting - Probability Scale',
    colors={best_model: '#2C3E50'},  # Same color as theta plot
    figsize=(10, 6),
    output_path=RQ_ROOT / "plots" / "functional_form_probability.png",
    show_errorbar=True,
    annotation=f'Best model: {best_model} (AIC selection)\nDecision D069: Dual-scale reporting'
)

print(f"  [PASS] Saved: plots/functional_form_probability.png")
print()

# =============================================================================
# SUMMARY
# =============================================================================

print("="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 2")
print(f"  - plots/functional_form_theta.png")
print(f"  - plots/functional_form_probability.png (Decision D069)")
print()
print(f"Best model: {best_model} (identified via AIC model selection)")
print(f"Observed data points: {len(df_observed)} test sessions")
print(f"Prediction grid: {len(df_predictions)} time points (0 to ~6 days)")
print()
print("All plots saved with 300 DPI publication quality.")
print("Decision D069 compliance: BOTH theta and probability scales generated.")
print("="*70)
