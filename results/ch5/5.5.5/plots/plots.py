#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.5.5 - Purified CTT Effects for Source-Destination Memory

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-05
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code, step08)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. correlation_comparison.png - Full vs Purified CTT correlations with IRT theta (faceted by location)
2. aic_comparison.png - AIC values across measurement types (faceted by location)
"""

from pathlib import Path
import sys
import pandas as pd
import numpy as np

# Add project root to path (plots.py is in results/ch5/5.5.5/plots/)
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import (
    set_plot_style_defaults,
    plot_comparison_bars
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.5.5/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.5.5...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: CORRELATION COMPARISON (FULL VS PURIFIED CTT)
# =============================================================================

print("\nGenerating Plot 1: Correlation comparison...")

# Load plot source CSV (created by step08)
df_corr = pd.read_csv(RQ_ROOT / "plots" / "step08_correlation_comparison_data.csv")
print(f"  Loaded {len(df_corr)} rows from step08_correlation_comparison_data.csv")
print(f"  Columns: {list(df_corr.columns)}")

# Define colors for Full vs Purified
version_colors = {
    'full': '#95A5A6',      # Gray - Full CTT
    'purified': '#E74C3C'   # Red - Purified CTT
}

# Generate plot (faceted by location_type)
fig_corr, axes_corr = plot_comparison_bars(
    df=df_corr,
    x_col='version',
    y_col='r',
    group_col=None,  # No grouping within bars
    facet_col='location_type',  # Separate panels for source/destination
    ci_lower_col='CI_lower',
    ci_upper_col='CI_upper',
    colors=version_colors,
    xlabel='CTT Version',
    ylabel='Correlation with IRT Theta',
    title=None,  # Facet titles will be auto-generated
    figsize=(12, 6),
    orientation='vertical',
    output_path=RQ_ROOT / "plots" / "correlation_comparison.png",
    bar_width=0.5,
    show_legend=False  # Not needed, x-axis labels are self-explanatory
)

print(f"  [PASS] Saved: plots/correlation_comparison.png")

# =============================================================================
# PLOT 2: AIC COMPARISON (IRT vs FULL CTT vs PURIFIED CTT)
# =============================================================================

print("\nGenerating Plot 2: AIC comparison...")

# Load plot source CSV
df_aic = pd.read_csv(RQ_ROOT / "plots" / "step08_aic_comparison_data.csv")
print(f"  Loaded {len(df_aic)} rows from step08_aic_comparison_data.csv")
print(f"  Columns: {list(df_aic.columns)}")

# Define colors for IRT vs CTT models
model_colors = {
    'IRT': '#3498DB',           # Blue - IRT
    'Full_CTT': '#95A5A6',      # Gray - Full CTT
    'Purified_CTT': '#E74C3C'   # Red - Purified CTT
}

# Generate plot (faceted by location_type)
fig_aic, axes_aic = plot_comparison_bars(
    df=df_aic,
    x_col='model',
    y_col='aic',
    group_col=None,  # No grouping within bars
    facet_col='location_type',  # Separate panels for source/destination
    colors=model_colors,
    xlabel='Measurement Type',
    ylabel='AIC (Lower = Better Fit)',
    title=None,  # Facet titles will be auto-generated
    figsize=(12, 6),
    orientation='vertical',
    output_path=RQ_ROOT / "plots" / "aic_comparison.png",
    bar_width=0.5,
    show_legend=False  # Not needed, x-axis labels are self-explanatory
)

print(f"  [PASS] Saved: plots/aic_comparison.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 2")
print(f"  - plots/correlation_comparison.png")
print(f"  - plots/aic_comparison.png")
print("\nAll plots saved with 300 DPI publication quality.")
print("\nKey Findings (from plot data):")
print(f"  Source: Purified r={df_corr.loc[df_corr['location_type']=='source', 'r'].iloc[1]:.3f} vs Full r={df_corr.loc[df_corr['location_type']=='source', 'r'].iloc[0]:.3f}")
print(f"  Destination: Purified r={df_corr.loc[df_corr['location_type']=='destination', 'r'].iloc[1]:.3f} vs Full r={df_corr.loc[df_corr['location_type']=='destination', 'r'].iloc[0]:.3f}")
print(f"  Source AIC: Purified={df_aic.loc[(df_aic['location_type']=='source') & (df_aic['model']=='Purified_CTT'), 'aic'].iloc[0]:.1f} vs Full={df_aic.loc[(df_aic['location_type']=='source') & (df_aic['model']=='Full_CTT'), 'aic'].iloc[0]:.1f}")
print(f"  Destination AIC: Purified={df_aic.loc[(df_aic['location_type']=='destination') & (df_aic['model']=='Purified_CTT'), 'aic'].iloc[0]:.1f} vs Full={df_aic.loc[(df_aic['location_type']=='destination') & (df_aic['model']=='Full_CTT'), 'aic'].iloc[0]:.1f}")
print("="*70)
