#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.1: Domain-Specific Forgetting Trajectories (What/Where/When)

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-11-22
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code, step07)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. trajectory_theta.png - Theta-scale trajectory (IRT latent variable)
2. trajectory_probability.png - Probability-scale trajectory (dual-scale trajectory plots)

DECISIONS APPLIED:
- dual-scale trajectory plots: Dual-scale trajectory plots (BOTH theta + probability MANDATORY)
- TSVR time variable: TSVR (actual hours) as time variable
"""

import sys
from pathlib import Path

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
from tools.plotting import (
    set_plot_style_defaults,
    plot_trajectory,
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/rq1/plots/)
RQ_ROOT = Path(__file__).resolve().parent.parent
PLOTS_DIR = RQ_ROOT / "plots"

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("=" * 70)
print("RQ 5.1: Domain-Specific Forgetting Trajectories - Plotting")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")
print(f"Plots directory: {PLOTS_DIR}")

# Domain color scheme (consistent across all 50 RQs)
COLORS = {
    "what": "#E74C3C",   # Red - object identity
    "where": "#3498DB",  # Blue - spatial location
    "when": "#2ECC71",   # Green - temporal order
}

# =============================================================================
# PLOT 1: TRAJECTORY (THETA-SCALE)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 1: Theta-scale trajectory...")
print("-" * 70)

# Load plot source CSV (created by step07 during analysis pipeline)
theta_csv_path = PLOTS_DIR / "step07_trajectory_theta_data.csv"
df_theta = pd.read_csv(theta_csv_path)
print(f"  Loaded {len(df_theta)} rows from {theta_csv_path.name}")
print(f"  Columns: {list(df_theta.columns)}")
print(f"  Domains: {df_theta['domain'].unique().tolist()}")
print(f"  Time points: {sorted(df_theta['time'].unique().tolist())}")

# Prepare data for plot_trajectory function
# plot_trajectory expects:
#   - time_pred: array of time values for smooth fitted curves
#   - fitted_curves: dict of {group: predicted_values}
#   - observed_data: DataFrame with time, value, group columns

# Create smooth time prediction array
time_min = df_theta['time'].min()
time_max = df_theta['time'].max()
time_pred = np.linspace(time_min, time_max, 100)

# Build fitted curves dict from model predictions
# Interpolate predictions to smooth time array
fitted_curves = {}
for domain in df_theta['domain'].unique():
    domain_data = df_theta[df_theta['domain'] == domain].sort_values('time')
    # Use model predictions interpolated to smooth time array
    fitted_curves[domain] = np.interp(
        time_pred,
        domain_data['time'].values,
        domain_data['predicted_theta'].values
    )

# Prepare observed data for errorbar overlay
# Need to reshape: columns should be 'Time', 'Value', 'Group' (or specified names)
observed_data = df_theta[['time', 'mean_theta', 'domain']].copy()

# Generate theta-scale trajectory plot
fig_theta, ax_theta = plot_trajectory(
    time_pred=time_pred,
    fitted_curves=fitted_curves,
    observed_data=observed_data,
    time_col='time',
    value_col='mean_theta',
    group_col='domain',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Memory Ability (Theta)',
    title='RQ 5.1: Domain-Specific Forgetting Trajectories - Theta Scale',
    colors=COLORS,
    figsize=(10, 6),
    output_path=PLOTS_DIR / "trajectory_theta.png",
    show_errorbar=True,
    annotation="TSVR time variable: TSVR (actual hours) as time variable"
)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_theta.png'}")

# =============================================================================
# PLOT 2: TRAJECTORY (PROBABILITY-SCALE) - dual-scale trajectory plots
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 2: Probability-scale trajectory (dual-scale trajectory plots)...")
print("-" * 70)

# Load probability-scale plot source CSV
prob_csv_path = PLOTS_DIR / "step07_trajectory_probability_data.csv"
df_prob = pd.read_csv(prob_csv_path)
print(f"  Loaded {len(df_prob)} rows from {prob_csv_path.name}")
print(f"  Columns: {list(df_prob.columns)}")

# Build fitted curves dict from probability predictions
fitted_curves_prob = {}
for domain in df_prob['domain'].unique():
    domain_data = df_prob[df_prob['domain'] == domain].sort_values('time')
    # Interpolate and convert to percentage
    fitted_curves_prob[domain] = np.interp(
        time_pred,
        domain_data['time'].values,
        domain_data['predicted_probability'].values * 100  # Convert to percentage
    )

# Prepare observed data with probability as percentage
observed_data_prob = df_prob[['time', 'mean_probability', 'domain']].copy()
observed_data_prob['mean_probability'] = observed_data_prob['mean_probability'] * 100  # Convert to percentage

# Generate probability-scale trajectory plot
fig_prob, ax_prob = plot_trajectory(
    time_pred=time_pred,
    fitted_curves=fitted_curves_prob,
    observed_data=observed_data_prob,
    time_col='time',
    value_col='mean_probability',
    group_col='domain',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Probability Correct (%)',
    title='RQ 5.1: Domain-Specific Forgetting Trajectories - Probability Scale',
    colors=COLORS,
    figsize=(10, 6),
    output_path=PLOTS_DIR / "trajectory_probability.png",
    show_errorbar=True,
    annotation="dual-scale trajectory plots: Dual-scale trajectory (interpretable for general audience)"
)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_probability.png'}")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 2")
print(f"  - {PLOTS_DIR / 'trajectory_theta.png'}")
print(f"  - {PLOTS_DIR / 'trajectory_probability.png'} (dual-scale trajectory plots)")
print("\ndual-scale trajectory plots Compliance: BOTH theta + probability scale plots generated")
print("All plots saved with 300 DPI publication quality.")
print("=" * 70)
