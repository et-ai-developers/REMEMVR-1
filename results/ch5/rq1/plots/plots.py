#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.1: Domain-Specific Forgetting Trajectories (What/Where/When)

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-11-22
PURPOSE: Create publication-ready plots from individual-level plot source CSVs

PLOT STYLE (matching legacy .archive/v1/plots.py):
- Faded scatter points in background (individual observations)
- Dashed fitted curves (LMM predictions)
- Shaded 95% CI bands (from LMM fixed effects covariance matrix)

PLOTS GENERATED:
1. trajectory_theta.png - Theta-scale trajectory (IRT latent variable)
2. trajectory_probability.png - Probability-scale trajectory (dual-scale)

DECISIONS APPLIED:
- dual-scale trajectory plots: BOTH theta + probability MANDATORY
- TSVR time variable: TSVR (actual hours) as time variable
"""

import sys
from pathlib import Path

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import patsy
import statsmodels.formula.api as smf
from tools.plotting import set_plot_style_defaults, convert_theta_to_probability

# =============================================================================
# SETUP
# =============================================================================

RQ_ROOT = Path(__file__).resolve().parent.parent
PLOTS_DIR = RQ_ROOT / "plots"
DATA_DIR = RQ_ROOT / "data"

# Apply consistent plotting theme
set_plot_style_defaults()

print("=" * 70)
print("RQ 5.1: Domain-Specific Forgetting Trajectories - Plotting")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")
print(f"Plots directory: {PLOTS_DIR}")

# Plot style constants (matching legacy)
RESIDUAL_SCATTER_POINT_ALPHA = 0.15
MEAN_CI_ALPHA = 0.2
IRT_LINE_STYLE = 'dashed'

# Domain color scheme
COLORS = {
    "what": "#3498DB",   # Blue
    "where": "#2ECC71",  # Green
    "when": "#E67E22",   # Orange
}

# =============================================================================
# LOAD DATA AND FIT LMM
# =============================================================================

print("\n" + "-" * 70)
print("Loading data and fitting LMM for CI calculation...")
print("-" * 70)

# Load LMM input data
lmm_input_path = DATA_DIR / "step04_lmm_input.csv"
df_lmm = pd.read_csv(lmm_input_path)
print(f"  Loaded {len(df_lmm)} rows from step04_lmm_input.csv")

# Prepare for LMM
df_lmm['Days'] = df_lmm['TSVR_hours'] / 24.0
df_lmm['log_Days'] = np.log(df_lmm['Days'] + 1)

# Get UID from composite_ID
if 'UID' not in df_lmm.columns:
    df_lmm['UID'] = df_lmm['composite_ID'].str.split('_').str[0]

# Fit Log model (best model from step05)
print("  Fitting LMM model...")
log_model = smf.mixedlm(
    "theta ~ log_Days * C(domain, Treatment('what'))",
    data=df_lmm,
    groups=df_lmm['UID'],
    re_formula='~log_Days'
)
lmm_results = log_model.fit(method='powell', reml=False)
print(f"  Model fitted: AIC = {lmm_results.aic:.2f}")

# Load item parameters for probability conversion
item_params_path = DATA_DIR / "step03_item_parameters.csv"
df_items = pd.read_csv(item_params_path)

# Get domain-specific IRT parameters
factor_col = 'factor' if 'factor' in df_items.columns else 'domain'
disc_col = next((c for c in ['Discrimination', 'a'] if c in df_items.columns), None)
diff_col = next((c for c in ['Difficulty_1', 'Difficulty', 'b'] if c in df_items.columns), None)

domain_params = df_items.groupby(factor_col).agg({
    disc_col: 'mean',
    diff_col: 'mean'
}).to_dict('index')

print(f"  Domain IRT parameters loaded")

# =============================================================================
# HELPER: Create prediction grid with CIs
# =============================================================================

def create_pred_grid_with_ci(lmm_results, df_long, time_range):
    """Create prediction grid with 95% CI from LMM covariance matrix."""

    domains = df_long['domain'].unique()

    pred_grid = pd.DataFrame([
        (t, d) for d in domains for t in time_range
    ], columns=['TSVR_hours', 'domain'])

    pred_grid['Days'] = pred_grid['TSVR_hours'] / 24.0
    pred_grid['log_Days'] = np.log(pred_grid['Days'] + 1)

    # Get formula RHS and create design matrix
    formula_rhs = lmm_results.model.formula.split('~')[1].strip()
    design_matrix = patsy.dmatrix(formula_rhs, pred_grid, return_type='dataframe')

    # Predict mean
    pred_grid['mean_theta'] = lmm_results.predict(pred_grid)

    # Calculate CI from fixed effects covariance
    fe_cov = lmm_results.cov_params().loc[lmm_results.fe_params.index, lmm_results.fe_params.index]
    design_matrix = design_matrix[fe_cov.columns]

    pred_var = np.sum((design_matrix @ fe_cov) * design_matrix, axis=1)
    pred_se = np.sqrt(pred_var)

    pred_grid['theta_ci_lower'] = pred_grid['mean_theta'] - 1.96 * pred_se
    pred_grid['theta_ci_upper'] = pred_grid['mean_theta'] + 1.96 * pred_se

    return pred_grid

# =============================================================================
# PLOT 1: TRAJECTORY (THETA-SCALE)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 1: Theta-scale trajectory (publication style)...")
print("-" * 70)

# Load individual-level data for scatter
theta_csv_path = PLOTS_DIR / "step07_trajectory_theta_data.csv"
df_theta = pd.read_csv(theta_csv_path)
print(f"  Loaded {len(df_theta)} individual observations")

# Create prediction grid with CI
time_range = np.linspace(df_theta['TSVR_hours'].min(), df_theta['TSVR_hours'].max(), 100)
pred_grid = create_pred_grid_with_ci(lmm_results, df_lmm, time_range)

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

domains = sorted(df_theta['domain'].unique())

for domain in domains:
    color = COLORS.get(domain, '#333333')

    # 1. Plot faded scatter points (individual observations)
    domain_data = df_theta[df_theta['domain'] == domain]
    ax.scatter(
        domain_data['TSVR_hours'],
        domain_data['theta'],
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get predictions for this domain
    domain_pred = pred_grid[pred_grid['domain'] == domain]

    # 3. Plot shaded CI band
    ax.fill_between(
        domain_pred['TSVR_hours'],
        domain_pred['theta_ci_lower'],
        domain_pred['theta_ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot dashed fitted curve
    ax.plot(
        domain_pred['TSVR_hours'],
        domain_pred['mean_theta'],
        color=color,
        linestyle=IRT_LINE_STYLE,
        linewidth=2.5,
        label=domain.capitalize()
    )

# Formatting
ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Memory Ability (Theta)', fontsize=12)
ax.set_title('RQ 5.1: Domain-Specific Forgetting Trajectories - Theta Scale', fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, df_theta['TSVR_hours'].max() + 5)

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_theta.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_theta.png'}")

# =============================================================================
# PLOT 2: TRAJECTORY (PROBABILITY-SCALE)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 2: Probability-scale trajectory (publication style)...")
print("-" * 70)

# Load probability data
prob_csv_path = PLOTS_DIR / "step07_trajectory_probability_data.csv"
df_prob = pd.read_csv(prob_csv_path)
print(f"  Loaded {len(df_prob)} individual observations")

# Convert to percentage
df_prob['probability_pct'] = df_prob['probability'] * 100

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

for domain in domains:
    color = COLORS.get(domain, '#333333')

    # Get domain-specific IRT parameters
    domain_irt = domain_params.get(domain, {disc_col: 1.0, diff_col: 0.0})
    avg_a = domain_irt[disc_col]
    avg_b = domain_irt[diff_col]

    # 1. Plot faded scatter points (individual probabilities)
    domain_data = df_prob[df_prob['domain'] == domain]
    ax.scatter(
        domain_data['TSVR_hours'],
        domain_data['probability_pct'],
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get theta predictions and convert to probability
    domain_pred = pred_grid[pred_grid['domain'] == domain].copy()

    # Convert theta CI to probability
    domain_pred['prob_mean'] = convert_theta_to_probability(
        domain_pred['mean_theta'].values, discrimination=avg_a, difficulty=avg_b
    ) * 100
    domain_pred['prob_ci_lower'] = convert_theta_to_probability(
        domain_pred['theta_ci_lower'].values, discrimination=avg_a, difficulty=avg_b
    ) * 100
    domain_pred['prob_ci_upper'] = convert_theta_to_probability(
        domain_pred['theta_ci_upper'].values, discrimination=avg_a, difficulty=avg_b
    ) * 100

    # 3. Plot shaded CI band
    ax.fill_between(
        domain_pred['TSVR_hours'],
        domain_pred['prob_ci_lower'],
        domain_pred['prob_ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot dashed fitted curve
    ax.plot(
        domain_pred['TSVR_hours'],
        domain_pred['prob_mean'],
        color=color,
        linestyle=IRT_LINE_STYLE,
        linewidth=2.5,
        label=domain.capitalize()
    )

# Formatting
ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Probability Correct (%)', fontsize=12)
ax.set_title('RQ 5.1: Domain-Specific Forgetting Trajectories - Probability Scale', fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, df_prob['TSVR_hours'].max() + 5)
ax.set_ylim(0, 100)

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_probability.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_probability.png'}")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 2")
print(f"  - {PLOTS_DIR / 'trajectory_theta.png'}")
print(f"  - {PLOTS_DIR / 'trajectory_probability.png'}")
print("\nPlot style (matching legacy):")
print("  - Faded scatter points (individual observations)")
print("  - Dashed fitted curves (LMM predictions)")
print("  - Shaded 95% CI bands (from LMM covariance matrix)")
print("\nDual-scale compliance: BOTH theta + probability scale plots generated")
print("All plots saved with 300 DPI publication quality.")
print("=" * 70)
