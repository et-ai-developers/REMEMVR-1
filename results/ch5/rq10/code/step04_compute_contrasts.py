#!/usr/bin/env python3
# =============================================================================
# SCRIPT METADATA (Generated by g_code)
# =============================================================================
"""
Step ID: step04
Step Name: step04_compute_contrasts
RQ: results/ch5/rq10
Generated: 2025-11-28

PURPOSE:
Quantify age effect on forgetting rate for each domain, test pairwise differences

EXPECTED INPUTS:
  - results/step02_lmm_model.pkl
    Description: Selected LMM model from Step 2c (REML=False)
    Expected: statsmodels MixedLMResults object

  - data/step02_fixed_effects.csv
    Columns: ['term', 'estimate', 'se', 'z', 'p', 'CI_lower', 'CI_upper']
    Format: Fixed effects from selected model
    Expected rows: ~20 (including 3-way interactions)

EXPECTED OUTPUTS:
  - data/step04_age_effects_by_domain.csv
    Columns: ['domain', 'age_effect', 'se', 'z', 'p', 'CI_lower', 'CI_upper']
    Format: Domain-specific age effects on forgetting rate
    Expected rows: 3 (What, Where, When)

  - data/step04_post_hoc_contrasts.csv
    Columns: ['contrast', 'estimate', 'se', 'z', 'p_uncorrected', 'p_tukey', 'CI_lower', 'CI_upper']
    Format: Pairwise domain comparisons with dual p-values per Decision D068
    Expected rows: 3 (Where-What, When-What, Where-When)

  - results/step04_summary.txt
    Format: Text summary of age effects and contrasts with interpretation
    Expected: Statistical summary report

VALIDATION CRITERIA:
  - All 3 pairwise comparisons present
  - p_uncorrected column present (Decision D068)
  - p_tukey column present (Decision D068)
  - All p-values in [0, 1] range

g_code REASONING:
- Approach: Use compute_contrasts_pairwise tool to extract domain-specific age effects
  and pairwise contrasts with Tukey HSD correction
- Why this approach: Quantifies how age effects on forgetting differ across memory domains
  (What, Where, When). Uses Tukey HSD for multiple comparison correction while reporting
  both uncorrected and corrected p-values per Decision D068 (dual p-value reporting).
- Data flow: LMM model -> extract domain-specific slopes -> compute pairwise differences
  -> apply Tukey correction -> report dual p-values
- Expected performance: ~seconds (post-hoc contrast computation on fitted model)

IMPLEMENTATION NOTES:
- Analysis tool: compute_contrasts_pairwise from tools.analysis_lmm
- Validation tool: validate_contrasts_dual_pvalues from tools.validation
- Parameters: comparisons=["Where-What", "When-What", "Where-When"], family_alpha=0.05
- Decision D068: Dual p-value reporting (uncorrected + Tukey HSD) enforced by validation
"""
# =============================================================================

import sys
from pathlib import Path
import pandas as pd
import pickle
import traceback
from typing import Dict, List, Any

# Add project root to path for imports
# CRITICAL: RQ scripts are in results/chX/rqY/code/ (4 levels deep from project root)
# Path hierarchy from script location:
#   parents[0] = code/ (immediate parent)
#   parents[1] = rqY/
#   parents[2] = chX/
#   parents[3] = results/
#   parents[4] = REMEMVR/ (project root - THIS is what we need for imports)
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

# Import analysis tool
from tools.analysis_lmm import compute_contrasts_pairwise

# Import validation tool
from tools.validation import validate_contrasts_dual_pvalues

# =============================================================================
# Configuration
# =============================================================================

RQ_DIR = Path(__file__).resolve().parents[1]  # results/chX/rqY (derived from script location)
LOG_FILE = RQ_DIR / "logs" / "step04_compute_contrasts.log"

# =============================================================================
# FOLDER CONVENTIONS (MANDATORY - NO EXCEPTIONS)
# =============================================================================
#
# code/   : ONLY .py scripts (generated by g_code)
# data/   : ALL data outputs (.csv, .pkl, .txt) - ANY file produced by code
# logs/   : ONLY .log files - execution logs
# plots/  : ONLY image files (.png, .pdf, .svg) - actual plot images
# results/: ONLY final summary reports (.md, .html, .txt)
# docs/   : RQ documentation (concept, plan, analysis specs)
#
# NAMING CONVENTION (MANDATORY):
# ALL files in data/ and logs/ MUST be prefixed with step number:
#   - stepXX_descriptive_name.csv
#   - stepXX_descriptive_name.pkl
#   - stepXX_descriptive_name.log
#
# Examples:
#   CORRECT: data/step05_lmm_model_comparison.csv
#   CORRECT: data/step03_theta_scores.csv
#   WRONG:   results/lmm_model_comparison.csv  (wrong folder + no prefix)
#   WRONG:   data/theta_scores.csv             (missing step prefix)
#   WRONG:   logs/step02_removed_items.csv     (CSV in logs folder)

# =============================================================================
# Logging Function
# =============================================================================

def log(msg):
    """Write to both log file and console."""
    with open(LOG_FILE, 'a', encoding='utf-8') as f:
        f.write(f"{msg}\n")
    print(msg)

# =============================================================================
# Main Analysis
# =============================================================================

if __name__ == "__main__":
    try:
        log("[START] Step 04: Compute Domain-Specific Age Effects and Post-Hoc Contrasts")

        # =========================================================================
        # STEP 1: Load Input Data
        # =========================================================================
        # Expected: Fitted LMM model from step02c (selected via LRT)
        # Purpose: Extract domain-specific age effects on forgetting rate

        log("[LOAD] Loading LMM model from Step 2c...")
        lmm_model_path = RQ_DIR / "results" / "step02_lmm_model.pkl"

        # Load statsmodels MixedLMResults using MixedLMResults.load() method
        # CRITICAL: Use .load() method, NOT pickle.load() (prevents patsy/eval errors)
        from statsmodels.regression.mixed_linear_model import MixedLMResults
        lmm_model = MixedLMResults.load(str(lmm_model_path))
        log(f"[LOADED] LMM model from {lmm_model_path.name}")

        # Log model info
        n_groups = len(lmm_model.model.group_labels)
        log(f"[INFO] Model has {n_groups} groups (participants)")
        log(f"[INFO] Model converged: {lmm_model.converged}")

        # Load fixed effects table for reference (not used by tool but good for logging)
        log("[LOAD] Loading fixed effects table from Step 2c...")
        fixed_effects_path = RQ_DIR / "data" / "step02_fixed_effects.csv"
        fixed_effects = pd.read_csv(fixed_effects_path, encoding='utf-8')
        log(f"[LOADED] {fixed_effects_path.name} ({len(fixed_effects)} terms)")

        # =========================================================================
        # STEP 2: Run Analysis Tool
        # =========================================================================
        # Tool: compute_contrasts_pairwise
        # What it does: Computes domain-specific age effects on forgetting rate
        #   and pairwise contrasts with Tukey HSD correction
        # Expected output: DataFrame with contrast estimates and dual p-values

        log("[ANALYSIS] Running compute_contrasts_pairwise...")
        log("[ANALYSIS] Computing pairwise contrasts: Where-What, When-What, Where-When")
        log("[ANALYSIS] Applying Tukey HSD correction with family_alpha=0.05")

        # Define pairwise comparisons (domain differences in age effects)
        comparisons = ["Where-What", "When-What", "Where-When"]

        # Compute contrasts
        # Returns DataFrame with columns: contrast, estimate, se, z, p_uncorrected, p_tukey, CI_lower, CI_upper
        contrasts = compute_contrasts_pairwise(
            lmm_result=lmm_model,
            comparisons=comparisons,
            family_alpha=0.05  # Alpha for Tukey HSD family-wise error rate
        )

        log("[DONE] Contrast computation complete")
        log(f"[INFO] Computed {len(contrasts)} pairwise contrasts")

        # =========================================================================
        # STEP 3: Save Analysis Outputs
        # =========================================================================
        # These outputs will be used by: Step 5 (visualization preparation)

        # NOTE: compute_contrasts_pairwise returns ONLY the contrasts DataFrame
        # Domain-specific age effects are extracted internally and saved separately
        # We need to compute them manually for the age_effects_by_domain.csv output

        log("[EXTRACT] Extracting domain-specific age effects...")

        # Extract age effect terms from fixed effects
        # Age effect on forgetting is captured by TSVR_hours:Age_c and log_TSVR:Age_c terms
        # For each domain:
        #   What (reference): Age_c coef
        #   Where: Age_c coef + Age_c:domain[Where] coef
        #   When: Age_c coef + Age_c:domain[When] coef

        # Get fixed effects coefficients
        fe_params = lmm_model.fe_params
        fe_bse = lmm_model.bse_fe

        # Build age effects table
        age_effects_rows = []

        # Domain What (reference level)
        what_coef = fe_params.get('TSVR_hours:Age_c', 0.0)
        what_se = fe_bse.get('TSVR_hours:Age_c', 0.0)
        what_z = what_coef / what_se if what_se > 0 else 0.0

        # Use scipy for p-value (two-tailed z-test)
        from scipy.stats import norm
        what_p = 2 * (1 - norm.cdf(abs(what_z)))
        what_ci_lower = what_coef - 1.96 * what_se
        what_ci_upper = what_coef + 1.96 * what_se

        age_effects_rows.append({
            'domain': 'What',
            'age_effect': what_coef,
            'se': what_se,
            'z': what_z,
            'p': what_p,
            'CI_lower': what_ci_lower,
            'CI_upper': what_ci_upper
        })

        # Domain Where (reference + interaction)
        where_interaction = fe_params.get('TSVR_hours:Age_c:domain[Where]', 0.0)
        where_coef = what_coef + where_interaction

        # SE for linear combination (approximate - assumes independence)
        where_interaction_se = fe_bse.get('TSVR_hours:Age_c:domain[Where]', 0.0)
        where_se = (what_se**2 + where_interaction_se**2)**0.5
        where_z = where_coef / where_se if where_se > 0 else 0.0
        where_p = 2 * (1 - norm.cdf(abs(where_z)))
        where_ci_lower = where_coef - 1.96 * where_se
        where_ci_upper = where_coef + 1.96 * where_se

        age_effects_rows.append({
            'domain': 'Where',
            'age_effect': where_coef,
            'se': where_se,
            'z': where_z,
            'p': where_p,
            'CI_lower': where_ci_lower,
            'CI_upper': where_ci_upper
        })

        # Domain When (reference + interaction)
        when_interaction = fe_params.get('TSVR_hours:Age_c:domain[When]', 0.0)
        when_coef = what_coef + when_interaction

        when_interaction_se = fe_bse.get('TSVR_hours:Age_c:domain[When]', 0.0)
        when_se = (what_se**2 + when_interaction_se**2)**0.5
        when_z = when_coef / when_se if when_se > 0 else 0.0
        when_p = 2 * (1 - norm.cdf(abs(when_z)))
        when_ci_lower = when_coef - 1.96 * when_se
        when_ci_upper = when_coef + 1.96 * when_se

        age_effects_rows.append({
            'domain': 'When',
            'age_effect': when_coef,
            'se': when_se,
            'z': when_z,
            'p': when_p,
            'CI_lower': when_ci_lower,
            'CI_upper': when_ci_upper
        })

        age_effects = pd.DataFrame(age_effects_rows)
        log(f"[EXTRACTED] {len(age_effects)} domain-specific age effects")

        # Save age effects by domain
        log("[SAVE] Saving data/step04_age_effects_by_domain.csv...")
        age_effects_path = RQ_DIR / "data" / "step04_age_effects_by_domain.csv"
        age_effects.to_csv(age_effects_path, index=False, encoding='utf-8')
        log(f"[SAVED] {age_effects_path.name} ({len(age_effects)} rows, {len(age_effects.columns)} cols)")

        # Save post-hoc contrasts per spec (data/ folder per folder conventions)
        # Spec: data/step04_post_hoc_contrasts.csv (CSV files go in data/ folder)
        log("[SAVE] Saving data/step04_post_hoc_contrasts.csv...")
        contrasts_path = RQ_DIR / "data" / "step04_post_hoc_contrasts.csv"
        contrasts.to_csv(contrasts_path, index=False, encoding='utf-8')
        log(f"[SAVED] {contrasts_path.name} ({len(contrasts)} rows, {len(contrasts.columns)} cols)")

        # Create summary text report
        log("[SAVE] Creating results/step04_summary.txt...")
        summary_path = RQ_DIR / "results" / "step04_summary.txt"

        with open(summary_path, 'w', encoding='utf-8') as f:
            f.write("=" * 80 + "\n")
            f.write("STEP 04: DOMAIN-SPECIFIC AGE EFFECTS AND POST-HOC CONTRASTS\n")
            f.write("=" * 80 + "\n\n")

            f.write("DOMAIN-SPECIFIC AGE EFFECTS ON FORGETTING RATE\n")
            f.write("-" * 80 + "\n")
            f.write("Age effect represents the change in forgetting rate (theta per hour)\n")
            f.write("per 1-year increase in age, computed separately for each domain.\n\n")

            for _, row in age_effects.iterrows():
                f.write(f"\n{row['domain']} Domain:\n")
                f.write(f"  Age Effect: {row['age_effect']:.6f} (SE = {row['se']:.6f})\n")
                f.write(f"  z = {row['z']:.3f}, p = {row['p']:.6f}\n")
                f.write(f"  95% CI: [{row['CI_lower']:.6f}, {row['CI_upper']:.6f}]\n")

            f.write("\n\n")
            f.write("PAIRWISE CONTRASTS (POST-HOC COMPARISONS)\n")
            f.write("-" * 80 + "\n")
            f.write("Decision D068: Dual p-value reporting (uncorrected + Tukey HSD)\n")
            f.write("Tukey HSD family-wise alpha = 0.05\n\n")

            for _, row in contrasts.iterrows():
                f.write(f"\n{row['contrast']}:\n")
                f.write(f"  Difference: {row['estimate']:.6f} (SE = {row['se']:.6f})\n")
                f.write(f"  z = {row['z']:.3f}\n")
                f.write(f"  p_uncorrected = {row['p_uncorrected']:.6f}\n")
                f.write(f"  p_tukey = {row['p_tukey']:.6f}\n")
                f.write(f"  95% CI: [{row['CI_lower']:.6f}, {row['CI_upper']:.6f}]\n")

            f.write("\n\n")
            f.write("INTERPRETATION GUIDE\n")
            f.write("-" * 80 + "\n")
            f.write("Positive age effect: Older adults show steeper forgetting (faster decline)\n")
            f.write("Negative age effect: Older adults show shallower forgetting (slower decline)\n")
            f.write("Positive contrast: First domain shows greater age effect than second\n")
            f.write("Negative contrast: First domain shows smaller age effect than second\n")
            f.write("\n")
            f.write("Decision D068: Report BOTH p-values:\n")
            f.write("  - p_uncorrected: Individual comparison significance (exploratory)\n")
            f.write("  - p_tukey: Tukey HSD corrected (family-wise error control)\n")
            f.write("\n")

        log(f"[SAVED] {summary_path.name}")

        # =========================================================================
        # STEP 4: Run Validation Tool
        # =========================================================================
        # Tool: validate_contrasts_dual_pvalues
        # Validates: All pairwise comparisons present with dual p-values (D068)
        # Threshold: All p-values in [0, 1] range

        log("[VALIDATION] Running validate_contrasts_dual_pvalues...")
        log("[VALIDATION] Checking Decision D068 compliance (dual p-value reporting)...")

        validation_result = validate_contrasts_dual_pvalues(
            contrasts_df=contrasts,
            required_comparisons=["Where-What", "When-What", "Where-When"]
        )

        # Report validation results
        # Expected: Dict with keys: valid, d068_compliant, missing_comparisons, message
        if isinstance(validation_result, dict):
            log(f"[VALIDATION] valid: {validation_result.get('valid', False)}")
            log(f"[VALIDATION] d068_compliant: {validation_result.get('d068_compliant', False)}")

            missing = validation_result.get('missing_comparisons', [])
            if missing:
                log(f"[VALIDATION] missing_comparisons: {missing}")

            log(f"[VALIDATION] {validation_result.get('message', 'No message')}")

            # Raise error if validation failed
            if not validation_result.get('valid', False):
                raise ValueError(f"Validation failed: {validation_result.get('message', 'Unknown error')}")
        else:
            log(f"[VALIDATION] {validation_result}")

        log("[SUCCESS] Step 04 complete")
        sys.exit(0)

    except Exception as e:
        log(f"[ERROR] {str(e)}")
        log("[TRACEBACK] Full error details:")
        with open(LOG_FILE, 'a', encoding='utf-8') as f:
            traceback.print_exc(file=f)
        traceback.print_exc()
        sys.exit(1)
