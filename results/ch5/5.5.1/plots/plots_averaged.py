#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.5.1 - Source-Destination Spatial Memory Trajectories
UPDATED: Model-Averaged Predictions

GENERATED BY: Extended model selection (13-model averaging)
DATE: 2025-12-08
PURPOSE: Create publication-ready plots using model-averaged trajectories

DIFFERENCE FROM ORIGINAL:
- Uses step05c_averaged_predictions.csv (13-model average) instead of single Log model
- Uncertainty bands reflect model selection uncertainty + parameter uncertainty
- Addresses extreme model uncertainty (best weight=6.7%)

PLOTS GENERATED:
1. trajectory_theta.png - Theta-scale trajectory (source vs destination, model-averaged)
2. trajectory_probability.png - Probability-scale trajectory (Decision D069, model-averaged)
"""

import sys
from pathlib import Path

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from tools.plotting import set_plot_style_defaults, convert_theta_to_probability

# =============================================================================
# SETUP
# =============================================================================

RQ_ROOT = Path(__file__).resolve().parent.parent
PLOTS_DIR = RQ_ROOT / "plots"
DATA_DIR = RQ_ROOT / "data"

# Apply consistent plotting theme
set_plot_style_defaults()

print("=" * 70)
print("RQ 5.5.1: Source-Destination Trajectories - MODEL-AVERAGED Plotting")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")
print(f"Plots directory: {PLOTS_DIR}")
print("\n⚠️  MODEL AVERAGING APPLIED:")
print("  13 competitive models (ΔAIC < 2.0)")
print("  Best single model weight: 6.7% (extreme uncertainty)")
print("  Effective N models: 12.32")

# Plot style constants (matching 5.2.1)
RESIDUAL_SCATTER_POINT_ALPHA = 0.15
MEAN_CI_ALPHA = 0.2
IRT_LINE_STYLE = 'dashed'

# Location type color scheme
COLORS = {
    "source": "#3498DB",       # Blue - pick-up location
    "destination": "#E74C3C"   # Red - put-down location
}

# =============================================================================
# LOAD DATA
# =============================================================================

print("\n" + "-" * 70)
print("Loading data...")
print("-" * 70)

# Load model-averaged predictions
averaged_preds_path = DATA_DIR / "step05c_averaged_predictions.csv"
df_avg = pd.read_csv(averaged_preds_path)
print(f"  Loaded {len(df_avg)} model-averaged predictions")
print(f"  Location types: {sorted(df_avg['LocationType'].unique())}")

# Load individual-level data for scatter
df_indiv = pd.read_csv(DATA_DIR / "step07_individual_trajectories.csv")
df_indiv['Hours'] = df_indiv['Days'] * 24.0
print(f"  Loaded {len(df_indiv)} individual observations")

# Load item parameters for probability conversion
item_params_path = DATA_DIR / "step03_item_parameters.csv"
df_items = pd.read_csv(item_params_path)

# Get FACTOR-SPECIFIC item parameters for probability transformation
source_items = df_items[df_items['factor'] == 'source']
dest_items = df_items[df_items['factor'] == 'destination']

FACTOR_PARAMS = {
    'source': {
        'discrimination': source_items['a'].mean(),
        'difficulty': source_items['b'].mean()
    },
    'destination': {
        'discrimination': dest_items['a'].mean(),
        'difficulty': dest_items['b'].mean()
    }
}

print(f"  Factor-specific item parameters:")
print(f"    Source:      a={FACTOR_PARAMS['source']['discrimination']:.3f}, b={FACTOR_PARAMS['source']['difficulty']:.3f}")
print(f"    Destination: a={FACTOR_PARAMS['destination']['discrimination']:.3f}, b={FACTOR_PARAMS['destination']['difficulty']:.3f}")

# =============================================================================
# PLOT 1: TRAJECTORY (THETA-SCALE) - MODEL-AVERAGED
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 1: Theta-scale trajectory (model-averaged)...")
print("-" * 70)

# Convert TSVR_hours to hours for consistency with individual data
df_avg['Hours'] = df_avg['TSVR_hours']

# Calculate 95% CI from prediction variance
df_avg['theta_ci_lower'] = df_avg['theta_averaged'] - 1.96 * df_avg['prediction_se']
df_avg['theta_ci_upper'] = df_avg['theta_averaged'] + 1.96 * df_avg['prediction_se']

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

location_types = sorted(df_avg['LocationType'].unique())

for loc_type in location_types:
    color = COLORS.get(loc_type, '#333333')

    # 1. Plot faded scatter points (individual observations)
    loc_data_indiv = df_indiv[df_indiv['LocationType'] == loc_type]
    ax.scatter(
        loc_data_indiv['Hours'],
        loc_data_indiv['theta'],
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get model-averaged predictions for this location type
    loc_avg = df_avg[df_avg['LocationType'] == loc_type].sort_values('Hours')

    # 3. Plot shaded CI band (reflects model + parameter uncertainty)
    ax.fill_between(
        loc_avg['Hours'],
        loc_avg['theta_ci_lower'],
        loc_avg['theta_ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot dashed fitted curve (model-averaged trajectory)
    ax.plot(
        loc_avg['Hours'],
        loc_avg['theta_averaged'],
        color=color,
        linestyle=IRT_LINE_STYLE,
        linewidth=2.5,
        label=loc_type.capitalize()
    )

# Formatting
ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Memory Ability (Theta)', fontsize=12)
ax.set_title('RQ 5.5.1: Source vs Destination Memory (Model-Averaged, N=13 models)', fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, df_avg['Hours'].max() + 5)

# Add annotation about model averaging
ax.annotate('13-model averaging (weight=6.7% best)', xy=(0.02, 0.98), xycoords='axes fraction',
            fontsize=8, color='gray', style='italic', va='top')

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_theta.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_theta.png'}")
print(f"  Theta ranges (model-averaged):")
for loc_type in location_types:
    loc_avg = df_avg[df_avg['LocationType'] == loc_type]
    print(f"    {loc_type}: θ ∈ [{loc_avg['theta_averaged'].min():.3f}, {loc_avg['theta_averaged'].max():.3f}]")
    print(f"             SE ∈ [{loc_avg['prediction_se'].min():.4f}, {loc_avg['prediction_se'].max():.4f}]")

# =============================================================================
# PLOT 2: TRAJECTORY (PROBABILITY-SCALE) - Decision D069
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 2: Probability-scale trajectory (Decision D069, model-averaged)...")
print("-" * 70)

# Transform individual observations to probability USING FACTOR-SPECIFIC PARAMETERS
df_indiv_prob = df_indiv.copy()
df_indiv_prob['probability'] = np.nan

for loc_type in df_indiv_prob['LocationType'].unique():
    mask = df_indiv_prob['LocationType'] == loc_type
    params = FACTOR_PARAMS[loc_type]
    df_indiv_prob.loc[mask, 'probability'] = convert_theta_to_probability(
        df_indiv_prob.loc[mask, 'theta'].values,
        discrimination=params['discrimination'],
        difficulty=params['difficulty']
    ) * 100  # Convert to percentage

# Transform model-averaged predictions to probability USING FACTOR-SPECIFIC PARAMETERS
df_avg_prob = df_avg.copy()
df_avg_prob['mean_prob'] = np.nan
df_avg_prob['prob_ci_lower'] = np.nan
df_avg_prob['prob_ci_upper'] = np.nan

for loc_type in df_avg_prob['LocationType'].unique():
    mask = df_avg_prob['LocationType'] == loc_type
    params = FACTOR_PARAMS[loc_type]

    df_avg_prob.loc[mask, 'mean_prob'] = convert_theta_to_probability(
        df_avg_prob.loc[mask, 'theta_averaged'].values,
        discrimination=params['discrimination'],
        difficulty=params['difficulty']
    ) * 100

    df_avg_prob.loc[mask, 'prob_ci_lower'] = convert_theta_to_probability(
        df_avg_prob.loc[mask, 'theta_ci_lower'].values,
        discrimination=params['discrimination'],
        difficulty=params['difficulty']
    ) * 100

    df_avg_prob.loc[mask, 'prob_ci_upper'] = convert_theta_to_probability(
        df_avg_prob.loc[mask, 'theta_ci_upper'].values,
        discrimination=params['discrimination'],
        difficulty=params['difficulty']
    ) * 100

print(f"  Probability ranges (factor-specific, model-averaged):")
for loc_type in location_types:
    loc_pred = df_avg_prob[df_avg_prob['LocationType'] == loc_type]
    print(f"    {loc_type}: {loc_pred['mean_prob'].min():.1f}% - {loc_pred['mean_prob'].max():.1f}%")

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

for loc_type in location_types:
    color = COLORS.get(loc_type, '#333333')

    # 1. Plot faded scatter points (individual observations)
    loc_data = df_indiv_prob[df_indiv_prob['LocationType'] == loc_type]
    ax.scatter(
        loc_data['Hours'],
        loc_data['probability'],
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get model-averaged predictions for this location type
    loc_pred = df_avg_prob[df_avg_prob['LocationType'] == loc_type].sort_values('Hours')

    # 3. Plot shaded CI band (reflects model + parameter uncertainty)
    ax.fill_between(
        loc_pred['Hours'],
        loc_pred['prob_ci_lower'],
        loc_pred['prob_ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot dashed fitted curve (model-averaged trajectory)
    ax.plot(
        loc_pred['Hours'],
        loc_pred['mean_prob'],
        color=color,
        linestyle=IRT_LINE_STYLE,
        linewidth=2.5,
        label=loc_type.capitalize()
    )

# Formatting
ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Probability Correct (%)', fontsize=12)
ax.set_title('RQ 5.5.1: Source vs Destination Memory (Model-Averaged, N=13 models)', fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, df_avg['Hours'].max() + 5)
ax.set_ylim(0, 100)

# Add D069 + model averaging annotation
ax.annotate('Decision D069: Dual-scale | 13-model average', xy=(0.02, 0.02), xycoords='axes fraction',
            fontsize=8, color='gray', style='italic')

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_probability.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_probability.png'}")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("MODEL-AVERAGED PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 2 (OVERWRITING original Log-model plots)")
print(f"  - trajectory_theta.png (13-model average + individual scatter + CI)")
print(f"  - trajectory_probability.png (Decision D069, 13-model average)")
print(f"\nModel Selection:")
print(f"  Basic 5 models: Log wins (63.5% weight)")
print(f"  Extended 66 models: Quadratic wins (6.7% weight) - EXTREME UNCERTAINTY")
print(f"  Solution: 13-model averaging (ΔAIC<2, cumulative 54.3%)")
print(f"  Effective N models: 12.32 (high diversity)")
print(f"\nUncertainty Bands:")
print(f"  CI reflects: Model selection uncertainty + parameter uncertainty")
print(f"  Wider than single-model CI (accounts for functional form ambiguity)")
print(f"\nProbability conversion: FACTOR-SPECIFIC parameters (unchanged)")
print(f"  Source:      a={FACTOR_PARAMS['source']['discrimination']:.3f}, b={FACTOR_PARAMS['source']['difficulty']:.3f}")
print(f"  Destination: a={FACTOR_PARAMS['destination']['discrimination']:.3f}, b={FACTOR_PARAMS['destination']['difficulty']:.3f}")
print("=" * 70)
