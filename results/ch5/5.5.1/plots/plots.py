#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.5.1 - Source-Destination Spatial Memory Trajectories

GENERATED BY: rq_plots agent (v4.0.0) - MANUALLY FIXED
DATE: 2025-12-04
PURPOSE: Create publication-ready plots matching 5.2.1 style

PLOT STYLE (matching 5.2.1):
- Faded scatter points in background (individual observations)
- Dashed fitted curves (LMM predictions)
- Shaded 95% CI bands (from LMM fixed effects covariance matrix)

PLOTS GENERATED:
1. trajectory_theta.png - Theta-scale trajectory (source vs destination)
2. trajectory_probability.png - Probability-scale trajectory (Decision D069)
"""

import sys
from pathlib import Path

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import patsy
import statsmodels.formula.api as smf
from tools.plotting import set_plot_style_defaults, convert_theta_to_probability

# =============================================================================
# SETUP
# =============================================================================

RQ_ROOT = Path(__file__).resolve().parent.parent
PLOTS_DIR = RQ_ROOT / "plots"
DATA_DIR = RQ_ROOT / "data"

# Apply consistent plotting theme
set_plot_style_defaults()

print("=" * 70)
print("RQ 5.5.1: Source-Destination Trajectories - Plotting")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")
print(f"Plots directory: {PLOTS_DIR}")

# Plot style constants (matching 5.2.1)
RESIDUAL_SCATTER_POINT_ALPHA = 0.15
MEAN_CI_ALPHA = 0.2
IRT_LINE_STYLE = 'dashed'

# Location type color scheme
COLORS = {
    "source": "#3498DB",       # Blue - pick-up location
    "destination": "#E74C3C"   # Red - put-down location
}

# =============================================================================
# LOAD DATA AND FIT LMM
# =============================================================================

print("\n" + "-" * 70)
print("Loading data and fitting LMM for CI calculation...")
print("-" * 70)

# Load LMM input data
lmm_input_path = DATA_DIR / "step04_lmm_input.csv"
df_lmm = pd.read_csv(lmm_input_path)
print(f"  Loaded {len(df_lmm)} rows from step04_lmm_input.csv")

# Prepare for LMM - use Days directly (already calculated in step04)
if 'log_Days_plus1' not in df_lmm.columns:
    df_lmm['log_Days_plus1'] = np.log(df_lmm['Days'] + 1)

# Convert TSVR_hours to hours for x-axis
df_lmm['Hours'] = df_lmm['TSVR_hours']

# Fit Log model (best model from step05)
print("  Fitting LMM model...")
log_model = smf.mixedlm(
    "theta ~ log_Days_plus1 * LocationType",
    data=df_lmm,
    groups=df_lmm['UID'],
    re_formula='~log_Days_plus1'
)
lmm_results = log_model.fit(method='powell', reml=False)
print(f"  Model fitted: AIC = {lmm_results.aic:.2f}")

# Load item parameters for probability conversion
item_params_path = DATA_DIR / "step03_item_parameters.csv"
df_items = pd.read_csv(item_params_path)

# Get mean discrimination for probability transformation
mean_discrimination = df_items['a'].mean()
print(f"  Mean item discrimination: {mean_discrimination:.3f}")

# =============================================================================
# HELPER: Create prediction grid with CIs
# =============================================================================

def create_pred_grid_with_ci(lmm_results, df_long, time_range):
    """Create prediction grid with 95% CI from LMM covariance matrix."""

    location_types = df_long['LocationType'].unique()

    pred_grid = pd.DataFrame([
        (t, loc) for loc in location_types for t in time_range
    ], columns=['Hours', 'LocationType'])

    pred_grid['Days'] = pred_grid['Hours'] / 24.0
    pred_grid['log_Days_plus1'] = np.log(pred_grid['Days'] + 1)

    # Get formula RHS and create design matrix
    formula_rhs = lmm_results.model.formula.split('~')[1].strip()
    design_matrix = patsy.dmatrix(formula_rhs, pred_grid, return_type='dataframe')

    # Predict mean
    pred_grid['mean_theta'] = lmm_results.predict(pred_grid)

    # Calculate CI from fixed effects covariance
    fe_cov = lmm_results.cov_params().loc[lmm_results.fe_params.index, lmm_results.fe_params.index]
    design_matrix = design_matrix[fe_cov.columns]

    pred_var = np.sum((design_matrix @ fe_cov) * design_matrix, axis=1)
    pred_se = np.sqrt(pred_var)

    pred_grid['theta_ci_lower'] = pred_grid['mean_theta'] - 1.96 * pred_se
    pred_grid['theta_ci_upper'] = pred_grid['mean_theta'] + 1.96 * pred_se

    return pred_grid

# =============================================================================
# PLOT 1: TRAJECTORY (THETA-SCALE)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 1: Theta-scale trajectory (publication style)...")
print("-" * 70)

# Load individual-level data for scatter
df_indiv = pd.read_csv(DATA_DIR / "step07_individual_trajectories.csv")
df_indiv['Hours'] = df_indiv['Days'] * 24.0
print(f"  Loaded {len(df_indiv)} individual observations")

# Create prediction grid with CI
time_range = np.linspace(df_indiv['Hours'].min(), df_indiv['Hours'].max(), 100)
pred_grid = create_pred_grid_with_ci(lmm_results, df_lmm, time_range)

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

location_types = sorted(df_indiv['LocationType'].unique())

for loc_type in location_types:
    color = COLORS.get(loc_type, '#333333')

    # 1. Plot faded scatter points (individual observations)
    loc_data = df_indiv[df_indiv['LocationType'] == loc_type]
    ax.scatter(
        loc_data['Hours'],
        loc_data['theta'],
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get predictions for this location type
    loc_pred = pred_grid[pred_grid['LocationType'] == loc_type]

    # 3. Plot shaded CI band
    ax.fill_between(
        loc_pred['Hours'],
        loc_pred['theta_ci_lower'],
        loc_pred['theta_ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot dashed fitted curve
    ax.plot(
        loc_pred['Hours'],
        loc_pred['mean_theta'],
        color=color,
        linestyle=IRT_LINE_STYLE,
        linewidth=2.5,
        label=loc_type.capitalize()
    )

# Formatting
ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Memory Ability (Theta)', fontsize=12)
ax.set_title('RQ 5.5.1: Source vs Destination Memory Trajectories - Theta Scale', fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, df_indiv['Hours'].max() + 5)

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_theta.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_theta.png'}")

# =============================================================================
# PLOT 2: TRAJECTORY (PROBABILITY-SCALE) - Decision D069
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 2: Probability-scale trajectory (Decision D069)...")
print("-" * 70)

# Transform individual observations to probability
df_indiv_prob = df_indiv.copy()
df_indiv_prob['probability'] = convert_theta_to_probability(
    df_indiv_prob['theta'].values,
    discrimination=mean_discrimination,
    difficulty=0.0
) * 100  # Convert to percentage

# Transform predictions to probability
pred_grid_prob = pred_grid.copy()
pred_grid_prob['mean_prob'] = convert_theta_to_probability(
    pred_grid_prob['mean_theta'].values,
    discrimination=mean_discrimination,
    difficulty=0.0
) * 100
pred_grid_prob['prob_ci_lower'] = convert_theta_to_probability(
    pred_grid_prob['theta_ci_lower'].values,
    discrimination=mean_discrimination,
    difficulty=0.0
) * 100
pred_grid_prob['prob_ci_upper'] = convert_theta_to_probability(
    pred_grid_prob['theta_ci_upper'].values,
    discrimination=mean_discrimination,
    difficulty=0.0
) * 100

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

for loc_type in location_types:
    color = COLORS.get(loc_type, '#333333')

    # 1. Plot faded scatter points (individual observations)
    loc_data = df_indiv_prob[df_indiv_prob['LocationType'] == loc_type]
    ax.scatter(
        loc_data['Hours'],
        loc_data['probability'],
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get predictions for this location type
    loc_pred = pred_grid_prob[pred_grid_prob['LocationType'] == loc_type]

    # 3. Plot shaded CI band
    ax.fill_between(
        loc_pred['Hours'],
        loc_pred['prob_ci_lower'],
        loc_pred['prob_ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot dashed fitted curve
    ax.plot(
        loc_pred['Hours'],
        loc_pred['mean_prob'],
        color=color,
        linestyle=IRT_LINE_STYLE,
        linewidth=2.5,
        label=loc_type.capitalize()
    )

# Formatting
ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Probability Correct (%)', fontsize=12)
ax.set_title('RQ 5.5.1: Source vs Destination Memory Trajectories - Probability Scale', fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, df_indiv['Hours'].max() + 5)
ax.set_ylim(0, 100)

# Add D069 annotation
ax.annotate('Decision D069: Dual-scale plotting', xy=(0.02, 0.02), xycoords='axes fraction',
            fontsize=8, color='gray', style='italic')

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_probability.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_probability.png'}")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 2")
print(f"  - trajectory_theta.png (individual scatter + fitted curves + CI)")
print(f"  - trajectory_probability.png (Decision D069)")
print(f"\nPlot style: 5.2.1 format")
print(f"  - Faded scatter points (alpha={RESIDUAL_SCATTER_POINT_ALPHA})")
print(f"  - Dashed fitted curves from LMM")
print(f"  - 95% CI bands from fixed effects covariance")
print(f"\nMean discrimination for probability conversion: {mean_discrimination:.3f}")
print("=" * 70)
