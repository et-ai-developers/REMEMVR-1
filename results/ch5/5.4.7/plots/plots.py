#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.4.7 - Schema-Based Clustering

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-04
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

PLOTS GENERATED:
1. bic_elbow.png - BIC model selection curve (K=1-6)
2. cluster_profiles.png - Cluster centroid bar chart (6 clusters × 6 features)
3. cluster_scatter_matrix.png - 6x6 scatter plot matrix with cluster coloring
"""

from pathlib import Path
import sys
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# Add project root to path for tools import
RQ_ROOT = Path(__file__).parent.parent
PROJECT_ROOT = RQ_ROOT.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.4.7...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: BIC ELBOW PLOT
# =============================================================================

print("\nGenerating Plot 1: BIC elbow plot...")

df_bic = pd.read_csv(RQ_ROOT / "data" / "step02_cluster_selection.csv")
print(f"  Loaded {len(df_bic)} rows from step02_cluster_selection.csv")

fig, ax = plt.subplots(figsize=(8, 5))

# Plot BIC curve
ax.plot(df_bic['K'], df_bic['BIC'], 'b-o', linewidth=2, markersize=8, label='BIC')

# Mark optimal K (minimum BIC)
optimal_idx = df_bic['BIC'].idxmin()
optimal_k = df_bic.loc[optimal_idx, 'K']
optimal_bic = df_bic.loc[optimal_idx, 'BIC']
ax.axvline(x=optimal_k, color='red', linestyle='--', linewidth=1.5, alpha=0.7)
ax.scatter([optimal_k], [optimal_bic], color='red', s=150, zorder=10,
           edgecolors='black', linewidth=2, label=f'Optimal K={optimal_k}')

ax.set_xlabel('Number of Clusters (K)', fontsize=12)
ax.set_ylabel('BIC (lower is better)', fontsize=12)
ax.set_title('RQ 5.4.7: BIC Model Selection for Schema-Based Clustering', fontweight='bold', fontsize=13)
ax.set_xticks(df_bic['K'])
ax.legend(loc='upper right', fontsize=10)
ax.grid(True, alpha=0.3)

plt.tight_layout()
output_path = RQ_ROOT / "plots" / "bic_elbow.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  ✓ Saved: plots/bic_elbow.png")
plt.close()

# =============================================================================
# PLOT 2: CLUSTER PROFILES BAR CHART
# =============================================================================

print("\nGenerating Plot 2: Cluster profiles bar chart...")

df_centers = pd.read_csv(RQ_ROOT / "data" / "step05_cluster_centers_original_scale.csv")
print(f"  Loaded {len(df_centers)} rows from step05_cluster_centers_original_scale.csv")

# Features to plot (original scale intercepts only - slopes are ~0)
features = ['Common_Intercept', 'Congruent_Intercept', 'Incongruent_Intercept']
feature_labels = ['Common', 'Congruent', 'Incongruent']

n_clusters = len(df_centers)
n_features = len(features)
x = np.arange(n_features)
width = 0.12  # Width of each bar

# Create colors for clusters
cluster_colors = plt.cm.tab10.colors[:n_clusters]

fig, ax = plt.subplots(figsize=(10, 6))

for i, (_, row) in enumerate(df_centers.iterrows()):
    cluster_id = row['cluster']
    label = row['label']
    n_members = row['N']
    values = [row[f] for f in features]

    offset = (i - n_clusters/2 + 0.5) * width
    bars = ax.bar(x + offset, values, width, label=f'C{cluster_id}: {label} (n={n_members})',
                  color=cluster_colors[i], edgecolor='black', linewidth=0.5)

ax.axhline(y=0, color='gray', linestyle='-', linewidth=1, alpha=0.5)
ax.set_xlabel('Schema Congruence Level', fontsize=12)
ax.set_ylabel('Random Intercept (Original Scale)', fontsize=12)
ax.set_title('RQ 5.4.7: Cluster Profiles by Schema Congruence\n(Baseline Memory Performance)',
             fontweight='bold', fontsize=13)
ax.set_xticks(x)
ax.set_xticklabels(feature_labels, fontsize=11)
ax.legend(loc='upper right', fontsize=9, ncol=2)
ax.grid(True, axis='y', alpha=0.3)

plt.tight_layout()
output_path = RQ_ROOT / "plots" / "cluster_profiles.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  ✓ Saved: plots/cluster_profiles.png")
plt.close()

# =============================================================================
# PLOT 3: SCATTER PLOT MATRIX (6x6 - Intercepts only, slopes ~0)
# =============================================================================

print("\nGenerating Plot 3: Cluster scatter plot matrix...")

df_plot = pd.read_csv(RQ_ROOT / "data" / "step06_scatter_matrix_plot_data.csv")
print(f"  Loaded {len(df_plot)} rows from step06_scatter_matrix_plot_data.csv")

# Separate participants from centroids
df_participants = df_plot[df_plot['data_type'] == 'participant'].copy()
df_centroids = df_plot[df_plot['data_type'] == 'centroid'].copy()

print(f"  Participants: {len(df_participants)}, Centroids: {len(df_centroids)}")

# Use intercepts only (slopes are ~0, provide no clustering info)
clustering_vars = [
    'Common_Intercept_z',
    'Congruent_Intercept_z',
    'Incongruent_Intercept_z'
]

var_labels = {
    'Common_Intercept_z': 'Common (z)',
    'Congruent_Intercept_z': 'Congruent (z)',
    'Incongruent_Intercept_z': 'Incongruent (z)'
}

# Get unique clusters
clusters = sorted(df_participants['cluster'].unique())
n_clusters = len(clusters)
print(f"  Number of clusters: {n_clusters}")

# Cluster colors and labels
cluster_palette = {cluster: cluster_colors[i] for i, cluster in enumerate(clusters)}
cluster_labels_map = df_participants.groupby('cluster')['cluster_label'].first().to_dict()

# Create 3x3 figure (intercepts only)
fig, axes = plt.subplots(3, 3, figsize=(11, 11))

print(f"  Creating 3x3 scatter plot matrix (intercepts only)...")

for i, var_y in enumerate(clustering_vars):
    for j, var_x in enumerate(clustering_vars):
        ax = axes[i, j]

        if i == j:
            # DIAGONAL: Histogram
            for cluster in clusters:
                cluster_data = df_participants[df_participants['cluster'] == cluster][var_x]
                ax.hist(cluster_data, bins=12, alpha=0.5,
                       color=cluster_palette[cluster],
                       edgecolor='black', linewidth=0.5)

            ax.set_ylabel('Frequency', fontsize=9)
            ax.set_xlabel(var_labels[var_x], fontsize=9)
            ax.axvline(x=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.6)
            ax.grid(True, alpha=0.2)

        else:
            # OFF-DIAGONAL: Scatter plot
            for cluster in clusters:
                cluster_data = df_participants[df_participants['cluster'] == cluster]
                ax.scatter(cluster_data[var_x], cluster_data[var_y],
                          color=cluster_palette[cluster],
                          alpha=0.6, s=35, edgecolors='white', linewidth=0.5)

            # Plot centroids (X markers)
            for cluster in clusters:
                centroid_data = df_centroids[df_centroids['cluster'] == cluster]
                if len(centroid_data) > 0:
                    ax.scatter(centroid_data[var_x], centroid_data[var_y],
                             color=cluster_palette[cluster],
                             marker='X', s=200, edgecolors='black', linewidth=2,
                             zorder=10)

            ax.axhline(y=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.6)
            ax.axvline(x=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.6)
            ax.set_xlabel(var_labels[var_x], fontsize=9)
            ax.set_ylabel(var_labels[var_y], fontsize=9)
            ax.grid(True, alpha=0.2)

        ax.tick_params(labelsize=8)

# Add legend in upper right
from matplotlib.patches import Patch
from matplotlib.lines import Line2D

handles = []
for cluster in clusters:
    n_members = len(df_participants[df_participants['cluster'] == cluster])
    handles.append(Patch(color=cluster_palette[cluster],
                        label=f"C{cluster}: {cluster_labels_map[cluster]} (n={n_members})"))

handles.append(Line2D([0], [0], marker='X', color='w', markerfacecolor='gray',
                     markersize=12, markeredgecolor='black', markeredgewidth=1.5,
                     label='Centroids', linestyle='None'))

fig.legend(handles=handles, loc='upper right', fontsize=8, frameon=True,
          title='Clusters', title_fontsize=9, bbox_to_anchor=(0.98, 0.98))

fig.suptitle('RQ 5.4.7: Schema-Based Clustering - Scatter Plot Matrix\n(Baseline Intercepts Only - Slopes ≈ 0)',
            fontweight='bold', fontsize=13, y=1.01)

plt.tight_layout(rect=[0, 0, 0.88, 0.98])

output_path = RQ_ROOT / "plots" / "cluster_scatter_matrix.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  ✓ Saved: plots/cluster_scatter_matrix.png")
plt.close()

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 3")
print(f"  - plots/bic_elbow.png (K selection)")
print(f"  - plots/cluster_profiles.png (centroid bar chart)")
print(f"  - plots/cluster_scatter_matrix.png (3x3 scatter matrix)")
print(f"\nClusters visualized: {n_clusters}")
for cluster in clusters:
    n_members = len(df_participants[df_participants['cluster'] == cluster])
    print(f"  - Cluster {cluster}: {cluster_labels_map[cluster]} (n={n_members})")
print(f"\nNOTE: Weak clustering quality (silhouette=0.254, Jaccard=0.592)")
print(f"      Slopes omitted from scatter matrix (ICC_slope=0.000 from RQ 5.4.6)")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
