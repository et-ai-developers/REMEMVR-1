#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.4.7 - Schema-Based Clustering

GENERATED BY: rq_plots agent (v4.0.1)
DATE: 2025-12-09
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

CRITICAL UPDATE (2025-12-09):
- Now uses model-averaged random effects with MEANINGFUL slope variance (0.003-0.007)
- Previous version (Dec 3) used Log-only slopes (≈0) → clustering only on intercepts
- Current version: Clustering on FULL 6 dimensions (3 intercepts + 3 slopes)
- Scatter matrix now 6×6 (not 3×3) showing both intercepts AND slopes

PLOTS GENERATED:
1. bic_elbow.png - BIC model selection curve (K=1-6)
2. cluster_profiles.png - Cluster centroid bar chart (6 clusters × 6 features)
3. cluster_scatter_matrix.png - 6×6 scatter plot matrix with cluster coloring
"""

from pathlib import Path
import sys
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# Add project root to path for tools import
RQ_ROOT = Path(__file__).parent.parent
PROJECT_ROOT = RQ_ROOT.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.4.7 (UPDATED with model-averaged slopes)...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: BIC ELBOW PLOT
# =============================================================================

print("\nGenerating Plot 1: BIC elbow plot...")

df_bic = pd.read_csv(RQ_ROOT / "data" / "step02_cluster_selection.csv")
print(f"  Loaded {len(df_bic)} rows from step02_cluster_selection.csv")

fig, ax = plt.subplots(figsize=(8, 5))

# Plot BIC curve
ax.plot(df_bic['K'], df_bic['BIC'], 'b-o', linewidth=2, markersize=8, label='BIC')

# Mark optimal K (minimum BIC)
optimal_idx = df_bic['BIC'].idxmin()
optimal_k = df_bic.loc[optimal_idx, 'K']
optimal_bic = df_bic.loc[optimal_idx, 'BIC']
ax.axvline(x=optimal_k, color='red', linestyle='--', linewidth=1.5, alpha=0.7)
ax.scatter([optimal_k], [optimal_bic], color='red', s=150, zorder=10,
           edgecolors='black', linewidth=2, label=f'Optimal K={optimal_k}')

ax.set_xlabel('Number of Clusters (K)', fontsize=12)
ax.set_ylabel('BIC (lower is better)', fontsize=12)
ax.set_title('RQ 5.4.7: BIC Model Selection for Schema-Based Clustering', fontweight='bold', fontsize=13)
ax.set_xticks(df_bic['K'])
ax.legend(loc='upper right', fontsize=10)
ax.grid(True, alpha=0.3)

plt.tight_layout()
output_path = RQ_ROOT / "plots" / "bic_elbow.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  -> Saved: plots/bic_elbow.png")
plt.close()

# =============================================================================
# PLOT 2: CLUSTER PROFILES BAR CHART (INTERCEPTS + SLOPES)
# =============================================================================

print("\nGenerating Plot 2: Cluster profiles bar chart (intercepts + slopes)...")

df_centers = pd.read_csv(RQ_ROOT / "data" / "step05_cluster_centers_original_scale.csv")
print(f"  Loaded {len(df_centers)} rows from step05_cluster_centers_original_scale.csv")

# Create TWO subplots: Intercepts (left), Slopes (right)
fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6))

# INTERCEPTS
features_int = ['Common_Intercept', 'Congruent_Intercept', 'Incongruent_Intercept']
feature_labels = ['Common', 'Congruent', 'Incongruent']

n_clusters = len(df_centers)
n_features = len(features_int)
x = np.arange(n_features)
width = 0.12  # Width of each bar

# Create colors for clusters
cluster_colors = plt.cm.tab10.colors[:n_clusters]

for i, (_, row) in enumerate(df_centers.iterrows()):
    cluster_id = row['cluster']
    label = row['label']
    n_members = row['N']
    values_int = [row[f] for f in features_int]

    offset = (i - n_clusters/2 + 0.5) * width
    bars = ax1.bar(x + offset, values_int, width, label=f'C{cluster_id}: {label} (n={n_members})',
                  color=cluster_colors[i], edgecolor='black', linewidth=0.5)

ax1.axhline(y=0, color='gray', linestyle='-', linewidth=1, alpha=0.5)
ax1.set_xlabel('Schema Congruence Level', fontsize=11)
ax1.set_ylabel('Random Intercept (theta units)', fontsize=11)
ax1.set_title('Cluster Profiles: Baseline Memory Performance', fontweight='bold', fontsize=12)
ax1.set_xticks(x)
ax1.set_xticklabels(feature_labels, fontsize=10)
ax1.legend(loc='upper right', fontsize=8, ncol=1)
ax1.grid(True, axis='y', alpha=0.3)

# SLOPES
features_slope = ['Common_Slope', 'Congruent_Slope', 'Incongruent_Slope']

for i, (_, row) in enumerate(df_centers.iterrows()):
    cluster_id = row['cluster']
    values_slope = [row[f] for f in features_slope]

    offset = (i - n_clusters/2 + 0.5) * width
    bars = ax2.bar(x + offset, values_slope, width,
                  color=cluster_colors[i], edgecolor='black', linewidth=0.5)

ax2.axhline(y=0, color='gray', linestyle='-', linewidth=1, alpha=0.5)
ax2.set_xlabel('Schema Congruence Level', fontsize=11)
ax2.set_ylabel('Random Slope (theta/hour)', fontsize=11)
ax2.set_title('Cluster Profiles: Forgetting Rates', fontweight='bold', fontsize=12)
ax2.set_xticks(x)
ax2.set_xticklabels(feature_labels, fontsize=10)
ax2.grid(True, axis='y', alpha=0.3)

fig.suptitle('RQ 5.4.7: Schema-Based Clustering - Cluster Profiles (Model-Averaged Random Effects)',
            fontweight='bold', fontsize=13, y=1.00)

plt.tight_layout()
output_path = RQ_ROOT / "plots" / "cluster_profiles.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  -> Saved: plots/cluster_profiles.png")
plt.close()

# =============================================================================
# PLOT 3: SCATTER PLOT MATRIX (6x6 - FULL FEATURES)
# =============================================================================

print("\nGenerating Plot 3: Cluster scatter plot matrix (6x6 - intercepts + slopes)...")

df_plot = pd.read_csv(RQ_ROOT / "data" / "step06_scatter_matrix_plot_data.csv")
print(f"  Loaded {len(df_plot)} rows from step06_scatter_matrix_plot_data.csv")

# Separate participants from centroids
df_participants = df_plot[df_plot['data_type'] == 'participant'].copy()
df_centroids = df_plot[df_plot['data_type'] == 'center'].copy()

print(f"  Participants: {len(df_participants)}, Centroids: {len(df_centroids)}")

# Use ALL 6 clustering variables (3 intercepts + 3 slopes)
clustering_vars = [
    'Common_Intercept_z',
    'Congruent_Intercept_z',
    'Incongruent_Intercept_z',
    'Common_Slope_z',
    'Congruent_Slope_z',
    'Incongruent_Slope_z'
]

var_labels = {
    'Common_Intercept_z': 'Common Int',
    'Congruent_Intercept_z': 'Congruent Int',
    'Incongruent_Intercept_z': 'Incongruent Int',
    'Common_Slope_z': 'Common Slope',
    'Congruent_Slope_z': 'Congruent Slope',
    'Incongruent_Slope_z': 'Incongruent Slope'
}

# Get unique clusters
clusters = sorted(df_participants['cluster'].unique())
n_clusters = len(clusters)
print(f"  Number of clusters: {n_clusters}")

# Cluster colors and labels
cluster_palette = {cluster: cluster_colors[i] for i, cluster in enumerate(clusters)}
cluster_labels_map = df_participants.groupby('cluster')['cluster_label'].first().to_dict()

# Create 6x6 figure (FULL feature space)
fig, axes = plt.subplots(6, 6, figsize=(16, 16))

print(f"  Creating 6x6 scatter plot matrix (intercepts + slopes)...")

for i, var_y in enumerate(clustering_vars):
    for j, var_x in enumerate(clustering_vars):
        ax = axes[i, j]

        if i == j:
            # DIAGONAL: Histogram
            for cluster in clusters:
                cluster_data = df_participants[df_participants['cluster'] == cluster][var_x]
                ax.hist(cluster_data, bins=12, alpha=0.5,
                       color=cluster_palette[cluster],
                       edgecolor='black', linewidth=0.5)

            ax.set_ylabel('Freq', fontsize=7)
            ax.set_xlabel(var_labels[var_x], fontsize=7)
            ax.axvline(x=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.6)
            ax.grid(True, alpha=0.2)

        else:
            # OFF-DIAGONAL: Scatter plot
            for cluster in clusters:
                cluster_data = df_participants[df_participants['cluster'] == cluster]
                ax.scatter(cluster_data[var_x], cluster_data[var_y],
                          color=cluster_palette[cluster],
                          alpha=0.5, s=25, edgecolors='white', linewidth=0.3)

            # Plot centroids (X markers)
            for cluster in clusters:
                centroid_data = df_centroids[df_centroids['cluster'] == cluster]
                if len(centroid_data) > 0:
                    ax.scatter(centroid_data[var_x], centroid_data[var_y],
                             color=cluster_palette[cluster],
                             marker='X', s=150, edgecolors='black', linewidth=1.5,
                             zorder=10)

            ax.axhline(y=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.6)
            ax.axvline(x=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.6)
            ax.set_xlabel(var_labels[var_x], fontsize=7)
            ax.set_ylabel(var_labels[var_y], fontsize=7)
            ax.grid(True, alpha=0.2)

        ax.tick_params(labelsize=6)

# Add legend in upper right
from matplotlib.patches import Patch
from matplotlib.lines import Line2D

handles = []
for cluster in clusters:
    n_members = len(df_participants[df_participants['cluster'] == cluster])
    handles.append(Patch(color=cluster_palette[cluster],
                        label=f"C{cluster}: {cluster_labels_map[cluster]} (n={n_members})"))

handles.append(Line2D([0], [0], marker='X', color='w', markerfacecolor='gray',
                     markersize=10, markeredgecolor='black', markeredgewidth=1.5,
                     label='Centroids', linestyle='None'))

fig.legend(handles=handles, loc='upper right', fontsize=7, frameon=True,
          title='Clusters', title_fontsize=8, bbox_to_anchor=(0.98, 0.98))

fig.suptitle('RQ 5.4.7: Schema-Based Clustering - Scatter Plot Matrix\n(Model-Averaged Random Effects: 3 Intercepts + 3 Slopes)',
            fontweight='bold', fontsize=12, y=1.00)

plt.tight_layout(rect=[0, 0, 0.88, 0.98])

output_path = RQ_ROOT / "plots" / "cluster_scatter_matrix.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  -> Saved: plots/cluster_scatter_matrix.png")
plt.close()

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE (UPDATED FOR MODEL-AVERAGED SLOPES)")
print("="*70)
print(f"Total plots generated: 3")
print(f"  - plots/bic_elbow.png (K selection)")
print(f"  - plots/cluster_profiles.png (intercepts + slopes bar charts)")
print(f"  - plots/cluster_scatter_matrix.png (6x6 scatter matrix)")
print(f"\nClusters visualized: {n_clusters}")
for cluster in clusters:
    n_members = len(df_participants[df_participants['cluster'] == cluster])
    print(f"  - Cluster {cluster}: {cluster_labels_map[cluster]} (n={n_members})")
print(f"\nSlope variance (now MEANINGFUL): Common=0.007, Congruent=0.004, Incongruent=0.003")
print(f"Clustering quality (weak): silhouette=0.236, Jaccard=0.587")
print(f"\nCONTRAST to Dec 3 analysis:")
print(f"  - Previous: Log-only slopes (≈0) -> clustering only on 3 intercepts")
print(f"  - Current: Model-averaged slopes -> clustering on 6 dimensions (3 int + 3 slope)")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
