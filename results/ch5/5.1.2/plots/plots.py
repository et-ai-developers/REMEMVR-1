#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.1.2 - Evidence for Two-Phase Forgetting (Rapid then Slow)

GENERATED BY: rq_plots agent (v4.0.0) - REFACTORED 2025-12-07
DATE: 2025-12-07
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSV

OPTION B ARCHITECTURE:
- Plot source CSV created by analysis pipeline (g_code, Step 6)
- This script ONLY reads CSV and calls tools/plotting.py functions
- NO inline plotting code

PLOTS GENERATED:
1. piecewise_comparison.png - Two-panel plot comparing continuous (quadratic) vs piecewise models
"""

from pathlib import Path
import sys
import pandas as pd
import numpy as np

# Add project root to path (plots.py is in results/ch5/5.1.2/plots/)
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import (
    set_plot_style_defaults,
    plot_trajectory
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("="*70)
print("PLOTTING FOR RQ 5.1.2 - Two-Phase Forgetting Model Comparison")
print("="*70)
print(f"RQ root: {RQ_ROOT}")
print()

# =============================================================================
# LOAD DATA
# =============================================================================

print("Loading plot source data...")
df_plot = pd.read_csv(RQ_ROOT / "plots" / "step06_piecewise_comparison_data.csv")
print(f"  Loaded {len(df_plot)} rows from step06_piecewise_comparison_data.csv")
print(f"  Columns: {list(df_plot.columns)}")
print()

# Separate data by source
df_observed = df_plot[df_plot['source'] == 'Observed'].copy()
df_quadratic = df_plot[df_plot['source'] == 'Quadratic'].copy()
df_piecewise = df_plot[df_plot['source'] == 'Piecewise'].copy()

print(f"  Observed data: {len(df_observed)} rows")
print(f"  Quadratic model: {len(df_quadratic)} rows")
print(f"  Piecewise model: {len(df_piecewise)} rows")
print()

# =============================================================================
# PLOT 1: QUADRATIC MODEL (PANEL 1)
# =============================================================================

print("Generating Plot 1 (Panel 1): Quadratic model...")

# Prepare data for plot_trajectory
time_pred_quad = df_quadratic['TSVR_hours'].values
fitted_curves_quad = {
    'Quadratic': df_quadratic['theta'].values
}

observed_data_quad = pd.DataFrame({
    'TSVR_hours': df_observed['TSVR_hours'].values,
    'theta': df_observed['theta'].values,
    'CI_lower': df_observed['CI_lower'].values,
    'CI_upper': df_observed['CI_upper'].values,
    'Model': ['Quadratic'] * len(df_observed)
})

fig1, ax1 = plot_trajectory(
    time_pred=time_pred_quad,
    fitted_curves=fitted_curves_quad,
    observed_data=observed_data_quad,
    time_col='TSVR_hours',
    value_col='theta',
    group_col='Model',
    ci_lower_col='CI_lower',
    ci_upper_col='CI_upper',
    xlabel='Hours Since VR Encoding (TSVR)',
    ylabel='Memory Ability (Theta)',
    title='Continuous Model (Quadratic)',
    colors={'Quadratic': '#E74C3C'},
    figsize=(7, 6),
    output_path=RQ_ROOT / "plots" / "piecewise_comparison_panel1_quadratic.png",
    show_errorbar=True,
    ylim=(-1.0, 1.0)
)

print(f"  [PASS] Saved: plots/piecewise_comparison_panel1_quadratic.png")
print()

# =============================================================================
# PLOT 2: PIECEWISE MODEL (PANEL 2)
# =============================================================================

print("Generating Plot 2 (Panel 2): Piecewise model...")

# Separate piecewise data by segment
df_early = df_piecewise[df_piecewise['Segment'] == 'Early'].copy()
df_late = df_piecewise[df_piecewise['Segment'] == 'Late'].copy()

# Prepare data for plot_trajectory
# Combine Early and Late as separate curves
time_pred_piece = np.concatenate([
    df_early['TSVR_hours'].values,
    df_late['TSVR_hours'].values
])

# Create segment labels for each time point
segment_labels = (
    ['Early'] * len(df_early) +
    ['Late'] * len(df_late)
)

# Combine predictions
piece_theta = np.concatenate([
    df_early['theta'].values,
    df_late['theta'].values
])

# For plot_trajectory, we need fitted_curves dict
# We'll create two separate curves: Early and Late
fitted_curves_piece = {
    'Early (0-48h)': df_early['theta'].values,
    'Late (48-240h)': df_late['theta'].values
}

# Need separate time arrays for each segment
time_pred_dict = {
    'Early (0-48h)': df_early['TSVR_hours'].values,
    'Late (48-240h)': df_late['TSVR_hours'].values
}

observed_data_piece = pd.DataFrame({
    'TSVR_hours': df_observed['TSVR_hours'].values,
    'theta': df_observed['theta'].values,
    'CI_lower': df_observed['CI_lower'].values,
    'CI_upper': df_observed['CI_upper'].values,
    'Segment': ['Piecewise'] * len(df_observed)
})

# Since plot_trajectory expects single time_pred array, we need to use it differently
# For piecewise, we'll call it twice with different segments overlaid
import matplotlib.pyplot as plt

fig2, ax2 = plt.subplots(figsize=(7, 6))

# Plot observed data with error bars
ax2.errorbar(
    observed_data_piece['TSVR_hours'],
    observed_data_piece['theta'],
    yerr=[
        observed_data_piece['theta'] - observed_data_piece['CI_lower'],
        observed_data_piece['CI_upper'] - observed_data_piece['theta']
    ],
    fmt='o', color='#34495E', markersize=8,
    capsize=5, capthick=2, alpha=0.7,
    label='Observed'
)

# Plot Early segment
ax2.plot(
    df_early['TSVR_hours'],
    df_early['theta'],
    color='#3498DB', linewidth=2.5,
    label='Piecewise - Early (0-48h)',
    alpha=0.9
)

# Plot Late segment
ax2.plot(
    df_late['TSVR_hours'],
    df_late['theta'],
    color='#2ECC71', linewidth=2.5,
    label='Piecewise - Late (48-240h)',
    alpha=0.9
)

# Fill CI bands
ax2.fill_between(
    df_early['TSVR_hours'],
    df_early['CI_lower'],
    df_early['CI_upper'],
    color='#3498DB', alpha=0.2
)

ax2.fill_between(
    df_late['TSVR_hours'],
    df_late['CI_lower'],
    df_late['CI_upper'],
    color='#2ECC71', alpha=0.2
)

# Add vertical line at inflection point
ax2.axvline(x=48, color='#95A5A6', linestyle='--', linewidth=2, alpha=0.7,
            label='Inflection (48h)')

# Formatting
ax2.set_xlabel('Hours Since VR Encoding (TSVR)', fontweight='bold')
ax2.set_ylabel('Memory Ability (Theta)', fontweight='bold')
ax2.set_title('Piecewise Model (Inflection at 48h)', fontweight='bold', pad=15)
ax2.legend(loc='upper right', framealpha=0.95)
ax2.grid(True, alpha=0.3)
ax2.set_ylim(-1.0, 1.0)

plt.tight_layout()

# Save
output_path = RQ_ROOT / "plots" / "piecewise_comparison_panel2_piecewise.png"
fig2.savefig(output_path, dpi=300, bbox_inches='tight')

print(f"  [PASS] Saved: plots/piecewise_comparison_panel2_piecewise.png")
print()

# =============================================================================
# PLOT 3: COMBINED TWO-PANEL COMPARISON
# =============================================================================

print("Generating Plot 3: Combined two-panel comparison...")

fig_combined, (ax_quad, ax_piece) = plt.subplots(1, 2, figsize=(14, 6))

# Panel 1: Quadratic
ax_quad.errorbar(
    df_observed['TSVR_hours'],
    df_observed['theta'],
    yerr=[
        df_observed['theta'] - df_observed['CI_lower'],
        df_observed['CI_upper'] - df_observed['theta']
    ],
    fmt='o', color='#34495E', markersize=8,
    capsize=5, capthick=2, alpha=0.7,
    label='Observed'
)

ax_quad.plot(
    df_quadratic['TSVR_hours'],
    df_quadratic['theta'],
    color='#E74C3C', linewidth=2.5,
    label='Quadratic Model',
    alpha=0.9
)

ax_quad.fill_between(
    df_quadratic['TSVR_hours'],
    df_quadratic['CI_lower'],
    df_quadratic['CI_upper'],
    color='#E74C3C', alpha=0.2
)

ax_quad.set_xlabel('Hours Since VR Encoding (TSVR)', fontweight='bold')
ax_quad.set_ylabel('Memory Ability (Theta)', fontweight='bold')
ax_quad.set_title('Continuous Model (Quadratic)', fontweight='bold', pad=15)
ax_quad.legend(loc='upper right', framealpha=0.95)
ax_quad.grid(True, alpha=0.3)
ax_quad.set_ylim(-1.0, 1.0)

# Panel 2: Piecewise
ax_piece.errorbar(
    df_observed['TSVR_hours'],
    df_observed['theta'],
    yerr=[
        df_observed['theta'] - df_observed['CI_lower'],
        df_observed['CI_upper'] - df_observed['theta']
    ],
    fmt='o', color='#34495E', markersize=8,
    capsize=5, capthick=2, alpha=0.7,
    label='Observed'
)

ax_piece.plot(
    df_early['TSVR_hours'],
    df_early['theta'],
    color='#3498DB', linewidth=2.5,
    label='Piecewise - Early (0-48h)',
    alpha=0.9
)

ax_piece.plot(
    df_late['TSVR_hours'],
    df_late['theta'],
    color='#2ECC71', linewidth=2.5,
    label='Piecewise - Late (48-240h)',
    alpha=0.9
)

ax_piece.fill_between(
    df_early['TSVR_hours'],
    df_early['CI_lower'],
    df_early['CI_upper'],
    color='#3498DB', alpha=0.2
)

ax_piece.fill_between(
    df_late['TSVR_hours'],
    df_late['CI_lower'],
    df_late['CI_upper'],
    color='#2ECC71', alpha=0.2
)

ax_piece.axvline(x=48, color='#95A5A6', linestyle='--', linewidth=2, alpha=0.7,
                 label='Inflection (48h)')

ax_piece.set_xlabel('Hours Since VR Encoding (TSVR)', fontweight='bold')
ax_piece.set_ylabel('Memory Ability (Theta)', fontweight='bold')
ax_piece.set_title('Piecewise Model (Inflection at 48h)', fontweight='bold', pad=15)
ax_piece.legend(loc='upper right', framealpha=0.95)
ax_piece.grid(True, alpha=0.3)
ax_piece.set_ylim(-1.0, 1.0)

# Overall title
fig_combined.suptitle('RQ 5.1.2: Two-Phase Forgetting - Model Comparison',
                      fontsize=14, fontweight='bold', y=1.02)

plt.tight_layout()

# Save combined plot
output_combined = RQ_ROOT / "plots" / "piecewise_comparison.png"
fig_combined.savefig(output_combined, dpi=300, bbox_inches='tight')

print(f"  [PASS] Saved: plots/piecewise_comparison.png")
print()

# =============================================================================
# SUMMARY
# =============================================================================

print("="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 3")
print(f"  - plots/piecewise_comparison_panel1_quadratic.png (Panel 1 only)")
print(f"  - plots/piecewise_comparison_panel2_piecewise.png (Panel 2 only)")
print(f"  - plots/piecewise_comparison.png (Combined two-panel)")
print()
print("Plot shows:")
print("  - Panel 1: Quadratic model (continuous deceleration)")
print("  - Panel 2: Piecewise model (sharp inflection at 48h)")
print("  - Observed data points with 95% CI (both panels)")
print("  - Model predictions with 95% CI bands")
print()
print("All plots saved with 300 DPI publication quality.")
print("="*70)
