#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.1.2 - Evidence for Two-Phase Forgetting (Rapid then Slow)

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-11-28
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSV

OPTION B ARCHITECTURE:
- Plot source CSV created by analysis pipeline (g_code, Step 6)
- This script ONLY reads CSV and generates two-panel comparison plot
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. piecewise_comparison.png - Two-panel plot comparing continuous (quadratic) vs piecewise models
"""

from pathlib import Path
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.1.2/plots/)
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent.parent
RQ_ROOT = PROJECT_ROOT / "results" / "ch5" / "5.1.2"
# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.1.2...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: TWO-PANEL PIECEWISE VS QUADRATIC COMPARISON
# =============================================================================

print("\nGenerating Plot 1: Two-panel piecewise vs quadratic comparison...")

# Load plot source CSV (created by analysis pipeline Step 6)
df_plot = pd.read_csv(RQ_ROOT / "plots" / "step06_piecewise_comparison_data.csv")
print(f"  Loaded {len(df_plot)} rows from step06_piecewise_comparison_data.csv")
print(f"  Columns: {list(df_plot.columns)}")

# Separate data by source
df_observed = df_plot[df_plot['source'] == 'Observed'].copy()
df_quadratic = df_plot[df_plot['source'] == 'Quadratic'].copy()
df_piecewise = df_plot[df_plot['source'] == 'Piecewise'].copy()

print(f"  Observed data: {len(df_observed)} rows")
print(f"  Quadratic model: {len(df_quadratic)} rows")
print(f"  Piecewise model: {len(df_piecewise)} rows")

# Create two-panel plot
fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6))

# =============================================================================
# PANEL 1: QUADRATIC MODEL
# =============================================================================

# Plot observed data points with error bars
ax1.errorbar(
    df_observed['TSVR_hours'],
    df_observed['theta'],
    yerr=[
        df_observed['theta'] - df_observed['CI_lower'],
        df_observed['CI_upper'] - df_observed['theta']
    ],
    fmt='o', color='#34495E', markersize=8,
    capsize=5, capthick=2, alpha=0.7,
    label='Observed'
)

# Plot quadratic model fitted curve
ax1.plot(
    df_quadratic['TSVR_hours'],
    df_quadratic['theta'],
    color='#E74C3C', linewidth=2.5,
    label='Quadratic Model',
    alpha=0.9
)

# Fill 95% CI for quadratic model
ax1.fill_between(
    df_quadratic['TSVR_hours'],
    df_quadratic['CI_lower'],
    df_quadratic['CI_upper'],
    color='#E74C3C', alpha=0.2
)

# Formatting
ax1.set_xlabel('Hours Since VR Encoding (TSVR)', fontweight='bold')
ax1.set_ylabel('Memory Ability (Theta)', fontweight='bold')
ax1.set_title('Continuous Model (Quadratic)', fontweight='bold', pad=15)
ax1.legend(loc='upper right', framealpha=0.95)
ax1.grid(True, alpha=0.3)
ax1.set_ylim(-1.0, 1.0)

# =============================================================================
# PANEL 2: PIECEWISE MODEL
# =============================================================================

# Plot observed data points with error bars
ax2.errorbar(
    df_observed['TSVR_hours'],
    df_observed['theta'],
    yerr=[
        df_observed['theta'] - df_observed['CI_lower'],
        df_observed['CI_upper'] - df_observed['theta']
    ],
    fmt='o', color='#34495E', markersize=8,
    capsize=5, capthick=2, alpha=0.7,
    label='Observed'
)

# Separate piecewise data by segment
df_early = df_piecewise[df_piecewise['Segment'] == 'Early'].copy()
df_late = df_piecewise[df_piecewise['Segment'] == 'Late'].copy()

# Plot Early segment (0-48 hours)
ax2.plot(
    df_early['TSVR_hours'],
    df_early['theta'],
    color='#3498DB', linewidth=2.5,
    label='Piecewise - Early (0-48h)',
    alpha=0.9
)

# Plot Late segment (48-240 hours)
ax2.plot(
    df_late['TSVR_hours'],
    df_late['theta'],
    color='#2ECC71', linewidth=2.5,
    label='Piecewise - Late (48-240h)',
    alpha=0.9
)

# Fill 95% CI for piecewise model
ax2.fill_between(
    df_early['TSVR_hours'],
    df_early['CI_lower'],
    df_early['CI_upper'],
    color='#3498DB', alpha=0.2
)

ax2.fill_between(
    df_late['TSVR_hours'],
    df_late['CI_lower'],
    df_late['CI_upper'],
    color='#2ECC71', alpha=0.2
)

# Add vertical line at inflection point (48 hours = Day 1)
ax2.axvline(x=48, color='#95A5A6', linestyle='--', linewidth=2, alpha=0.7,
            label='Inflection (48h)')

# Formatting
ax2.set_xlabel('Hours Since VR Encoding (TSVR)', fontweight='bold')
ax2.set_ylabel('Memory Ability (Theta)', fontweight='bold')
ax2.set_title('Piecewise Model (Inflection at 48h)', fontweight='bold', pad=15)
ax2.legend(loc='upper right', framealpha=0.95)
ax2.grid(True, alpha=0.3)
ax2.set_ylim(-1.0, 1.0)

# Overall figure title
fig.suptitle('RQ 5.1.2: Two-Phase Forgetting - Model Comparison',
             fontsize=14, fontweight='bold', y=1.02)

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "piecewise_comparison.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')

print(f"  -> Saved: plots/piecewise_comparison.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/piecewise_comparison.png")
print("\nPlot shows:")
print("  - Panel 1: Quadratic model (continuous deceleration)")
print("  - Panel 2: Piecewise model (sharp inflection at 48h)")
print("  - Observed data points with 95% CI (both panels)")
print("  - Model predictions with 95% CI bands")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
