[START] Step 05: Prepare Piecewise Trajectory Plot Data
============================================================
[LOAD] Loading input data...
[LOADED] step00_piecewise_lmm_input.csv (1200 rows, 8 cols)
         Columns: ['composite_ID', 'UID', 'test', 'TSVR_hours', 'domain', 'theta', 'Segment', 'Days_within']
[ERROR] 'NoneType' object has no attribute 'f_locals'
[TRACEBACK] Full error details:
Traceback (most recent call last):
  File "/home/etai/projects/REMEMVR/results/ch5/rq2/code/step05_prepare_piecewise_plot_data.py", line 153, in <module>
    lmm_model = pickle.load(f)
                ^^^^^^^^^^^^^^
  File "/home/etai/projects/REMEMVR/.venv/lib/python3.12/site-packages/statsmodels/base/data.py", line 112, in __setstate__
    _, design = dmatrices(d['formula'], data, eval_env=depth,
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/etai/projects/REMEMVR/.venv/lib/python3.12/site-packages/patsy/highlevel.py", line 316, in dmatrices
    eval_env = EvalEnvironment.capture(eval_env, reference=1)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/etai/projects/REMEMVR/.venv/lib/python3.12/site-packages/patsy/eval.py", line 242, in capture
    [frame.f_locals, frame.f_globals],
     ^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'f_locals'
[START] Step 05: Prepare Piecewise Trajectory Plot Data
============================================================
[LOAD] Loading input data...
[LOADED] step00_piecewise_lmm_input.csv (1200 rows, 8 cols)
         Columns: ['composite_ID', 'UID', 'test', 'TSVR_hours', 'domain', 'theta', 'Segment', 'Days_within']
[LOADED] step01_piecewise_lmm_model.pkl (MixedLMResults object)
[LOADED] RQ 5.1 step03_item_parameters.csv (70 items)
         Mean item discrimination (a): 0.9385

[ANALYSIS] Aggregating theta scores by domain, test, and Segment...
[DONE] Aggregated to 12 groups (domain x test combinations)

[ANALYSIS] Generating model predictions for trajectory lines...
[DONE] Generated 12 predictions

[SAVE] Saving theta-scale plot data...
[SAVED] plots/step05_piecewise_theta_data.csv (12 rows)
         Theta range: [-0.478, 0.685]

[ANALYSIS] Transforming theta to probability scale (Decision D069)...
         Using IRT 2PL: P = 1 / (1 + exp(-(a * (theta - b))))
         a = 0.9385 (mean discrimination)
         b = 0.0 (reference difficulty)
[DONE] Transformed 12 rows to probability scale
         Probability range: [0.390, 0.656]

[SAVE] Saving probability-scale plot data...
[SAVED] plots/step05_piecewise_probability_data.csv (12 rows)

[VALIDATION] Running validation checks...
[PASS] Theta plot data has exactly 12 rows
[PASS] Probability plot data has exactly 12 rows
[PASS] All domains present: {what, where, when}
[PASS] Theta range valid: [-0.478, 0.685]
[PASS] Probability range valid: [0.390, 0.656]
[PASS] Theta CI structure valid: CI_lower < mean < CI_upper
[PASS] Probability CI structure valid: CI_lower < mean < CI_upper
[PASS] No NaN values in output data

[FAIL] Validation failed with errors:
       - Test mismatch: expected {0, 1, 3, 6}, got {np.int64(1), np.int64(2), np.int64(3), np.int64(4)}
       - Segment assignment wrong: Early=[1 2], Late=[3 4]
[ERROR] Validation failed: Test mismatch: expected {0, 1, 3, 6}, got {np.int64(1), np.int64(2), np.int64(3), np.int64(4)}
[TRACEBACK] Full error details:
Traceback (most recent call last):
  File "/home/etai/projects/REMEMVR/results/ch5/rq2/code/step05_prepare_piecewise_plot_data.py", line 421, in <module>
    raise ValueError(f"Validation failed: {validation_errors[0]}")
ValueError: Validation failed: Test mismatch: expected {0, 1, 3, 6}, got {np.int64(1), np.int64(2), np.int64(3), np.int64(4)}
[START] Step 05: Prepare Piecewise Trajectory Plot Data
============================================================
[LOAD] Loading input data...
[LOADED] step00_piecewise_lmm_input.csv (1200 rows, 8 cols)
         Columns: ['composite_ID', 'UID', 'test', 'TSVR_hours', 'domain', 'theta', 'Segment', 'Days_within']
[LOADED] step01_piecewise_lmm_model.pkl (MixedLMResults object)
[LOADED] RQ 5.1 step03_item_parameters.csv (70 items)
         Mean item discrimination (a): 0.9385

[ANALYSIS] Aggregating theta scores by domain, test, and Segment...
[DONE] Aggregated to 12 groups (domain x test combinations)

[ANALYSIS] Generating model predictions for trajectory lines...
[DONE] Generated 12 predictions

[SAVE] Saving theta-scale plot data...
[SAVED] plots/step05_piecewise_theta_data.csv (12 rows)
         Theta range: [-0.478, 0.685]

[ANALYSIS] Transforming theta to probability scale (Decision D069)...
         Using IRT 2PL: P = 1 / (1 + exp(-(a * (theta - b))))
         a = 0.9385 (mean discrimination)
         b = 0.0 (reference difficulty)
[DONE] Transformed 12 rows to probability scale
         Probability range: [0.390, 0.656]

[SAVE] Saving probability-scale plot data...
[SAVED] plots/step05_piecewise_probability_data.csv (12 rows)

[VALIDATION] Running validation checks...
[PASS] Theta plot data has exactly 12 rows
[PASS] Probability plot data has exactly 12 rows
[PASS] All domains present: {what, where, when}
[PASS] All tests present: {1, 2, 3, 4}
[PASS] Segment assignment correct: T1,T2 -> 'Early'; T3,T4 -> 'Late'
[PASS] Theta range valid: [-0.478, 0.685]
[PASS] Probability range valid: [0.390, 0.656]
[PASS] Theta CI structure valid: CI_lower < mean < CI_upper
[PASS] Probability CI structure valid: CI_lower < mean < CI_upper
[PASS] No NaN values in output data

[SUCCESS] All validation checks passed!

============================================================
[SUMMARY] Step 05 Complete
============================================================
Outputs:
  - plots/step05_piecewise_theta_data.csv (12 rows)
  - plots/step05_piecewise_probability_data.csv (12 rows)

Decision D069 Implementation:
  - Theta scale: For psychometricians and statistical rigor
  - Probability scale: For general audience interpretability
  - Transformation: IRT 2PL with a=0.9385, b=0

[SUCCESS] Step 05 complete
