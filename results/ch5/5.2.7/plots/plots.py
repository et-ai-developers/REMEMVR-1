#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.2.7 - Domain-Based Clustering

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-03
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code)
- This script ONLY reads CSVs and calls plotting functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. cluster_scatter_matrix.png - 4x4 scatter plot matrix with cluster coloring
"""

from pathlib import Path
import sys
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# Add project root to path for tools import
RQ_ROOT = Path(__file__).parent.parent
PROJECT_ROOT = RQ_ROOT.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.2.7...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: SCATTER PLOT MATRIX (4x4)
# =============================================================================

print("\nGenerating Plot 1: Cluster scatter plot matrix...")

# Load plot source CSV (created by analysis pipeline Step 6)
df_plot = pd.read_csv(RQ_ROOT / "data" / "step06_scatter_plot_matrix_data.csv")
print(f"  Loaded {len(df_plot)} rows from step06_scatter_plot_matrix_data.csv")
print(f"  Columns: {list(df_plot.columns)}")

# Separate participants from centroids
df_participants = df_plot[df_plot['point_type'] == 'participant'].copy()
df_centroids = df_plot[df_plot['point_type'] == 'centroid'].copy()

print(f"  Participants: {len(df_participants)}, Centroids: {len(df_centroids)}")

# Extract clustering variables (4 z-scored variables)
clustering_vars = [
    'Total_Intercept_What_z',
    'Total_Slope_What_z',
    'Total_Intercept_Where_z',
    'Total_Slope_Where_z'
]

# Define axis labels (human-readable)
var_labels = {
    'Total_Intercept_What_z': 'What Baseline (z)',
    'Total_Slope_What_z': 'What Slope (z)',
    'Total_Intercept_Where_z': 'Where Baseline (z)',
    'Total_Slope_Where_z': 'Where Slope (z)'
}

# Get unique clusters and assign colors
n_clusters = df_participants['cluster'].nunique()
clusters = sorted(df_participants['cluster'].unique())
print(f"  Number of clusters: {n_clusters}")
print(f"  Cluster IDs: {clusters}")

# Use tab10 colormap for cluster colors
cluster_colors = plt.cm.tab10.colors[:n_clusters]
cluster_palette = {cluster: cluster_colors[i] for i, cluster in enumerate(clusters)}

# Create cluster labels for legend (use cluster_label column)
cluster_labels_map = df_participants.groupby('cluster')['cluster_label'].first().to_dict()

# Create 4x4 figure
fig, axes = plt.subplots(4, 4, figsize=(14, 14))

print(f"  Creating 4x4 scatter plot matrix...")

# Plot each panel
for i, var_y in enumerate(clustering_vars):
    for j, var_x in enumerate(clustering_vars):
        ax = axes[i, j]

        if i == j:
            # DIAGONAL: Histogram (distribution of single variable)
            for cluster in clusters:
                cluster_data = df_participants[df_participants['cluster'] == cluster][var_x]
                ax.hist(cluster_data, bins=15, alpha=0.5,
                       color=cluster_palette[cluster],
                       label=cluster_labels_map[cluster] if i == 0 else None,
                       edgecolor='black', linewidth=0.5)

            ax.set_ylabel('Frequency', fontsize=9)
            ax.set_xlabel(var_labels[var_x], fontsize=9)
            ax.axvline(x=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.6)
            ax.grid(True, alpha=0.2)

        else:
            # OFF-DIAGONAL: Scatter plot (pairwise relationships)
            for cluster in clusters:
                cluster_data = df_participants[df_participants['cluster'] == cluster]
                ax.scatter(cluster_data[var_x], cluster_data[var_y],
                          color=cluster_palette[cluster],
                          alpha=0.6, s=30, edgecolors='white', linewidth=0.5,
                          label=cluster_labels_map[cluster] if (i == 0 and j == 1) else None)

            # Plot centroids with larger markers (X symbols)
            for cluster in clusters:
                centroid_data = df_centroids[df_centroids['cluster'] == cluster]
                if len(centroid_data) > 0:
                    ax.scatter(centroid_data[var_x], centroid_data[var_y],
                             color=cluster_palette[cluster],
                             marker='X', s=200, edgecolors='black', linewidth=2,
                             zorder=10)

            # Reference lines at z=0 (grand mean)
            ax.axhline(y=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.6)
            ax.axvline(x=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.6)

            ax.set_xlabel(var_labels[var_x], fontsize=9)
            ax.set_ylabel(var_labels[var_y], fontsize=9)
            ax.grid(True, alpha=0.2)

        # Tick formatting
        ax.tick_params(labelsize=8)

# Add legend (top-right panel)
# Use a dedicated legend panel or add to upper right scatter plot
legend_ax = axes[0, 3]
handles, labels = [], []
for cluster in clusters:
    # Create legend entry for each cluster
    from matplotlib.patches import Patch
    handles.append(Patch(color=cluster_palette[cluster], label=f"C{cluster}: {cluster_labels_map[cluster]}"))

# Add centroid marker to legend
from matplotlib.lines import Line2D
handles.append(Line2D([0], [0], marker='X', color='w', markerfacecolor='gray',
                     markersize=12, markeredgecolor='black', markeredgewidth=1.5,
                     label='Centroids', linestyle='None'))

legend_ax.legend(handles=handles, loc='center', fontsize=8, frameon=True,
                title='Clusters', title_fontsize=9)
legend_ax.axis('off')

# Super title
fig.suptitle('RQ 5.2.7: Domain-Based Clustering - Scatter Plot Matrix',
            fontweight='bold', fontsize=14, y=0.995)

plt.tight_layout(rect=[0, 0, 1, 0.99])

# Save plot
output_path = RQ_ROOT / "plots" / "cluster_scatter_matrix.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')

print(f"  âœ“ Saved: plots/cluster_scatter_matrix.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/cluster_scatter_matrix.png (4x4 scatter matrix)")
print(f"\nClusters visualized: {n_clusters}")
for cluster in clusters:
    n_members = len(df_participants[df_participants['cluster'] == cluster])
    print(f"  - Cluster {cluster}: {cluster_labels_map[cluster]} (n={n_members})")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
