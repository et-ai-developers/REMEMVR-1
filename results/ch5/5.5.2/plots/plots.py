#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.5.2 - Source-Destination Consolidation (Two-Phase)

GENERATED BY: rq_plots agent (v4.0.1)
DATE: 2025-12-04
PURPOSE: Create publication-ready piecewise trajectory plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code Step 7)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. piecewise_theta.png - Theta-scale piecewise trajectory (2 panels: Early vs Late)
2. piecewise_probability.png - Probability-scale piecewise trajectory (Decision D069)

DECISION D069 COMPLIANCE:
- Dual-scale trajectory plotting MANDATORY for LMM trajectory RQs
- Theta scale: Statistical rigor, psychometrician-interpretable
- Probability scale: General audience interpretable, reviewer-friendly
"""

from pathlib import Path
import sys

# Add project root to path for tools imports
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
from tools.plotting import (
    set_plot_style_defaults,
    plot_piecewise_trajectory
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.5.2/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("=" * 70)
print("PLOTTING RQ 5.5.2: Source-Destination Consolidation (Two-Phase)")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")
print()

# =============================================================================
# LOAD PLOT DATA (created by g_code Step 7)
# =============================================================================

print("Loading plot source CSVs...")

# Theta-scale data (created by step07_prepare_plot_data.py)
theta_csv = RQ_ROOT / "data" / "step07_piecewise_theta_data.csv"
df_theta = pd.read_csv(theta_csv)
print(f"  Loaded theta data: {len(df_theta)} rows from {theta_csv.name}")
print(f"  Columns: {list(df_theta.columns)}")
print(f"  Segments: {df_theta['Segment'].unique()}")
print(f"  LocationTypes: {df_theta['LocationType'].unique()}")
print(f"  Data_Type: {df_theta['Data_Type'].unique()}")

# Probability-scale data (Decision D069 dual-scale requirement)
prob_csv = RQ_ROOT / "data" / "step07_piecewise_probability_data.csv"
df_prob = pd.read_csv(prob_csv)
print(f"  Loaded probability data: {len(df_prob)} rows from {prob_csv.name}")
print()

# =============================================================================
# RENAME COLUMNS FOR PLOTTING FUNCTION
# =============================================================================

# plot_piecewise_trajectory expects specific column names
# Rename to match function signature:
# - 'LocationType' -> paradigm_col parameter (factor grouping)
# - 'Days_within' -> time_col parameter
# - 'theta' -> theta_obs_col / theta_pred_col
# - 'Data_Type' -> data_type_col

# For theta data
df_theta_plot = df_theta.rename(columns={
    'theta': 'theta_value',
    'Data_Type': 'data_type'
})

# Create separate observed and predicted columns
df_theta_plot['theta_observed'] = df_theta_plot.apply(
    lambda row: row['theta_value'] if row['data_type'] == 'observed' else np.nan,
    axis=1
)
df_theta_plot['theta_predicted'] = df_theta_plot.apply(
    lambda row: row['theta_value'] if row['data_type'] == 'predicted' else np.nan,
    axis=1
)

# For probability data
df_prob_plot = df_prob.rename(columns={
    'theta': 'prob_value',  # Already probability-transformed
    'Data_Type': 'data_type'
})

# Create separate observed and predicted columns
df_prob_plot['prob_observed'] = df_prob_plot.apply(
    lambda row: row['prob_value'] if row['data_type'] == 'observed' else np.nan,
    axis=1
)
df_prob_plot['prob_predicted'] = df_prob_plot.apply(
    lambda row: row['prob_value'] if row['data_type'] == 'predicted' else np.nan,
    axis=1
)

print("Data prepared for plotting:")
print(f"  Theta data: {len(df_theta_plot)} rows")
print(f"  Probability data: {len(df_prob_plot)} rows")
print()

# =============================================================================
# PLOT 1+2: DUAL-SCALE PIECEWISE TRAJECTORY (Decision D069)
# =============================================================================

print("Generating dual-scale piecewise trajectory plots (Decision D069)...")
print()

# Color scheme for Source vs Destination
location_colors = {
    'Source': '#E74C3C',      # Red - pick-up location (-U-)
    'Destination': '#3498DB'  # Blue - put-down location (-D-)
}

# Generate dual-scale plot (2x2 grid: theta-scale top row, probability-scale bottom row)
fig, axes = plot_piecewise_trajectory(
    theta_data=df_theta_plot,
    prob_data=df_prob_plot,
    segment_col='Segment',
    paradigm_col='LocationType',
    time_col='Days_within',
    theta_obs_col='theta_observed',
    theta_pred_col='theta_predicted',
    prob_obs_col='prob_observed',
    prob_pred_col='prob_predicted',
    ci_lower_col='CI_lower',
    ci_upper_col='CI_upper',
    slope_col='theta_value',  # Not used for slope annotation in this RQ
    data_type_col='data_type',
    segment_order=['Early', 'Late'],
    paradigm_colors=location_colors,
    figsize=(14, 10),  # Larger for 2x2 grid
    output_path=RQ_ROOT / "plots" / "piecewise_dual_scale.png",
    suptitle='RQ 5.5.2: Source-Destination Consolidation (Two-Phase)'
)

print(f"  [PASS] Saved: plots/piecewise_dual_scale.png")
print(f"  [PASS] 2x2 grid: Theta-scale (top row) + Probability-scale (bottom row)")
print(f"  [PASS] Decision D069 compliance: BOTH scales included")
print()

# =============================================================================
# INDIVIDUAL SCALE PLOTS (optional, for separate use)
# =============================================================================

print("Generating individual scale plots...")
print()

# Theta-scale only (1x2 grid: Early and Late panels)
fig_theta, axes_theta = plot_piecewise_trajectory(
    theta_data=df_theta_plot,
    prob_data=None,  # Theta-scale only
    segment_col='Segment',
    paradigm_col='LocationType',
    time_col='Days_within',
    theta_obs_col='theta_observed',
    theta_pred_col='theta_predicted',
    ci_lower_col='CI_lower',
    ci_upper_col='CI_upper',
    slope_col='theta_value',
    data_type_col='data_type',
    segment_order=['Early', 'Late'],
    paradigm_colors=location_colors,
    figsize=(14, 6),
    output_path=RQ_ROOT / "plots" / "piecewise_theta.png",
    title='Piecewise Trajectory (Theta Scale)',
    suptitle='RQ 5.5.2: Source-Destination Consolidation - Theta Scale'
)

print(f"  [PASS] Saved: plots/piecewise_theta.png (theta-scale only)")
print()

# Probability-scale only (1x2 grid: Early and Late panels)
# Need to create probability-only DataFrame with theta column structure
df_prob_theta_format = df_prob_plot.rename(columns={
    'prob_observed': 'theta_observed',
    'prob_predicted': 'theta_predicted'
})

fig_prob, axes_prob = plot_piecewise_trajectory(
    theta_data=df_prob_theta_format,
    prob_data=None,  # Using theta columns but with probability values
    segment_col='Segment',
    paradigm_col='LocationType',
    time_col='Days_within',
    theta_obs_col='theta_observed',  # Contains probability values
    theta_pred_col='theta_predicted',  # Contains probability values
    ci_lower_col='CI_lower',
    ci_upper_col='CI_upper',
    slope_col='prob_value',
    data_type_col='data_type',
    segment_order=['Early', 'Late'],
    paradigm_colors=location_colors,
    figsize=(14, 6),
    output_path=RQ_ROOT / "plots" / "piecewise_probability.png",
    title='Piecewise Trajectory (Probability Scale)',
    suptitle='RQ 5.5.2: Source-Destination Consolidation - Probability Scale'
)

print(f"  [PASS] Saved: plots/piecewise_probability.png (probability-scale only)")
print()

# =============================================================================
# SUMMARY
# =============================================================================

print("=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 3")
print(f"  - plots/piecewise_dual_scale.png (2x2 grid, Decision D069 compliant)")
print(f"  - plots/piecewise_theta.png (theta-scale only)")
print(f"  - plots/piecewise_probability.png (probability-scale only)")
print()
print("Decision D069 Compliance: [PASS]")
print("  - Dual-scale trajectory plotting implemented")
print("  - BOTH theta AND probability scales included in piecewise_dual_scale.png")
print("  - Theta scale: Statistical rigor for technical audience")
print("  - Probability scale: Interpretability for general audience")
print()
print("All plots saved with 300 DPI publication quality.")
print("=" * 70)
