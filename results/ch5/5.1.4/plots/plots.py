#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.1.4 - Between-Person Variance in Forgetting Rates

GENERATED BY: rq_plots agent (v4.0.0) - UPDATED 2025-12-09
DATE: 2025-12-09
PURPOSE: Create publication-ready plots for BOTH original (Lin+Log) AND model-averaged variance decomposition

ARCHITECTURE:
- Original results (Steps 1-5): Single Lin+Log model from RQ 5.1.1
- NEW results (Step 6): Model-averaged variance decomposition across 10 competitive power law models
- This script plots BOTH sets of results for comprehensive comparison

PLOTS GENERATED:
1. step05_random_slopes_histogram.png - Already created during Step 5 (diagnostic)
2. step05_random_slopes_qqplot.png - Already created during Step 5 (diagnostic)
3. model_comparison.png - NEW: AIC comparison across 65 models tested
4. icc_comparison.png - NEW: Original vs model-averaged ICC estimates
5. random_effects_distribution.png - NEW: Model-averaged slope distribution
6. variance_comparison.png - NEW: Original vs model-averaged variance components
"""

from pathlib import Path
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from tools.plotting import (
    set_plot_style_defaults,
    plot_histogram_by_group,
    plot_comparison_bars
)

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.1.4/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("=" * 80)
print("PLOTTING FOR RQ 5.1.4: BETWEEN-PERSON VARIANCE IN FORGETTING RATES")
print("=" * 80)
print(f"RQ root: {RQ_ROOT}")
print()

# =============================================================================
# EXISTING DIAGNOSTIC PLOTS (from Step 5)
# =============================================================================

print("\n" + "=" * 80)
print("EXISTING DIAGNOSTIC PLOTS (Step 5)")
print("=" * 80)

histogram_path = RQ_ROOT / "plots" / "step05_random_slopes_histogram.png"
qqplot_path = RQ_ROOT / "plots" / "step05_random_slopes_qqplot.png"

if histogram_path.exists() and qqplot_path.exists():
    print("  [PASS] step05_random_slopes_histogram.png exists")
    print("  [PASS] step05_random_slopes_qqplot.png exists")
    print("\nThese plots were generated during Step 5 (correlation test).")
    print("No regeneration needed.")
else:
    print("  [FAIL] Diagnostic plots missing!")
    if not histogram_path.exists():
        print(f"    Missing: {histogram_path}")
    if not qqplot_path.exists():
        print(f"    Missing: {qqplot_path}")

# =============================================================================
# PLOT 1: MODEL COMPARISON (Step 6 - 65 models tested)
# =============================================================================

print("\n" + "=" * 80)
print("PLOT 1: MODEL COMPARISON (65 Models Tested)")
print("=" * 80)

# Load model comparison data
df_models = pd.read_csv(RQ_ROOT / "data" / "step06_model_comparison.csv")
print(f"  Loaded {len(df_models)} models from step06_model_comparison.csv")

# Filter to top 20 models for visibility
df_models_top20 = df_models.head(20).copy()
print(f"  Plotting top 20 models (ΔAIC range: 0 to {df_models_top20['delta_AIC'].iloc[-1]:.2f})")

# Create figure
fig, ax = plt.subplots(figsize=(12, 8))

# Plot bars
x_pos = np.arange(len(df_models_top20))
bars = ax.bar(x_pos, df_models_top20['delta_AIC'],
              color=['#2ECC71' if d < 2.0 else '#E74C3C' for d in df_models_top20['delta_AIC']],
              alpha=0.7, edgecolor='black', linewidth=1.2)

# Add ΔAIC < 2.0 threshold line (competitive models)
ax.axhline(y=2.0, color='black', linestyle='--', linewidth=2,
           label='ΔAIC = 2.0 (Competitive Threshold)')

# Styling
ax.set_xlabel('Model', fontsize=12, fontweight='bold')
ax.set_ylabel('ΔAIC (relative to best model)', fontsize=12, fontweight='bold')
ax.set_title('RQ 5.1.4: Model Comparison (Top 20 of 65 Models Tested)',
             fontsize=14, fontweight='bold', pad=20)
ax.set_xticks(x_pos)
ax.set_xticklabels(df_models_top20['model_name'], rotation=45, ha='right')
ax.legend(loc='upper left', fontsize=10)
ax.grid(axis='y', alpha=0.3)

# Annotate competitive models count
n_competitive = (df_models['delta_AIC'] < 2.0).sum()
ax.text(0.98, 0.95, f'{n_competitive} competitive models\n(ΔAIC < 2.0)',
        transform=ax.transAxes, fontsize=11,
        verticalalignment='top', horizontalalignment='right',
        bbox=dict(boxstyle='round', facecolor='white', alpha=0.8))

plt.tight_layout()
output_path = RQ_ROOT / "plots" / "model_comparison.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  [SAVED] {output_path}")
plt.close()

# =============================================================================
# PLOT 2: ICC COMPARISON (Original vs Model-Averaged)
# =============================================================================

print("\n" + "=" * 80)
print("PLOT 2: ICC COMPARISON (Original vs Model-Averaged)")
print("=" * 80)

# Load ICC data
df_icc_orig = pd.read_csv(RQ_ROOT / "data" / "step03_icc_estimates.csv")
df_icc_avg = pd.read_csv(RQ_ROOT / "data" / "step06_averaged_iccs.csv")

print(f"  Loaded original ICCs: {len(df_icc_orig)} estimates")
print(f"  Loaded model-averaged ICCs: {len(df_icc_avg)} estimates")

# Prepare comparison data
icc_comparison = pd.DataFrame({
    'ICC_Type': ['Intercept', 'Slope (Simple)', 'Slope (Conditional)'],
    'Original_LinLog': [
        df_icc_orig[df_icc_orig['icc_type'] == 'intercept']['icc_value'].iloc[0],
        df_icc_orig[df_icc_orig['icc_type'] == 'slope_simple']['icc_value'].iloc[0],
        df_icc_orig[df_icc_orig['icc_type'] == 'slope_conditional']['icc_value'].iloc[0]
    ],
    'ModelAveraged_PowerLaw': [
        df_icc_avg['ICC_intercept'].iloc[0],
        df_icc_avg['ICC_slope_simple'].iloc[0],
        df_icc_avg['ICC_slope_conditional'].iloc[0]
    ]
})

print("\n  ICC Comparison Table:")
print(icc_comparison.to_string(index=False))

# Reshape for plotting
icc_plot_data = pd.melt(
    icc_comparison,
    id_vars=['ICC_Type'],
    var_name='Model',
    value_name='ICC'
)

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Plot grouped bars
x_labels = icc_plot_data['ICC_Type'].unique()
x_pos = np.arange(len(x_labels))
width = 0.35

# Original (Lin+Log) bars
orig_vals = icc_comparison['Original_LinLog'].values
bars1 = ax.bar(x_pos - width/2, orig_vals, width,
               label='Original (Lin+Log)', color='#3498DB', alpha=0.7, edgecolor='black')

# Model-averaged bars
avg_vals = icc_comparison['ModelAveraged_PowerLaw'].values
bars2 = ax.bar(x_pos + width/2, avg_vals, width,
               label='Model-Averaged (10 Power Law Models)', color='#E74C3C', alpha=0.7, edgecolor='black')

# Add value labels on bars
for bars in [bars1, bars2]:
    for bar in bars:
        height = bar.get_height()
        ax.text(bar.get_x() + bar.get_width()/2., height,
                f'{height:.3f}',
                ha='center', va='bottom', fontsize=9)

# Styling
ax.set_xlabel('ICC Type', fontsize=12, fontweight='bold')
ax.set_ylabel('Intraclass Correlation Coefficient', fontsize=12, fontweight='bold')
ax.set_title('RQ 5.1.4: ICC Comparison - Original vs Model-Averaged',
             fontsize=14, fontweight='bold', pad=20)
ax.set_xticks(x_pos)
ax.set_xticklabels(x_labels)
ax.legend(loc='upper right', fontsize=10)
ax.set_ylim([0, 1.0])
ax.grid(axis='y', alpha=0.3)

# Add interpretation threshold line (ICC = 0.40)
ax.axhline(y=0.40, color='gray', linestyle=':', linewidth=1.5,
           label='Substantial Threshold (0.40)')

plt.tight_layout()
output_path = RQ_ROOT / "plots" / "icc_comparison.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"\n  [SAVED] {output_path}")
plt.close()

# =============================================================================
# PLOT 3: RANDOM EFFECTS DISTRIBUTION (Model-Averaged Slopes)
# =============================================================================

print("\n" + "=" * 80)
print("PLOT 3: RANDOM EFFECTS DISTRIBUTION (Model-Averaged)")
print("=" * 80)

# Load model-averaged random effects
df_re_avg = pd.read_csv(RQ_ROOT / "data" / "step06_averaged_random_effects.csv")
print(f"  Loaded {len(df_re_avg)} participants from step06_averaged_random_effects.csv")

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Plot histogram with KDE
ax.hist(df_re_avg['slope_avg'], bins=25, color='#2ECC71', alpha=0.6,
        edgecolor='black', density=True, label='Model-Averaged Slopes')

# Add KDE overlay
from scipy.stats import gaussian_kde
kde = gaussian_kde(df_re_avg['slope_avg'])
x_range = np.linspace(df_re_avg['slope_avg'].min(), df_re_avg['slope_avg'].max(), 200)
ax.plot(x_range, kde(x_range), color='#E74C3C', linewidth=2.5, label='KDE')

# Add mean reference line
mean_slope = df_re_avg['slope_avg'].mean()
ax.axvline(x=mean_slope, color='black', linestyle='--', linewidth=2,
           label=f'Mean = {mean_slope:.4f}')

# Styling
ax.set_xlabel('Model-Averaged Random Slope (forgetting rate)', fontsize=12, fontweight='bold')
ax.set_ylabel('Density', fontsize=12, fontweight='bold')
ax.set_title('RQ 5.1.4: Distribution of Model-Averaged Random Slopes (N=100)',
             fontsize=14, fontweight='bold', pad=20)
ax.legend(loc='upper right', fontsize=10)
ax.grid(axis='y', alpha=0.3)

# Add descriptive stats
stats_text = f'Mean: {df_re_avg["slope_avg"].mean():.4f}\nSD: {df_re_avg["slope_avg"].std():.4f}\nRange: [{df_re_avg["slope_avg"].min():.4f}, {df_re_avg["slope_avg"].max():.4f}]'
ax.text(0.02, 0.98, stats_text, transform=ax.transAxes,
        fontsize=10, verticalalignment='top',
        bbox=dict(boxstyle='round', facecolor='white', alpha=0.8))

plt.tight_layout()
output_path = RQ_ROOT / "plots" / "random_effects_distribution.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  [SAVED] {output_path}")
plt.close()

# =============================================================================
# PLOT 4: VARIANCE COMPONENTS COMPARISON (Original vs Model-Averaged)
# =============================================================================

print("\n" + "=" * 80)
print("PLOT 4: VARIANCE COMPONENTS COMPARISON")
print("=" * 80)

# Load variance data
df_var_orig = pd.read_csv(RQ_ROOT / "data" / "step02_variance_components.csv")
df_var_avg = pd.read_csv(RQ_ROOT / "data" / "step06_averaged_variance_components.csv")

print(f"  Loaded original variance components: {len(df_var_orig)} components")
print(f"  Loaded model-averaged variance components: {len(df_var_avg)} components")

# Prepare comparison data (focus on key variance components)
var_comparison = pd.DataFrame({
    'Component': ['var_intercept', 'var_slope', 'var_residual'],
    'Original_LinLog': [
        df_var_orig[df_var_orig['component'] == 'var_intercept']['estimate'].iloc[0],
        df_var_orig[df_var_orig['component'] == 'var_slope']['estimate'].iloc[0],
        df_var_orig[df_var_orig['component'] == 'var_residual']['estimate'].iloc[0]
    ],
    'ModelAveraged_PowerLaw': [
        df_var_avg['var_intercept'].iloc[0],
        df_var_avg['var_slope'].iloc[0],
        df_var_avg['var_residual'].iloc[0]
    ]
})

print("\n  Variance Components Comparison Table:")
print(var_comparison.to_string(index=False))

# Calculate fold-change for var_slope (primary interest)
slope_orig = var_comparison[var_comparison['Component'] == 'var_slope']['Original_LinLog'].iloc[0]
slope_avg = var_comparison[var_comparison['Component'] == 'var_slope']['ModelAveraged_PowerLaw'].iloc[0]
fold_change = slope_avg / slope_orig
print(f"\n  var_slope fold-change: {fold_change:.1f}x (model-averaged / original)")

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Plot grouped bars
x_labels = ['Intercept Variance', 'Slope Variance', 'Residual Variance']
x_pos = np.arange(len(x_labels))
width = 0.35

# Original bars
orig_vals = var_comparison['Original_LinLog'].values
bars1 = ax.bar(x_pos - width/2, orig_vals, width,
               label='Original (Lin+Log)', color='#3498DB', alpha=0.7, edgecolor='black')

# Model-averaged bars
avg_vals = var_comparison['ModelAveraged_PowerLaw'].values
bars2 = ax.bar(x_pos + width/2, avg_vals, width,
               label='Model-Averaged (10 Power Law Models)', color='#E74C3C', alpha=0.7, edgecolor='black')

# Add value labels on bars
for bars in [bars1, bars2]:
    for bar in bars:
        height = bar.get_height()
        ax.text(bar.get_x() + bar.get_width()/2., height,
                f'{height:.4f}',
                ha='center', va='bottom', fontsize=9, rotation=0)

# Styling
ax.set_xlabel('Variance Component', fontsize=12, fontweight='bold')
ax.set_ylabel('Variance Estimate', fontsize=12, fontweight='bold')
ax.set_title('RQ 5.1.4: Variance Components - Original vs Model-Averaged',
             fontsize=14, fontweight='bold', pad=20)
ax.set_xticks(x_pos)
ax.set_xticklabels(x_labels)
ax.legend(loc='upper right', fontsize=10)
ax.grid(axis='y', alpha=0.3)

# Annotate fold-change for var_slope
ax.text(1, max(orig_vals[1], avg_vals[1]) * 1.15,
        f'{fold_change:.1f}x increase\n(model-averaged)',
        ha='center', fontsize=10,
        bbox=dict(boxstyle='round', facecolor='yellow', alpha=0.5))

plt.tight_layout()
output_path = RQ_ROOT / "plots" / "variance_comparison.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  [SAVED] {output_path}")
plt.close()

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 80)
print("PLOTTING COMPLETE")
print("=" * 80)
print("\nTotal plots: 6")
print("  - 2 diagnostic plots (Step 5, pre-existing):")
print("      step05_random_slopes_histogram.png")
print("      step05_random_slopes_qqplot.png")
print("\n  - 4 NEW comparison plots (Step 6 model-averaged results):")
print("      model_comparison.png (65 models, ΔAIC threshold)")
print("      icc_comparison.png (original vs model-averaged ICCs)")
print("      random_effects_distribution.png (model-averaged slopes)")
print("      variance_comparison.png (original vs model-averaged components)")
print("\nAll plots saved with 300 DPI publication quality.")
print("=" * 80)
