#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.1.5 - Individual Clustering

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-02
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. cluster_scatter.png - Scatter plot showing participants colored by cluster with centers marked
"""

from pathlib import Path
import sys

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import yaml
from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.1.5/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.1.5 (Individual Clustering)...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: CLUSTER SCATTER PLOT
# =============================================================================

print("\nGenerating Plot 1: Cluster scatter plot...")

# Load plot source CSVs (created by analysis pipeline)
df_data = pd.read_csv(RQ_ROOT / "data" / "step07_scatter_plot_data.csv")
df_centers = pd.read_csv(RQ_ROOT / "data" / "step07_scatter_plot_centers.csv")

print(f"  Loaded {len(df_data)} participants from scatter_plot_data.csv")
print(f"  Columns: {list(df_data.columns)}")
print(f"  Loaded {len(df_centers)} cluster centers from scatter_plot_centers.csv")

# Load metadata for plot annotations
with open(RQ_ROOT / "data" / "step07_scatter_plot_metadata.yaml", 'r') as f:
    metadata = yaml.safe_load(f)

silhouette = metadata['silhouette_score']
K_final = metadata['K_final']
xlabel = metadata['axis_labels']['x']
ylabel = metadata['axis_labels']['y']

print(f"  Metadata: K={K_final}, Silhouette={silhouette:.3f}")

# Define cluster colors (2 clusters expected)
cluster_colors = {
    0: '#E74C3C',  # Red-ish
    1: '#3498DB'   # Blue-ish
}

# Create figure
fig, ax = plt.subplots(figsize=(10, 8))

# Plot participants colored by cluster
for cluster_id in sorted(df_data['cluster'].unique()):
    cluster_data = df_data[df_data['cluster'] == cluster_id]
    n_participants = len(cluster_data)

    ax.scatter(
        cluster_data['Intercept_z'],
        cluster_data['Slope_z'],
        c=cluster_colors.get(cluster_id, 'gray'),
        s=50,
        alpha=0.6,
        label=f'Cluster {cluster_id} (n={n_participants})',
        edgecolors='black',
        linewidths=0.5
    )

# Plot cluster centers with larger markers
for _, row in df_centers.iterrows():
    cluster_id = row['cluster']
    ax.scatter(
        row['Intercept_z_center'],
        row['Slope_z_center'],
        c=cluster_colors.get(cluster_id, 'gray'),
        s=400,
        marker='*',
        edgecolors='black',
        linewidths=2,
        alpha=1.0,
        zorder=10  # Ensure centers appear on top
    )

# Add reference lines at x=0 and y=0 (mean due to z-standardization)
ax.axhline(y=0, color='gray', linestyle='--', linewidth=1, alpha=0.5, zorder=0)
ax.axvline(x=0, color='gray', linestyle='--', linewidth=1, alpha=0.5, zorder=0)

# Add silhouette score annotation
silhouette_interpretation = metadata['interpretation']['silhouette']
annotation_text = f"Silhouette = {silhouette:.3f}\n({silhouette_interpretation} structure)"
ax.text(
    0.02, 0.98, annotation_text,
    transform=ax.transAxes,
    fontsize=10,
    verticalalignment='top',
    bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5)
)

# Formatting
ax.set_xlabel(xlabel, fontweight='bold', fontsize=12)
ax.set_ylabel(ylabel, fontweight='bold', fontsize=12)
ax.set_title(f'RQ 5.1.5: Cluster Assignments (K={K_final})', fontweight='bold', fontsize=14, pad=15)
ax.legend(loc='lower right', framealpha=0.95, fontsize=10)
ax.grid(True, alpha=0.3)

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "cluster_scatter.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')

print(f"  âœ“ Saved: plots/cluster_scatter.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/cluster_scatter.png")
print(f"\nCluster information:")
print(f"  - K_final: {K_final}")
print(f"  - Silhouette: {silhouette:.3f} ({silhouette_interpretation})")
print(f"  - Participants: {len(df_data)} total")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
