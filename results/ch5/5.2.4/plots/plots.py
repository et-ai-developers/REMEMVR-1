#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.2.4 - IRT-CTT Convergent Validity

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-02
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

CRITICAL CONTEXT: When domain EXCLUDED. Only 2 domains (What, Where) in analysis.

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code)
- This script ONLY reads CSVs and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. scatterplot_irt_ctt.png - IRT vs CTT scatterplot by domain with regression lines
2. trajectory_comparison.png - IRT vs CTT trajectories over time by domain
"""

from pathlib import Path
import sys

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from scipy import stats

from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.2.4/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.2.4...")
print(f"RQ root: {RQ_ROOT}")
print("CRITICAL: When domain EXCLUDED - Only 2 domains (What, Where)")

# Define colors for domains (from config/plotting.yaml)
DOMAIN_COLORS = {
    'What': '#E74C3C',   # Red
    'Where': '#3498DB',  # Blue
    'what': '#E74C3C',   # Lowercase variant
    'where': '#3498DB'
}

# =============================================================================
# PLOT 1: IRT vs CTT SCATTERPLOT BY DOMAIN
# =============================================================================

print("\nGenerating Plot 1: IRT vs CTT Scatterplot...")

# Load plot source CSV (created by analysis pipeline step07)
df_scatter = pd.read_csv(RQ_ROOT / "data" / "step07_scatterplot_data.csv")
print(f"  Loaded {len(df_scatter)} rows from step07_scatterplot_data.csv")
print(f"  Columns: {list(df_scatter.columns)}")
print(f"  Domains: {df_scatter['domain'].unique()}")

# Create figure with 2 subplots (one per domain)
fig, axes = plt.subplots(1, 2, figsize=(14, 6))

domains = df_scatter['domain'].unique()
print(f"  Creating {len(domains)} domain panels: {domains}")

for idx, domain in enumerate(sorted(domains)):
    ax = axes[idx]

    # Filter data for this domain
    domain_data = df_scatter[df_scatter['domain'] == domain]

    # Get color for this domain
    color = DOMAIN_COLORS.get(domain, '#333333')

    # Extract data
    x = domain_data['IRT_score'].values
    y = domain_data['CTT_score'].values
    r = domain_data['r'].iloc[0]  # Correlation coefficient (same for all rows in domain)

    # Scatter plot
    ax.scatter(x, y, alpha=0.5, s=50, color=color, edgecolors='white', linewidth=0.5)

    # Regression line
    slope, intercept, r_value, p_value, std_err = stats.linregress(x, y)
    x_line = np.linspace(x.min(), x.max(), 100)
    y_line = slope * x_line + intercept
    ax.plot(x_line, y_line, color=color, linewidth=2.5, alpha=0.9,
            label=f'r = {r:.3f}')

    # Formatting
    domain_title = domain.capitalize() if isinstance(domain, str) else domain
    ax.set_xlabel('IRT Theta Score', fontweight='bold')
    ax.set_ylabel('CTT Mean Score', fontweight='bold')
    ax.set_title(f'{domain_title} Domain', fontweight='bold', pad=15)
    ax.legend(loc='lower right', framealpha=0.95, fontsize=11)
    ax.grid(True, alpha=0.3)

    # Add reference line (y=x transformed to match scales)
    # Note: IRT unbounded, CTT [0,1], so no direct y=x line

    print(f"  Panel {idx+1}: {domain_title} domain - n={len(domain_data)}, r={r:.3f}")

# Overall title
fig.suptitle('RQ 5.2.4: IRT-CTT Convergent Validity by Domain',
             fontweight='bold', fontsize=14, y=0.98)

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "scatterplot_irt_ctt.png"
output_path.parent.mkdir(parents=True, exist_ok=True)
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  [SUCCESS] Saved: plots/scatterplot_irt_ctt.png")

plt.close(fig)

# =============================================================================
# PLOT 2: IRT vs CTT TRAJECTORY COMPARISON BY DOMAIN
# =============================================================================

print("\nGenerating Plot 2: IRT vs CTT Trajectory Comparison...")

# Load plot source CSV (created by analysis pipeline step08)
df_traj = pd.read_csv(RQ_ROOT / "data" / "step08_trajectory_data.csv")
print(f"  Loaded {len(df_traj)} rows from step08_trajectory_data.csv")
print(f"  Columns: {list(df_traj.columns)}")
print(f"  Domains: {df_traj['domain'].unique()}")
print(f"  Models: {df_traj['model'].unique()}")

# Filter to only rows with n > 1 (aggregated data points, not individual observations)
# Based on inspection, n=100 for aggregated timepoints, n=1 for individual observations
df_traj_agg = df_traj[df_traj['n'] > 1].copy()
print(f"  Filtered to {len(df_traj_agg)} aggregated data points (n > 1)")

# Create figure with 2 subplots (one per domain)
fig, axes = plt.subplots(1, 2, figsize=(14, 6))

domains_traj = df_traj_agg['domain'].unique()
print(f"  Creating {len(domains_traj)} domain panels: {domains_traj}")

for idx, domain in enumerate(sorted(domains_traj)):
    ax = axes[idx]

    # Filter data for this domain
    domain_data = df_traj_agg[df_traj_agg['domain'] == domain]

    # Get color for this domain
    color = DOMAIN_COLORS.get(domain, '#333333')

    # Plot IRT trajectory
    irt_data = domain_data[domain_data['model'] == 'IRT'].sort_values('TSVR_hours')
    if len(irt_data) > 0:
        ax.plot(irt_data['TSVR_hours'], irt_data['mean_score'],
                'o-', color=color, linewidth=2.5, markersize=8,
                label='IRT Theta', alpha=0.9)

        # Error bars for IRT (if CI available)
        if not irt_data['CI_lower'].isna().all():
            ax.errorbar(irt_data['TSVR_hours'], irt_data['mean_score'],
                       yerr=[irt_data['mean_score'] - irt_data['CI_lower'],
                             irt_data['CI_upper'] - irt_data['mean_score']],
                       fmt='none', color=color, capsize=4, alpha=0.5)

    # Plot CTT trajectory (dashed line for distinction)
    ctt_data = domain_data[domain_data['model'] == 'CTT'].sort_values('TSVR_hours')
    if len(ctt_data) > 0:
        ax.plot(ctt_data['TSVR_hours'], ctt_data['mean_score'],
                's--', color=color, linewidth=2.5, markersize=7,
                label='CTT Mean', alpha=0.7)

        # Error bars for CTT (if CI available)
        if not ctt_data['CI_lower'].isna().all():
            ax.errorbar(ctt_data['TSVR_hours'], ctt_data['mean_score'],
                       yerr=[ctt_data['mean_score'] - ctt_data['CI_lower'],
                             ctt_data['CI_upper'] - ctt_data['mean_score']],
                       fmt='none', color=color, capsize=4, alpha=0.5, linestyle='--')

    # Formatting
    domain_title = domain.capitalize() if isinstance(domain, str) else domain
    ax.set_xlabel('Hours Since VR Encoding (TSVR)', fontweight='bold')
    ax.set_ylabel('Ability / Score', fontweight='bold')
    ax.set_title(f'{domain_title} Domain', fontweight='bold', pad=15)
    ax.legend(loc='upper right', framealpha=0.95)
    ax.grid(True, alpha=0.3)

    # Add dual y-axis note (IRT unbounded, CTT 0-1)
    ax.text(0.02, 0.02, 'Note: IRT theta (unbounded) vs CTT score [0,1]',
            transform=ax.transAxes, fontsize=8, style='italic',
            bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.3),
            verticalalignment='bottom')

    print(f"  Panel {idx+1}: {domain_title} domain - IRT n={len(irt_data)}, CTT n={len(ctt_data)}")

# Overall title
fig.suptitle('RQ 5.2.4: IRT vs CTT Trajectory Comparison by Domain',
             fontweight='bold', fontsize=14, y=0.98)

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "trajectory_comparison.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  [SUCCESS] Saved: plots/trajectory_comparison.png")

plt.close(fig)

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 2")
print(f"  - plots/scatterplot_irt_ctt.png (IRT vs CTT by domain)")
print(f"  - plots/trajectory_comparison.png (IRT vs CTT trajectories)")
print("\nAll plots saved with 300 DPI publication quality.")
print("CRITICAL: When domain EXCLUDED - Only 2 domains (What, Where)")
print("="*70)
