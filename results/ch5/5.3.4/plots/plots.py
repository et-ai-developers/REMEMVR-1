#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.3.4 - Age x Paradigm Interactions

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-02
PURPOSE: Create Age x Paradigm x Time interaction visualization from plot data

ARCHITECTURE:
- Plot source CSV created by analysis pipeline (Step 5)
- This script reads CSV and creates multi-panel trajectory plot
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. age_paradigm_trajectories.png - 3-panel plot (one per age tertile) showing
   paradigm-specific forgetting trajectories
"""

from pathlib import Path
import sys

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.3.4/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.3.4 - Age x Paradigm Interactions...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# LOAD PLOT DATA
# =============================================================================

print("\nLoading plot data...")

# Load plot source CSV (created by Step 5 of analysis pipeline)
df_plot = pd.read_csv(RQ_ROOT / "data" / "step05_plot_data.csv")
print(f"  Loaded {len(df_plot)} rows from step05_plot_data.csv")
print(f"  Columns: {list(df_plot.columns)}")
print(f"  Age tertiles: {sorted(df_plot['age_tertile'].unique())}")
print(f"  Paradigms: {sorted(df_plot['paradigm'].unique())}")
print(f"  Tests: {sorted(df_plot['test'].unique())}")

# =============================================================================
# PLOT: AGE x PARADIGM x TIME TRAJECTORIES
# =============================================================================

print("\nGenerating Age x Paradigm x Time trajectory plot...")

# Define paradigm colors (REMEMVR standard colors)
paradigm_colors = {
    'IFR': '#E74C3C',  # Red - Free Recall
    'ICR': '#3498DB',  # Blue - Cued Recall
    'IRE': '#2ECC71'   # Green - Recognition
}

# Create 3-panel figure (one panel per age tertile)
fig, axes = plt.subplots(1, 3, figsize=(15, 5), sharey=True)

# Define age tertile order
age_tertiles = ['Young', 'Middle', 'Older']

# Plot each age tertile in separate panel
for idx, age_tertile in enumerate(age_tertiles):
    ax = axes[idx]

    # Filter data for this age tertile
    df_tertile = df_plot[df_plot['age_tertile'] == age_tertile]

    # Plot each paradigm as separate line
    for paradigm in ['IFR', 'ICR', 'IRE']:
        df_para = df_tertile[df_tertile['paradigm'] == paradigm].sort_values('test')

        # Extract data
        time_points = df_para['TSVR_hours_mean'].values
        theta_means = df_para['theta_mean'].values
        theta_se = df_para['theta_SE'].values

        # Plot line with markers
        ax.plot(time_points, theta_means,
                marker='o', markersize=8, linewidth=2.5,
                color=paradigm_colors[paradigm],
                label=paradigm, alpha=0.9)

        # Add error bars (ï¿½1 SE)
        ax.errorbar(time_points, theta_means, yerr=theta_se,
                   fmt='none', color=paradigm_colors[paradigm],
                   capsize=5, capthick=2, alpha=0.5, linewidth=1.5)

    # Panel formatting
    ax.set_xlabel('Hours Since VR Encoding (TSVR)', fontweight='bold')
    if idx == 0:
        ax.set_ylabel('Memory Ability (Theta)', fontweight='bold')
    ax.set_title(f'{age_tertile} Adults', fontweight='bold', pad=15)
    ax.legend(loc='upper right', framealpha=0.95, title='Paradigm')
    ax.grid(True, alpha=0.3)

    # Add reference line at theta=0
    ax.axhline(y=0, color='gray', linestyle='--', linewidth=1, alpha=0.5)

# Overall figure title
fig.suptitle('RQ 5.3.4: Age x Paradigm Interactions in Forgetting Trajectories',
             fontweight='bold', fontsize=14, y=1.02)

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "age_paradigm_trajectories.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')

print(f"  -> Saved: plots/age_paradigm_trajectories.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/age_paradigm_trajectories.png (3-panel: Young, Middle, Older)")
print(f"\nPlot shows:")
print(f"  - 3 age tertiles (Young, Middle, Older adults)")
print(f"  - 3 paradigms per panel (IFR=Free, ICR=Cued, IRE=Recognition)")
print(f"  - 4 timepoints per trajectory (Test 1-4 mapped to TSVR hours)")
print(f"  - Error bars show +/- 1 SE")
print(f"\nInterpretation:")
print(f"  - Interaction pattern: Age effects differ across paradigms")
print(f"  - Hypothesis: Older adults show greater deficits in Free Recall")
print(f"    (IFR) than Cued Recall (ICR) or Recognition (IRE)")
print(f"\nAll plots saved with 300 DPI publication quality.")
print("="*70)
