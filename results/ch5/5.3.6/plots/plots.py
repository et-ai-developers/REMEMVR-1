#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.3.6 - Purified CTT Effects (Paradigms)

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-04
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

PLOTS GENERATED:
1. correlation_comparison.png - Grouped bar chart: r_full vs r_purified per paradigm
2. aic_comparison.png - Grouped bar chart: AIC for IRT vs Full CTT vs Purified CTT per paradigm

NOTE: This RQ uses grouped bar charts for comparison visualizations.
      Standard matplotlib bar charts used (no custom plotting functions needed).
"""

from pathlib import Path
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.3.6/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting style
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams.update({
    'font.size': 11,
    'axes.titlesize': 13,
    'axes.labelsize': 12,
    'figure.dpi': 100,
    'savefig.dpi': 300
})

print("Starting plotting for RQ 5.3.6...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: CORRELATION COMPARISON (r_full vs r_purified)
# =============================================================================

print("\nGenerating Plot 1: Correlation comparison (Full CTT vs Purified CTT)...")

# Load plot source CSV (created by analysis pipeline step 8)
df_corr = pd.read_csv(RQ_ROOT / "data" / "step08_correlation_comparison_data.csv")
print(f"  Loaded {len(df_corr)} rows from step08_correlation_comparison_data.csv")
print(f"  Columns: {list(df_corr.columns)}")

# Prepare data for grouped bar chart
paradigms = df_corr['paradigm'].unique()
ctt_types = ['Full', 'Purified']

# Set up bar positions
x = np.arange(len(paradigms))
width = 0.35

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Plot bars for Full and Purified CTT
for i, ctt_type in enumerate(ctt_types):
    subset = df_corr[df_corr['ctt_type'] == ctt_type]

    # Sort by paradigm order to match x positions
    subset = subset.set_index('paradigm').loc[paradigms].reset_index()

    r_values = subset['r'].values
    ci_lower = subset['CI_lower'].values
    ci_upper = subset['CI_upper'].values

    # Calculate error bar sizes (asymmetric)
    yerr_lower = r_values - ci_lower
    yerr_upper = ci_upper - r_values

    # Plot bars
    color = '#3498DB' if ctt_type == 'Full' else '#2ECC71'  # Blue for Full, Green for Purified
    ax.bar(x + i*width, r_values, width,
           label=f'{ctt_type} CTT',
           color=color, alpha=0.8,
           yerr=[yerr_lower, yerr_upper],
           capsize=5, error_kw={'linewidth': 2})

    # Add value labels on top of bars
    for j, (paradigm, r_val) in enumerate(zip(paradigms, r_values)):
        ax.text(x[j] + i*width, r_val + 0.02, f'{r_val:.3f}',
                ha='center', va='bottom', fontsize=9, fontweight='bold')

# Formatting
ax.set_xlabel('Paradigm', fontweight='bold', fontsize=12)
ax.set_ylabel('Correlation with IRT Theta (r)', fontweight='bold', fontsize=12)
ax.set_title('RQ 5.3.6: Correlation Comparison - Full CTT vs Purified CTT',
             fontweight='bold', fontsize=13, pad=15)
ax.set_xticks(x + width / 2)
ax.set_xticklabels(paradigms)
ax.set_ylim(0.7, 1.0)  # Focus on relevant range
ax.legend(loc='lower right', framealpha=0.95, fontsize=11)
ax.grid(True, alpha=0.3, axis='y')

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "correlation_comparison.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  -> Saved: plots/correlation_comparison.png")

# =============================================================================
# PLOT 2: AIC COMPARISON (IRT vs Full CTT vs Purified CTT)
# =============================================================================

print("\nGenerating Plot 2: AIC comparison (IRT vs Full CTT vs Purified CTT)...")

# Load plot source CSV
df_aic = pd.read_csv(RQ_ROOT / "data" / "step08_aic_comparison_data.csv")
print(f"  Loaded {len(df_aic)} rows from step08_aic_comparison_data.csv")
print(f"  Columns: {list(df_aic.columns)}")

# Prepare data for grouped bar chart
paradigms = df_aic['paradigm'].unique()
measurement_types = ['IRT', 'Full CTT', 'Purified CTT']
aic_columns = ['AIC_IRT', 'AIC_full', 'AIC_purified']

# Set up bar positions
x = np.arange(len(paradigms))
width = 0.25

# Create figure
fig, ax = plt.subplots(figsize=(12, 6))

# Colors for measurement types
colors = {
    'IRT': '#E74C3C',           # Red for IRT (reference)
    'Full CTT': '#3498DB',      # Blue for Full CTT
    'Purified CTT': '#2ECC71'   # Green for Purified CTT
}

# Plot bars for each measurement type
for i, (meas_type, aic_col) in enumerate(zip(measurement_types, aic_columns)):
    # Sort by paradigm order to match x positions
    subset = df_aic.set_index('paradigm').loc[paradigms].reset_index()
    aic_values = subset[aic_col].values

    # Plot bars
    ax.bar(x + i*width, aic_values, width,
           label=meas_type,
           color=colors[meas_type], alpha=0.8)

    # Add value labels on top of bars
    for j, (paradigm, aic_val) in enumerate(zip(paradigms, aic_values)):
        ax.text(x[j] + i*width, aic_val + 5, f'{aic_val:.1f}',
                ha='center', va='bottom', fontsize=8, fontweight='bold')

# Add delta_AIC annotations between Full and Purified
for j, paradigm in enumerate(paradigms):
    delta_aic = df_aic.loc[df_aic['paradigm'] == paradigm, 'delta_AIC_full_purified'].values[0]

    # Position annotation between Full and Purified bars
    x_pos = x[j] + 1.5*width  # Between Full and Purified bars
    full_aic = df_aic.loc[df_aic['paradigm'] == paradigm, 'AIC_full'].values[0]
    purified_aic = df_aic.loc[df_aic['paradigm'] == paradigm, 'AIC_purified'].values[0]
    y_pos = max(full_aic, purified_aic) + 20

    # Annotate delta_AIC
    ax.text(x_pos, y_pos, f'Δ={delta_aic:.1f}',
            ha='center', va='bottom', fontsize=9,
            style='italic', color='darkred',
            bbox=dict(boxstyle='round,pad=0.3', facecolor='yellow', alpha=0.3))

# Formatting
ax.set_xlabel('Paradigm', fontweight='bold', fontsize=12)
ax.set_ylabel('AIC (Akaike Information Criterion)', fontweight='bold', fontsize=12)
ax.set_title('RQ 5.3.6: AIC Comparison - IRT vs Full CTT vs Purified CTT',
             fontweight='bold', fontsize=13, pad=15)
ax.set_xticks(x + width)
ax.set_xticklabels(paradigms)
ax.legend(loc='upper right', framealpha=0.95, fontsize=11)
ax.grid(True, alpha=0.3, axis='y')

# Add interpretive note
note = "Lower AIC = Better model fit. Negative Δ (delta) = Full CTT better than Purified."
ax.text(0.02, 0.98, note,
        transform=ax.transAxes, fontsize=9, style='italic',
        verticalalignment='top',
        bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "aic_comparison.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  -> Saved: plots/aic_comparison.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 2")
print(f"  - plots/correlation_comparison.png")
print(f"  - plots/aic_comparison.png")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
