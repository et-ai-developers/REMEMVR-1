#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.3: Paradigm-Specific Forgetting Trajectories (Free/Cued/Recognition)

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-08
PURPOSE: Create publication-ready plots from model-averaged predictions

DATA SOURCES:
- Primary: step05c_averaged_predictions.csv (model-averaged trajectories with SE)
- Individual points: step04_lmm_input.csv (1200 observations for scatter)
- IRT parameters: step03_item_parameters.csv (for probability conversion)

PLOT STYLE (matching legacy .archive/v1/plots.py):
- Faded scatter points in background (individual observations)
- Dashed fitted curves (model-averaged predictions)
- Shaded 95% CI bands (±1.96 × prediction_se)

PLOTS GENERATED:
1. trajectory_theta.png - Theta-scale trajectory (IRT latent variable)
2. trajectory_probability.png - Probability-scale trajectory (dual-scale)

DECISIONS APPLIED:
- Decision D069: BOTH theta + probability MANDATORY
- Decision D070: TSVR (actual hours) as time variable
- Model averaging: Predictions weighted across 17 candidate models
"""

import sys
from pathlib import Path

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from tools.plotting import set_plot_style_defaults, convert_theta_to_probability

# =============================================================================
# SETUP
# =============================================================================

RQ_ROOT = Path(__file__).resolve().parent.parent
PLOTS_DIR = RQ_ROOT / "plots"
DATA_DIR = RQ_ROOT / "data"

# Apply consistent plotting theme
set_plot_style_defaults()

print("=" * 70)
print("RQ 5.3: Paradigm-Specific Forgetting Trajectories - Plotting")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")
print(f"Plots directory: {PLOTS_DIR}")
print("\nUsing MODEL-AVERAGED predictions from step05c")

# Plot style constants (enhanced for visibility)
RESIDUAL_SCATTER_POINT_ALPHA = 0.2  # Slightly more visible
MEAN_CI_ALPHA = 0.25  # Slightly more visible CI bands
IRT_LINE_STYLE = 'dashed'

# Paradigm color scheme (enhanced contrast)
COLORS = {
    "free_recall": "#2E86DE",   # Bright Blue
    "cued_recall": "#10AC84",   # Bright Green
    "recognition": "#EE5A6F",   # Bright Red (changed from orange for contrast)
}

# Line styles for better differentiation (when overlapping)
LINE_STYLES = {
    "free_recall": 'solid',           # Solid line
    "cued_recall": 'dashed',          # Dashed line
    "recognition": 'dotted',          # Dotted line
}

# Line widths for better visibility
LINE_WIDTHS = {
    "free_recall": 3.0,
    "cued_recall": 3.0,
    "recognition": 3.5,  # Slightly thicker for dotted line
}

# Display labels for paradigms
LABELS = {
    "free_recall": "Free Recall",
    "cued_recall": "Cued Recall",
    "recognition": "Recognition",
}

# =============================================================================
# LOAD DATA
# =============================================================================

print("\n" + "-" * 70)
print("Loading data sources...")
print("-" * 70)

# Load MODEL-AVERAGED predictions (primary data source)
averaged_pred_path = DATA_DIR / "step05c_averaged_predictions.csv"
df_pred = pd.read_csv(averaged_pred_path)
print(f"  Loaded {len(df_pred)} rows from step05c_averaged_predictions.csv")
print(f"  Columns: {list(df_pred.columns)}")
print(f"  Paradigms: {df_pred['paradigm'].unique()}")

# Load individual-level data for scatter points
lmm_input_path = DATA_DIR / "step04_lmm_input.csv"
df_lmm = pd.read_csv(lmm_input_path)
print(f"  Loaded {len(df_lmm)} individual observations from step04_lmm_input.csv")

# Load item parameters for probability conversion
item_params_path = DATA_DIR / "step03_item_parameters.csv"
df_items = pd.read_csv(item_params_path)
print(f"  Loaded {len(df_items)} items from step03_item_parameters.csv")

# Calculate 95% CI from prediction_se
df_pred['theta_ci_lower'] = df_pred['theta_averaged'] - 1.96 * df_pred['prediction_se']
df_pred['theta_ci_upper'] = df_pred['theta_averaged'] + 1.96 * df_pred['prediction_se']

# =============================================================================
# GET PARADIGM-SPECIFIC IRT PARAMETERS
# =============================================================================

print("\n" + "-" * 70)
print("Extracting paradigm-specific IRT parameters...")
print("-" * 70)

# Check for column names
factor_col = next((c for c in ['domain', 'factor', 'paradigm'] if c in df_items.columns), None)
disc_col = next((c for c in ['Discrimination', 'a'] if c in df_items.columns), None)
diff_col = next((c for c in ['Difficulty_1', 'Difficulty', 'b'] if c in df_items.columns), None)

if factor_col is None:
    print("  WARNING: No paradigm column found in item parameters")
    print("  Using overall mean parameters for all paradigms")
    paradigm_params = {}
else:
    paradigm_params = df_items.groupby(factor_col).agg({
        disc_col: 'mean',
        diff_col: 'mean'
    }).to_dict('index')
    print(f"  Paradigm IRT parameters loaded from column '{factor_col}':")
    for paradigm, params in paradigm_params.items():
        print(f"    {paradigm}: discrimination={params[disc_col]:.3f}, difficulty={params[diff_col]:.3f}")

# Get overall mean parameters as fallback
mean_a = df_items[disc_col].mean()
mean_b = df_items[diff_col].mean() if diff_col else 0.0
print(f"  Overall mean: discrimination={mean_a:.3f}, difficulty={mean_b:.3f}")

# =============================================================================
# PLOT 1: TRAJECTORY (THETA-SCALE)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 1: Theta-scale trajectory (publication style)...")
print("-" * 70)

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

paradigms = ['free_recall', 'cued_recall', 'recognition']

for paradigm in paradigms:
    color = COLORS.get(paradigm, '#333333')
    label = LABELS.get(paradigm, paradigm)

    # 1. Plot faded scatter points (individual observations)
    paradigm_data = df_lmm[df_lmm['paradigm'] == paradigm]
    ax.scatter(
        paradigm_data['TSVR_hours'],
        paradigm_data['theta'],
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get model-averaged predictions for this paradigm
    paradigm_pred = df_pred[df_pred['paradigm'] == paradigm]

    # 3. Plot shaded CI band (±1.96 × prediction_se)
    ax.fill_between(
        paradigm_pred['TSVR_hours'],
        paradigm_pred['theta_ci_lower'],
        paradigm_pred['theta_ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot fitted curve with distinct line style (model-averaged)
    ax.plot(
        paradigm_pred['TSVR_hours'],
        paradigm_pred['theta_averaged'],
        color=color,
        linestyle=LINE_STYLES.get(paradigm, 'solid'),
        linewidth=LINE_WIDTHS.get(paradigm, 3.0),
        label=label,
        zorder=5  # Ensure lines are on top
    )

# Formatting
ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Memory Ability (Theta)', fontsize=12)
ax.set_title('RQ 5.3: Paradigm-Specific Forgetting Trajectories - Theta Scale', fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, df_lmm['TSVR_hours'].max() + 5)

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_theta.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_theta.png'}")

# =============================================================================
# PLOT 2: TRAJECTORY (PROBABILITY-SCALE)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 2: Probability-scale trajectory (publication style)...")
print("-" * 70)

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

for paradigm in paradigms:
    color = COLORS.get(paradigm, '#333333')
    label = LABELS.get(paradigm, paradigm)

    # Get paradigm-specific IRT parameters if available
    paradigm_key_variants = [paradigm, paradigm.replace('_', ' '), paradigm.title()]
    paradigm_irt = None
    for key in paradigm_key_variants:
        if key in paradigm_params:
            paradigm_irt = paradigm_params[key]
            break

    if paradigm_irt:
        avg_a = paradigm_irt[disc_col]
        avg_b = paradigm_irt[diff_col]
        print(f"  Using paradigm-specific parameters for {paradigm}: a={avg_a:.3f}, b={avg_b:.3f}")
    else:
        avg_a = mean_a
        avg_b = mean_b
        print(f"  Using overall mean parameters for {paradigm}: a={avg_a:.3f}, b={avg_b:.3f}")

    # 1. Plot faded scatter points (individual probabilities)
    paradigm_data = df_lmm[df_lmm['paradigm'] == paradigm]
    paradigm_prob = convert_theta_to_probability(
        paradigm_data['theta'].values, discrimination=avg_a, difficulty=avg_b
    ) * 100

    ax.scatter(
        paradigm_data['TSVR_hours'],
        paradigm_prob,
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get model-averaged theta predictions and convert to probability
    paradigm_pred = df_pred[df_pred['paradigm'] == paradigm].copy()

    # Convert theta CI to probability
    paradigm_pred['prob_mean'] = convert_theta_to_probability(
        paradigm_pred['theta_averaged'].values, discrimination=avg_a, difficulty=avg_b
    ) * 100
    paradigm_pred['prob_ci_lower'] = convert_theta_to_probability(
        paradigm_pred['theta_ci_lower'].values, discrimination=avg_a, difficulty=avg_b
    ) * 100
    paradigm_pred['prob_ci_upper'] = convert_theta_to_probability(
        paradigm_pred['theta_ci_upper'].values, discrimination=avg_a, difficulty=avg_b
    ) * 100

    # 3. Plot shaded CI band
    ax.fill_between(
        paradigm_pred['TSVR_hours'],
        paradigm_pred['prob_ci_lower'],
        paradigm_pred['prob_ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot fitted curve with distinct line style (model-averaged)
    ax.plot(
        paradigm_pred['TSVR_hours'],
        paradigm_pred['prob_mean'],
        color=color,
        linestyle=LINE_STYLES.get(paradigm, 'solid'),
        linewidth=LINE_WIDTHS.get(paradigm, 3.0),
        label=label,
        zorder=5  # Ensure lines are on top
    )

# Formatting
ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Probability Correct (%)', fontsize=12)
ax.set_title('RQ 5.3: Paradigm-Specific Forgetting Trajectories - Probability Scale', fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, df_lmm['TSVR_hours'].max() + 5)
ax.set_ylim(0, 100)

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_probability.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_probability.png'}")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 2")
print(f"  - {PLOTS_DIR / 'trajectory_theta.png'}")
print(f"  - {PLOTS_DIR / 'trajectory_probability.png'}")
print("\nData source: MODEL-AVERAGED PREDICTIONS")
print("  - step05c_averaged_predictions.csv (weighted across 17 candidate models)")
print("  - Uncertainty bands: ±1.96 × prediction_se")
print("\nPlot style (matching legacy):")
print("  - Faded scatter points (individual observations)")
print("  - Dashed fitted curves (model-averaged predictions)")
print("  - Shaded 95% CI bands (from model averaging variance)")
print("\nDecision D069 compliance: BOTH theta + probability scale plots generated")
print("All plots saved with 300 DPI publication quality.")
print("=" * 70)
