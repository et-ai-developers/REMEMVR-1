#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.1.3 - Age Effects on Baseline Memory and Forgetting Rate

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-11-28
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSV

OPTION B ARCHITECTURE:
- Plot source CSV created by analysis pipeline (g_code Step 5)
- This script ONLY reads CSV and calls tools/plotting.py functions
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. age_tertile_trajectory.png - Age tertile trajectories with observed data + LMM predictions
"""

import sys
from pathlib import Path
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# Add project root to path for imports
# plots.py is in results/ch5/5.1.3/plots/ (parents: [3]=results, [4]=REMEMVR)
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.1.3/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.1.3...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: AGE TERTILE TRAJECTORY
# =============================================================================

print("\nGenerating Plot 1: Age tertile trajectory...")

# Load plot source CSV (created by analysis pipeline Step 5)
df_plot = pd.read_csv(RQ_ROOT / "data" / "step05_age_tertile_plot_data.csv")
print(f"  Loaded {len(df_plot)} rows from step05_age_tertile_plot_data.csv")
print(f"  Columns: {list(df_plot.columns)}")

# Define age tertile colors (Young -> Middle -> Older = lighter to darker)
colors = {
    'Young': '#2ECC71',    # Green (younger adults)
    'Middle': '#F39C12',   # Orange (middle-aged adults)
    'Older': '#E74C3C'     # Red (older adults)
}

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Plot each age tertile
for tertile in ['Young', 'Middle', 'Older']:
    df_tertile = df_plot[df_plot['age_tertile'] == tertile].copy()

    # Sort by time for proper line plotting
    df_tertile = df_tertile.sort_values('TSVR_hours')

    color = colors[tertile]

    # Plot observed data points with error bars (only where data exists)
    df_observed = df_tertile[df_tertile['theta_observed'].notna()]
    if len(df_observed) > 0:
        ax.errorbar(
            df_observed['TSVR_hours'],
            df_observed['theta_observed'],
            yerr=[
                df_observed['theta_observed'] - df_observed['ci_lower'],
                df_observed['ci_upper'] - df_observed['theta_observed']
            ],
            fmt='o',
            color=color,
            markersize=8,
            capsize=5,
            capthick=2,
            alpha=0.7,
            label=f'{tertile} (observed)'
        )

    # Plot LMM predictions (smooth curve, all timepoints)
    df_pred = df_tertile[df_tertile['theta_predicted'].notna()]
    if len(df_pred) > 0:
        ax.plot(
            df_pred['TSVR_hours'],
            df_pred['theta_predicted'],
            color=color,
            linewidth=2.5,
            linestyle='--',
            alpha=0.9,
            label=f'{tertile} (LMM)'
        )

# Formatting
ax.set_xlabel('Hours Since VR Encoding (TSVR)', fontweight='bold')
ax.set_ylabel('Memory Ability (Theta)', fontweight='bold')
ax.set_title('RQ 5.1.3: Age Effects on Memory Trajectory', fontweight='bold', pad=15)
ax.legend(loc='upper right', framealpha=0.95, ncol=2)
ax.grid(True, alpha=0.3)

# Add annotation explaining age tertiles
annotation = (
    "Age tertiles: Young (20-38 yrs), Middle (38-55 yrs), Older (55-70 yrs)\n"
    "LMM predictions from Lin+Log functional form with Age x Time interactions"
)
ax.text(
    0.02, 0.02,
    annotation,
    transform=ax.transAxes,
    fontsize=9,
    style='italic',
    bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.3),
    verticalalignment='bottom'
)

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "age_tertile_trajectory.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"  [PASS] Saved: plots/age_tertile_trajectory.png")

plt.close(fig)

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/age_tertile_trajectory.png")
print("\nPlot shows observed data (circles with error bars) and LMM predictions")
print("(dashed lines) for three age tertiles across 6-day retention interval.")
print("="*70)
