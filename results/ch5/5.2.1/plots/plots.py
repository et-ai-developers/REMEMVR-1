#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.2.1: Domain-Specific Forgetting Trajectories (What/Where/When)

GENERATED BY: rq_plots agent (v4.0.0) - REGENERATED FOR MODEL AVERAGING
DATE: 2025-12-08
PURPOSE: Create publication-ready plots using MODEL-AVERAGED predictions

CRITICAL CHANGE FROM ORIGINAL:
- Original: Re-fit single best model (Log) to compute predictions and CI
- Updated: Use pre-computed model-averaged predictions from step05c
- Reason: Model averaging across 10 competitive models (delta_AIC < 2)
           provides more robust predictions and better uncertainty quantification

MODEL AVERAGING APPROACH (Step 05c):
- 66 candidate models tested (kitchen sink comparison)
- Top 10 models selected (delta_AIC < 2, cumulative weight > 0.95)
- Weighted averaging of predictions using Akaike weights
- Uncertainty bands: Â±1 SE from model averaging variance

PLOTS GENERATED:
1. trajectory_theta.png - Theta-scale trajectory (IRT latent variable)
2. trajectory_probability.png - Probability-scale trajectory (Decision D069)

PLOT STYLE:
- Faded scatter points in background (individual observations from step04)
- Solid lines (model-averaged predictions from step05c)
- Shaded 95% CI bands (Â±1.96 * SE from model averaging)

DECISIONS APPLIED:
- D069: Dual-scale trajectory plots (BOTH theta + probability MANDATORY)
- D070: TSVR time variable (actual hours, not nominal days)
"""

import sys
from pathlib import Path

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from tools.plotting import set_plot_style_defaults, convert_theta_to_probability

# =============================================================================
# SETUP
# =============================================================================

RQ_ROOT = Path(__file__).resolve().parent.parent
PLOTS_DIR = RQ_ROOT / "plots"
DATA_DIR = RQ_ROOT / "data"

# Apply consistent plotting theme
set_plot_style_defaults()

print("=" * 70)
print("RQ 5.2.1: Domain-Specific Forgetting Trajectories - Plotting")
print("MODEL-AVERAGED PREDICTIONS (66 models -> 10 competitive)")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")
print(f"Plots directory: {PLOTS_DIR}")

# Plot style constants
RESIDUAL_SCATTER_POINT_ALPHA = 0.15
MEAN_CI_ALPHA = 0.2
LINE_STYLE = 'solid'  # Solid for model-averaged (vs dashed for single model)

# Domain color scheme
COLORS = {
    "what": "#3498DB",   # Blue
    "where": "#2ECC71",  # Green
    "when": "#E67E22",   # Orange
}

# =============================================================================
# LOAD DATA
# =============================================================================

print("\n" + "-" * 70)
print("Loading data...")
print("-" * 70)

# 1. Load model-averaged predictions (from step05c)
pred_path = DATA_DIR / "step05c_averaged_predictions.csv"
df_pred = pd.read_csv(pred_path)
print(f"  Loaded {len(df_pred)} model-averaged predictions from step05c")
print(f"  Columns: {list(df_pred.columns)}")
print(f"  TSVR range: [{df_pred['TSVR_hours'].min():.1f}, {df_pred['TSVR_hours'].max():.1f}] hours")
print(f"  Domains: {sorted(df_pred['domain'].unique())}")

# 2. Load observed data (for scatter points)
obs_path = DATA_DIR / "step04_lmm_input.csv"
df_obs = pd.read_csv(obs_path)
print(f"  Loaded {len(df_obs)} observed data points from step04")
print(f"  Columns: {list(df_obs.columns)}")

# 3. Load item parameters (for probability conversion)
item_params_path = DATA_DIR / "step03_item_parameters.csv"
df_items = pd.read_csv(item_params_path)
print(f"  Loaded {len(df_items)} item parameters from step03")

# Get domain-specific IRT parameters
factor_col = 'factor' if 'factor' in df_items.columns else 'domain'
disc_col = next((c for c in ['Discrimination', 'a'] if c in df_items.columns), None)
diff_col = next((c for c in ['Difficulty_1', 'Difficulty', 'b'] if c in df_items.columns), None)

# ðŸš¨ CRITICAL: Use FACTOR-SPECIFIC item parameters for probability conversion
# (see rq_plots agent prompt v4.0.1 - Multi-Dimensional IRT section)
FACTOR_PARAMS = {}
for domain in df_pred['domain'].unique():
    domain_items = df_items[df_items[factor_col] == domain]
    FACTOR_PARAMS[domain] = {
        'discrimination': domain_items[disc_col].mean(),
        'difficulty': domain_items[diff_col].mean()
    }
    print(f"  Domain '{domain}': a={FACTOR_PARAMS[domain]['discrimination']:.3f}, "
          f"b={FACTOR_PARAMS[domain]['difficulty']:.3f} (n={len(domain_items)} items)")

# =============================================================================
# PREPARE PREDICTION GRID WITH CI
# =============================================================================

print("\n" + "-" * 70)
print("Preparing prediction grid with uncertainty bands...")
print("-" * 70)

# Model averaging provides predictions + variance
# Calculate 95% CI: prediction Â± 1.96 * SE
df_pred['theta_ci_lower'] = df_pred['theta_averaged'] - 1.96 * df_pred['prediction_se']
df_pred['theta_ci_upper'] = df_pred['theta_averaged'] + 1.96 * df_pred['prediction_se']

print(f"  Theta range: [{df_pred['theta_averaged'].min():.3f}, {df_pred['theta_averaged'].max():.3f}]")
print(f"  SE range: [{df_pred['prediction_se'].min():.4f}, {df_pred['prediction_se'].max():.4f}]")
print(f"  CI width range: [{(df_pred['theta_ci_upper'] - df_pred['theta_ci_lower']).min():.3f}, "
      f"{(df_pred['theta_ci_upper'] - df_pred['theta_ci_lower']).max():.3f}]")

# =============================================================================
# PLOT 1: TRAJECTORY (THETA-SCALE)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 1: Theta-scale trajectory (model-averaged)...")
print("-" * 70)

fig, ax = plt.subplots(figsize=(10, 6))

domains = sorted(df_pred['domain'].unique())

for domain in domains:
    color = COLORS.get(domain, '#333333')

    # 1. Plot faded scatter points (individual observations)
    domain_obs = df_obs[df_obs['domain'] == domain]
    ax.scatter(
        domain_obs['TSVR_hours'],
        domain_obs['theta'],
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get model-averaged predictions for this domain
    domain_pred = df_pred[df_pred['domain'] == domain].sort_values('TSVR_hours')

    # 3. Plot shaded CI band (Â±1.96 SE from model averaging)
    ax.fill_between(
        domain_pred['TSVR_hours'],
        domain_pred['theta_ci_lower'],
        domain_pred['theta_ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot solid fitted curve (model-averaged prediction)
    ax.plot(
        domain_pred['TSVR_hours'],
        domain_pred['theta_averaged'],
        color=color,
        linestyle=LINE_STYLE,
        linewidth=2.5,
        label=domain.capitalize()
    )

# Formatting
ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Memory Ability (Theta)', fontsize=12)
ax.set_title('RQ 5.2.1: Domain-Specific Forgetting Trajectories - Theta Scale\n(Model-Averaged across 10 competitive models)',
             fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, df_obs['TSVR_hours'].max() + 5)

# Add note about model averaging
ax.text(0.02, 0.02,
        'Uncertainty bands: Â±1.96 SE from model averaging (10 models, cumulative weight > 0.95)',
        transform=ax.transAxes, fontsize=8, style='italic',
        bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.3),
        verticalalignment='bottom')

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_theta.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_theta.png'}")

# =============================================================================
# PLOT 2: TRAJECTORY (PROBABILITY-SCALE) - Decision D069
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 2: Probability-scale trajectory (model-averaged)...")
print("-" * 70)

fig, ax = plt.subplots(figsize=(10, 6))

for domain in domains:
    color = COLORS.get(domain, '#333333')

    # Get domain-specific IRT parameters (FACTOR-SPECIFIC, not global average)
    params = FACTOR_PARAMS[domain]
    avg_a = params['discrimination']
    avg_b = params['difficulty']

    print(f"  Converting '{domain}' theta to probability: a={avg_a:.3f}, b={avg_b:.3f}")

    # 1. Convert observed theta to probability (for scatter points)
    domain_obs = df_obs[df_obs['domain'] == domain].copy()
    domain_obs['probability'] = convert_theta_to_probability(
        domain_obs['theta'].values,
        discrimination=avg_a,
        difficulty=avg_b
    ) * 100  # Convert to percentage

    # Plot faded scatter points
    ax.scatter(
        domain_obs['TSVR_hours'],
        domain_obs['probability'],
        c=color,
        alpha=RESIDUAL_SCATTER_POINT_ALPHA,
        s=15,
        edgecolors='none'
    )

    # 2. Get model-averaged predictions and convert to probability
    domain_pred = df_pred[df_pred['domain'] == domain].sort_values('TSVR_hours').copy()

    # Convert theta CI to probability (factor-specific parameters)
    domain_pred['prob_mean'] = convert_theta_to_probability(
        domain_pred['theta_averaged'].values,
        discrimination=avg_a,
        difficulty=avg_b
    ) * 100

    domain_pred['prob_ci_lower'] = convert_theta_to_probability(
        domain_pred['theta_ci_lower'].values,
        discrimination=avg_a,
        difficulty=avg_b
    ) * 100

    domain_pred['prob_ci_upper'] = convert_theta_to_probability(
        domain_pred['theta_ci_upper'].values,
        discrimination=avg_a,
        difficulty=avg_b
    ) * 100

    # 3. Plot shaded CI band
    ax.fill_between(
        domain_pred['TSVR_hours'],
        domain_pred['prob_ci_lower'],
        domain_pred['prob_ci_upper'],
        color=color,
        alpha=MEAN_CI_ALPHA,
        edgecolor='none'
    )

    # 4. Plot solid fitted curve
    ax.plot(
        domain_pred['TSVR_hours'],
        domain_pred['prob_mean'],
        color=color,
        linestyle=LINE_STYLE,
        linewidth=2.5,
        label=domain.capitalize()
    )

# Formatting
ax.set_xlabel('Time since encoding (hours)', fontsize=12)
ax.set_ylabel('Probability Correct (%)', fontsize=12)
ax.set_title('RQ 5.2.1: Domain-Specific Forgetting Trajectories - Probability Scale\n(Model-Averaged across 10 competitive models)',
             fontsize=14, fontweight='bold')
ax.legend(loc='upper right', framealpha=0.95, fontsize=10)
ax.grid(True, linestyle='--', alpha=0.6)
ax.set_xlim(-5, df_obs['TSVR_hours'].max() + 5)
ax.set_ylim(0, 100)

# Add note about model averaging
ax.text(0.02, 0.02,
        'Uncertainty bands: Â±1.96 SE from model averaging (10 models, cumulative weight > 0.95)',
        transform=ax.transAxes, fontsize=8, style='italic',
        bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.3),
        verticalalignment='bottom')

plt.tight_layout()
fig.savefig(PLOTS_DIR / "trajectory_probability.png", dpi=300, bbox_inches='tight', facecolor='white')
plt.close(fig)

print(f"  [PASS] Saved: {PLOTS_DIR / 'trajectory_probability.png'}")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 2")
print(f"  - {PLOTS_DIR / 'trajectory_theta.png'}")
print(f"  - {PLOTS_DIR / 'trajectory_probability.png'}")
print("\nKEY DIFFERENCE FROM ORIGINAL:")
print("  Original: Single best model (Log, AIC=3187.96)")
print("  Updated: Model-averaged across 10 competitive models (delta_AIC < 2)")
print("  Benefit: More robust predictions, better uncertainty quantification")
print("\nPlot style:")
print("  - Faded scatter points (individual observations)")
print("  - Solid fitted curves (model-averaged predictions)")
print("  - Shaded 95% CI bands (Â±1.96 SE from model averaging)")
print("\nDecision D069 compliance: BOTH theta + probability scale plots generated")
print("Decision D070 compliance: TSVR_hours (continuous, not nominal days)")
print("All plots saved with 300 DPI publication quality.")
print("=" * 70)
