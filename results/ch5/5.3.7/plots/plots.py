#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.3.7 - Paradigm-Specific Variance Decomposition

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-04
PURPOSE: Create publication-ready barplot from pre-aggregated plot source CSV

PLOT GENERATED:
1. paradigm_icc_barplot.png - ICC_slope_conditional barplot with 95% CI error bars

PLOT DESCRIPTION:
Barplot showing ICC_slope_conditional for Free Recall, Cued Recall, and Recognition
paradigms with 95% confidence interval error bars. X-axis = Paradigm, Y-axis = ICC (0-1).
Horizontal reference line at ICC = 0.40 (threshold for substantial between-person variance).
Bars colored by interpretation (Low=red, Moderate=yellow, Substantial=green).
"""

from pathlib import Path
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.3.7/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting style
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams.update({
    'font.size': 11,
    'axes.titlesize': 13,
    'axes.labelsize': 12,
    'figure.dpi': 100,
    'savefig.dpi': 300
})

print("Starting plotting for RQ 5.3.7...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: PARADIGM ICC BARPLOT
# =============================================================================

print("\nGenerating Plot 1: Paradigm ICC barplot...")

# Load plot source CSV (created by analysis pipeline Step 6)
df_plot = pd.read_csv(RQ_ROOT / "data" / "step06_paradigm_icc_barplot_data.csv")
print(f"  Loaded {len(df_plot)} rows from step06_paradigm_icc_barplot_data.csv")
print(f"  Columns: {list(df_plot.columns)}")

# Verify expected structure
assert len(df_plot) == 3, f"Expected 3 paradigms, found {len(df_plot)}"
assert all(col in df_plot.columns for col in ['paradigm', 'icc_value', 'CI_lower', 'CI_upper', 'interpretation']), \
    f"Missing required columns in plot data"

# Define paradigm order and labels
paradigm_order = ['free_recall', 'cued_recall', 'recognition']
paradigm_labels = ['Free Recall (IFR)', 'Cued Recall (ICR)', 'Recognition (IRE)']

# Reorder dataframe by paradigm_order
df_plot['paradigm'] = pd.Categorical(df_plot['paradigm'], categories=paradigm_order, ordered=True)
df_plot = df_plot.sort_values('paradigm')

# Define colors by interpretation
color_map = {
    'Low': '#E74C3C',        # Red
    'Moderate': '#F39C12',   # Yellow/Orange
    'Substantial': '#2ECC71' # Green
}

# Map colors to bars
bar_colors = [color_map.get(interp, '#95A5A6') for interp in df_plot['interpretation']]

# Compute error bars (asymmetric)
yerr_lower = df_plot['icc_value'] - df_plot['CI_lower']
yerr_upper = df_plot['CI_upper'] - df_plot['icc_value']
yerr = np.array([yerr_lower, yerr_upper])

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# Plot bars
x_pos = np.arange(len(df_plot))
bars = ax.bar(x_pos, df_plot['icc_value'],
              color=bar_colors,
              alpha=0.8,
              edgecolor='black',
              linewidth=1.5)

# Add error bars
ax.errorbar(x_pos, df_plot['icc_value'],
           yerr=yerr,
           fmt='none',
           ecolor='black',
           capsize=8,
           capthick=2,
           alpha=0.7)

# Add horizontal reference line at ICC = 0.40
ax.axhline(y=0.40, color='gray', linestyle='--', linewidth=1.5, alpha=0.7,
          label='Substantial Threshold (ICC = 0.40)')

# Formatting
ax.set_xlabel('Retrieval Paradigm', fontweight='bold', fontsize=12)
ax.set_ylabel('ICC (Intraclass Correlation Coefficient)', fontweight='bold', fontsize=12)
ax.set_title('RQ 5.3.7: Paradigm-Specific Variance Decomposition\n' +
            'ICC_slope_conditional by Retrieval Paradigm',
            fontweight='bold', fontsize=13, pad=15)

# Set x-axis ticks and labels
ax.set_xticks(x_pos)
ax.set_xticklabels(paradigm_labels, fontsize=11)

# Set y-axis limits and ticks
ax.set_ylim(0, 0.7)
ax.set_yticks(np.arange(0, 0.71, 0.1))

# Add grid
ax.grid(True, axis='y', alpha=0.3, linestyle='-', linewidth=0.5)

# Add value labels on top of bars
for i, (idx, row) in enumerate(df_plot.iterrows()):
    ax.text(i, row['icc_value'] + 0.03,
           f"{row['icc_value']:.3f}",
           ha='center', va='bottom',
           fontsize=10, fontweight='bold')

# Add legend
ax.legend(loc='upper left', framealpha=0.95, fontsize=10)

# Tight layout
plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "paradigm_icc_barplot.png"
output_path.parent.mkdir(parents=True, exist_ok=True)
fig.savefig(output_path, dpi=300, bbox_inches='tight')

print(f"  [PASS] Saved: plots/paradigm_icc_barplot.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print(f"Total plots generated: 1")
print(f"  - plots/paradigm_icc_barplot.png")
print("\nPlot details:")
print(f"  - 3 paradigms: Free Recall, Cued Recall, Recognition")
print(f"  - ICC_slope_conditional range: [{df_plot['icc_value'].min():.3f}, {df_plot['icc_value'].max():.3f}]")
print(f"  - All paradigms: {df_plot['interpretation'].unique()[0]} between-person variance")
print(f"  - Reference line: ICC = 0.40 (substantial threshold)")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
