#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.2.3 - Domain-Specific Age Effects on Forgetting

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-12-02 (Updated to reflect When domain exclusion)
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSV

OPTION B ARCHITECTURE:
- Plot source CSV created by analysis pipeline (g_code)
- This script ONLY reads CSV and generates visualization
- NO data aggregation/transformation logic

CRITICAL UPDATE (2025-12-02):
- When domain EXCLUDED due to floor effect (20/26 items excluded in IRT calibration)
- Plot shows ONLY What and Where domains (2 panels, not 3)
- Plot source CSV contains only What/Where data (verified: 2 domains, 3 tertiles each)

PLOTS GENERATED:
1. age_effects_by_domain.png - 2-panel plot showing age tertile trajectories by domain
"""

from pathlib import Path
import sys
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# Add project root to path for imports
# plots.py is in results/ch5/5.2.3/plots/ (4 levels deep from project root)
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.2.3/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("Starting plotting for RQ 5.2.3...")
print(f"RQ root: {RQ_ROOT}")

# =============================================================================
# PLOT 1: AGE EFFECTS BY DOMAIN (2-PANEL MULTI-PANEL PLOT)
# =============================================================================

print("\nGenerating Plot 1: Age effects by domain (2-panel - What/Where only)...")

# Load plot source CSV (created by analysis pipeline step 5)
df = pd.read_csv(RQ_ROOT / "plots" / "step05_age_effects_plot_data.csv")
print(f"  Loaded {len(df)} rows from step05_age_effects_plot_data.csv")
print(f"  Columns: {list(df.columns)}")

# Check available domains in data (should be What/Where only after When exclusion)
available_domains = df['domain_name'].unique()
print(f"  Available domains: {sorted(available_domains)}")

# Define domain order and colors (ONLY What and Where - When excluded)
domains = ['What', 'Where']  # When excluded due to floor effect
domain_colors = {
    'What': '#E74C3C',   # Red
    'Where': '#3498DB'   # Blue
}

# Define age tertile colors (shades from light to dark for Young -> Older)
age_colors = {
    'Young': '#2ECC71',    # Green (younger = better)
    'Middle': '#F39C12',   # Orange (middle)
    'Older': '#E74C3C'     # Red (older = worse)
}

# Create 1x2 subplot layout (2 panels side-by-side for What and Where)
fig, axes = plt.subplots(1, 2, figsize=(12, 6), sharey=True)

# Plot each domain in separate panel
for idx, domain in enumerate(domains):
    ax = axes[idx]

    # Filter data for this domain
    df_domain = df[df['domain_name'] == domain].copy()

    print(f"\n  Panel {idx+1}: {domain} domain")
    print(f"    Rows: {len(df_domain)}")

    # Plot each age tertile
    for age_tertile in ['Young', 'Middle', 'Older']:
        df_age = df_domain[df_domain['age_tertile'] == age_tertile].copy()

        if len(df_age) == 0:
            print(f"    WARNING: No data for {age_tertile} tertile")
            continue

        color = age_colors[age_tertile]

        # Sort by TSVR_hours for line plotting
        df_age = df_age.sort_values('TSVR_hours')

        # Separate observed and predicted data
        df_observed = df_age[df_age['theta_observed'].notna()].copy()
        df_predicted = df_age[df_age['theta_predicted'].notna()].copy()

        # Plot observed data points with error bars (if available)
        if len(df_observed) > 0:
            # Check if CI columns exist and have non-null values
            has_ci = ('ci_lower' in df_observed.columns and
                     df_observed['ci_lower'].notna().any())

            if has_ci:
                # Plot with error bars (CI bounds)
                ax.errorbar(
                    df_observed['TSVR_hours'],
                    df_observed['theta_observed'],
                    yerr=[
                        df_observed['theta_observed'] - df_observed['ci_lower'],
                        df_observed['ci_upper'] - df_observed['theta_observed']
                    ],
                    fmt='o',
                    color=color,
                    markersize=6,
                    capsize=4,
                    capthick=1.5,
                    alpha=0.6,
                    label=f'{age_tertile} (observed)'
                )
            else:
                # Plot without error bars
                ax.scatter(
                    df_observed['TSVR_hours'],
                    df_observed['theta_observed'],
                    color=color,
                    s=50,
                    alpha=0.6,
                    label=f'{age_tertile} (observed)',
                    zorder=3
                )

            print(f"    {age_tertile}: {len(df_observed)} observed points")

        # Plot model predictions as smooth line
        if len(df_predicted) > 0:
            ax.plot(
                df_predicted['TSVR_hours'],
                df_predicted['theta_predicted'],
                color=color,
                linewidth=2.5,
                alpha=0.9,
                label=f'{age_tertile} (fitted)',
                zorder=2
            )
            print(f"    {age_tertile}: {len(df_predicted)} predicted points")

    # Formatting for this panel
    ax.set_xlabel('Hours Since VR Encoding (TSVR)', fontweight='bold')
    if idx == 0:
        ax.set_ylabel('Memory Ability (Theta)', fontweight='bold')
    ax.set_title(f'{domain} Domain', fontweight='bold', pad=15)
    ax.grid(True, alpha=0.3)
    ax.legend(loc='best', framealpha=0.95, fontsize=9)

# Overall figure title
fig.suptitle('RQ 5.2.3: Domain-Specific Age Effects on Forgetting (What/Where Only)',
             fontsize=14, fontweight='bold', y=1.02)

plt.tight_layout()

# Save plot
output_path = RQ_ROOT / "plots" / "age_effects_by_domain.png"
fig.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"\n  -> Saved: plots/age_effects_by_domain.png")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "="*70)
print("PLOTTING COMPLETE")
print("="*70)
print("Total plots generated: 1")
print("  - plots/age_effects_by_domain.png (2-panel age effects visualization)")
print("\nNOTE: When domain EXCLUDED due to floor effect (77% items removed)")
print("      Plot shows What and Where domains only (2 panels)")
print("\nAll plots saved with 300 DPI publication quality.")
print("="*70)
