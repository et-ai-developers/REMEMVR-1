#!/usr/bin/env python3
# =============================================================================
# SCRIPT METADATA (Generated by g_code, FIXED by TDD)
# =============================================================================
"""
Step ID: step04
Step Name: step04_compute_contrasts
RQ: results/ch5/rq10
Generated: 2025-11-28
FIXED: 2025-11-29 (replaced compute_contrasts_pairwise with extract_marginal_age_slopes_by_domain)

PURPOSE:
Quantify age effect on forgetting rate for each domain (What, Where, When)

EXPECTED INPUTS:
  - data/step02_lmm_model.pkl
    Description: Selected LMM model from Step 2c (REML=False)
    Expected: statsmodels MixedLMResults object with 3-way Age × Domain × Time interaction

EXPECTED OUTPUTS:
  - data/step04_age_effects_by_domain.csv
    Columns: ['domain', 'age_slope', 'se', 'z', 'p', 'CI_lower', 'CI_upper']
    Format: Domain-specific marginal age effects on forgetting rate at Day 3 (TSVR=72h)
    Expected rows: 3 (What, Where, When)

  - results/step04_summary.txt
    Format: Text summary of age effects with interpretation
    Expected: Statistical summary report

VALIDATION CRITERIA:
  - All 3 domains present (What, Where, When)
  - All p-values in [0, 1] range
  - Standard errors > 0
  - CI_lower < CI_upper

g_code REASONING (CORRECTED):
- Original approach: Used compute_contrasts_pairwise (WRONG - designed for categorical contrasts)
- Corrected approach: Use extract_marginal_age_slopes_by_domain (extracts marginal age effects
  from 3-way interaction model using delta method)
- Why this approach: Quantifies how much a 1-year age increase affects forgetting rate in each
  domain at Day 3 (midpoint of observation window)
- Data flow: LMM model -> extract domain-specific marginal slopes via delta method -> report

IMPLEMENTATION NOTES:
- Analysis tool: extract_marginal_age_slopes_by_domain from tools.analysis_lmm
- Evaluation timepoint: 72.0 hours (Day 3, midpoint of 0-168h window)
- Delta method used for SE propagation through linear combinations
"""
# =============================================================================

import sys
from pathlib import Path
import pandas as pd
import traceback

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).resolve().parents[4]
sys.path.insert(0, str(PROJECT_ROOT))

# Import analysis tool
from tools.analysis_lmm import extract_marginal_age_slopes_by_domain

# =============================================================================
# Configuration
# =============================================================================

RQ_DIR = Path(__file__).resolve().parents[1]  # results/chX/rqY
LOG_FILE = RQ_DIR / "logs" / "step04_compute_contrasts.log"

# =============================================================================
# Logging Function
# =============================================================================

def log(msg):
    """Write to both log file and console."""
    with open(LOG_FILE, 'a', encoding='utf-8') as f:
        f.write(f"{msg}\n")
    print(msg)

# =============================================================================
# Main Analysis
# =============================================================================

if __name__ == "__main__":
    try:
        log("[START] Step 04: Compute Domain-Specific Age Effects")

        # =========================================================================
        # STEP 1: Load Input Data
        # =========================================================================
        log("[LOAD] Loading LMM model from Step 2c...")
        lmm_model_path = RQ_DIR / "data" / "step02_lmm_model.pkl"

        from statsmodels.regression.mixed_linear_model import MixedLMResults
        lmm_model = MixedLMResults.load(str(lmm_model_path))
        log(f"[LOADED] LMM model from {lmm_model_path.name}")

        n_groups = len(lmm_model.model.group_labels)
        log(f"[INFO] Model has {n_groups} groups (participants)")
        log(f"[INFO] Model converged: {lmm_model.converged}")

        # =========================================================================
        # STEP 2: Extract Domain-Specific Marginal Age Effects
        # =========================================================================
        log("[ANALYSIS] Extracting marginal age effects by domain...")
        log("[INFO] Evaluation timepoint: TSVR = 72.0 hours (Day 3, midpoint)")
        log("[INFO] Using delta method for SE propagation")

        # Extract marginal age slopes for each domain at Day 3
        age_effects = extract_marginal_age_slopes_by_domain(
            lmm_result=lmm_model,
            eval_timepoint=72.0,  # Day 3 (midpoint of observation window)
            domain_var="domain",
            age_var="Age_c",
            time_linear="TSVR_hours",
            time_log="log_TSVR"
        )

        log("[DONE] Age effect extraction complete")
        log(f"[INFO] Extracted age effects for {len(age_effects)} domains")

        # Log results
        for idx, row in age_effects.iterrows():
            log(f"[RESULT] {row['domain']}: age_slope={row['age_slope']:.6f}, SE={row['se']:.6f}, p={row['p']:.4f}")

        # =========================================================================
        # STEP 3: Save Outputs
        # =========================================================================
        log("[SAVE] Saving age effects by domain...")
        output_path = RQ_DIR / "data" / "step04_age_effects_by_domain.csv"
        age_effects.to_csv(output_path, index=False, encoding='utf-8')
        log(f"[SAVED] {output_path.name} ({len(age_effects)} rows, {len(age_effects.columns)} columns)")

        # Create summary text report
        log("[SAVE] Creating summary report...")
        summary_path = RQ_DIR / "results" / "step04_summary.txt"

        summary_lines = []
        summary_lines.append("=" * 80)
        summary_lines.append("STEP 04: Domain-Specific Age Effects on Forgetting Rate")
        summary_lines.append("=" * 80)
        summary_lines.append("")
        summary_lines.append("ANALYSIS METHOD:")
        summary_lines.append("  Marginal age effects extracted from 3-way Age × Domain × Time LMM")
        summary_lines.append("  Evaluation timepoint: TSVR = 72.0 hours (Day 3, midpoint)")
        summary_lines.append("  Standard errors: Delta method for linear combinations")
        summary_lines.append("")
        summary_lines.append("RESULTS:")
        summary_lines.append("")

        for idx, row in age_effects.iterrows():
            summary_lines.append(f"  {row['domain']}:")
            summary_lines.append(f"    Age slope:  {row['age_slope']:.6f} (theta units per 1-year age increase)")
            summary_lines.append(f"    SE:         {row['se']:.6f}")
            summary_lines.append(f"    z:          {row['z']:.3f}")
            summary_lines.append(f"    p-value:    {row['p']:.4f}")
            summary_lines.append(f"    95% CI:     [{row['CI_lower']:.6f}, {row['CI_upper']:.6f}]")

            # Interpretation
            if row['p'] < 0.05:
                direction = "negative" if row['age_slope'] < 0 else "positive"
                summary_lines.append(f"    Interpretation: Significant {direction} age effect (p < 0.05)")
            else:
                summary_lines.append(f"    Interpretation: Non-significant age effect (p >= 0.05)")
            summary_lines.append("")

        # Overall interpretation
        summary_lines.append("OVERALL INTERPRETATION:")
        n_sig = (age_effects['p'] < 0.05).sum()
        if n_sig == 0:
            summary_lines.append("  No significant age effects detected in any domain.")
            summary_lines.append("  Age does not differentially affect forgetting rate across domains.")
        elif n_sig == 3:
            summary_lines.append("  Significant age effects detected in ALL domains.")
            summary_lines.append("  Age affects forgetting rate across all episodic memory domains.")
        else:
            sig_domains = age_effects.loc[age_effects['p'] < 0.05, 'domain'].tolist()
            summary_lines.append(f"  Significant age effects detected in {n_sig}/3 domains: {', '.join(sig_domains)}")
            summary_lines.append("  Age effects are domain-specific.")

        summary_lines.append("")
        summary_lines.append("=" * 80)

        with open(summary_path, 'w', encoding='utf-8') as f:
            f.write('\n'.join(summary_lines))

        log(f"[SAVED] {summary_path.name}")

        # =========================================================================
        # STEP 4: Validation
        # =========================================================================
        log("[VALIDATION] Validating outputs...")

        # Check output structure
        expected_cols = ['domain', 'age_slope', 'se', 'z', 'p', 'CI_lower', 'CI_upper']
        assert list(age_effects.columns) == expected_cols, f"Columns mismatch: {age_effects.columns}"
        assert len(age_effects) == 3, f"Expected 3 rows, got {len(age_effects)}"

        # Check domains
        expected_domains = {'What', 'Where', 'When'}
        actual_domains = set(age_effects['domain'])
        assert actual_domains == expected_domains, f"Domains mismatch: {actual_domains}"

        # Check value ranges
        assert all(age_effects['se'] > 0), "All SEs must be positive"
        assert all((age_effects['p'] >= 0) & (age_effects['p'] <= 1)), "P-values must be in [0, 1]"
        assert all(age_effects['CI_lower'] < age_effects['CI_upper']), "CI_lower must be < CI_upper"

        log("[VALIDATION] All checks passed")

        log("[SUCCESS] Step 04 complete")
        sys.exit(0)

    except Exception as e:
        log(f"[ERROR] {str(e)}")
        log("[TRACEBACK] Full error details:")
        with open(LOG_FILE, 'a', encoding='utf-8') as f:
            traceback.print_exc(file=f)
        traceback.print_exc()
        sys.exit(1)
