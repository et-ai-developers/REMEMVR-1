#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plotting script for RQ 5.4.1 - Schema Congruence Effects on Forgetting Trajectories

GENERATED BY: rq_plots agent (v4.0.0)
DATE: 2025-11-24
PURPOSE: Create publication-ready plots from pre-aggregated plot source CSVs

OPTION B ARCHITECTURE:
- Plot source CSVs created by analysis pipeline (g_code) in step07
- This script ONLY reads CSVs and generates plots
- NO data aggregation/transformation logic

PLOTS GENERATED:
1. trajectory_theta.png - Theta-scale trajectory (IRT latent variable)
2. trajectory_probability.png - Probability-scale trajectory (Decision D069)

DECISION D069 COMPLIANCE:
Both theta-scale AND probability-scale trajectory plots are generated
to ensure interpretability for both psychometricians and general audiences.
"""

from pathlib import Path
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import sys

# Add project root to path for imports
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from tools.plotting import set_plot_style_defaults

# =============================================================================
# SETUP
# =============================================================================

# Get absolute path to RQ root (plots.py is in results/ch5/5.4.1/plots/)
RQ_ROOT = Path(__file__).parent.parent

# Apply consistent plotting theme from config/plotting.yaml
set_plot_style_defaults()

print("=" * 70)
print("PLOTTING FOR RQ 5.4.1: Schema Congruence Effects on Forgetting")
print("=" * 70)
print(f"RQ root: {RQ_ROOT}")

# Color scheme for congruence categories (consistent with REMEMVR project)
# Using distinct colors for Common/Congruent/Incongruent
COLORS = {
    "common": "#9B59B6",       # Purple - schema-neutral baseline
    "congruent": "#2ECC71",    # Green - schema-consistent
    "incongruent": "#E74C3C"   # Red - schema-violating
}

# =============================================================================
# PLOT 1: TRAJECTORY (THETA-SCALE)
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 1: Theta-scale trajectory...")
print("-" * 70)

# Load plot source CSV (created by analysis pipeline in step07)
theta_data_path = RQ_ROOT / "plots" / "step07_trajectory_theta_data.csv"
df_theta = pd.read_csv(theta_data_path)
print(f"  Loaded {len(df_theta)} rows from step07_trajectory_theta_data.csv")
print(f"  Columns: {list(df_theta.columns)}")
print(f"  Congruence categories: {df_theta['congruence'].unique().tolist()}")

# Create figure
fig_theta, ax_theta = plt.subplots(figsize=(10, 6))

# Plot each congruence category
for congruence in ["common", "congruent", "incongruent"]:
    group_data = df_theta[df_theta["congruence"] == congruence].sort_values("time")

    color = COLORS.get(congruence, "#333333")
    label = congruence.capitalize()

    # Plot mean line with markers
    ax_theta.plot(
        group_data["time"],
        group_data["theta_mean"],
        "o-",
        color=color,
        linewidth=2.5,
        markersize=8,
        label=label
    )

    # Add confidence interval band
    ax_theta.fill_between(
        group_data["time"],
        group_data["CI_lower"],
        group_data["CI_upper"],
        color=color,
        alpha=0.2
    )

# Formatting
ax_theta.set_xlabel("Time Since VR Encoding (hours)", fontweight="bold")
ax_theta.set_ylabel("Memory Ability (Theta)", fontweight="bold")
ax_theta.set_title("RQ 5.5: Forgetting Trajectories by Schema Congruence - Theta Scale", fontweight="bold", pad=15)
ax_theta.legend(title="Congruence", loc="upper right", framealpha=0.95)
ax_theta.grid(True, alpha=0.3)

# Add horizontal reference line at theta=0
ax_theta.axhline(y=0, color="gray", linestyle="--", linewidth=1, alpha=0.5)

plt.tight_layout()

# Save theta-scale plot
theta_output_path = RQ_ROOT / "plots" / "trajectory_theta.png"
fig_theta.savefig(theta_output_path, dpi=300, bbox_inches="tight")
plt.close(fig_theta)

print(f"  [PASS] Saved: {theta_output_path}")

# =============================================================================
# PLOT 2: TRAJECTORY (PROBABILITY-SCALE) - Decision D069
# =============================================================================

print("\n" + "-" * 70)
print("Generating Plot 2: Probability-scale trajectory (Decision D069)...")
print("-" * 70)

# Load plot source CSV
prob_data_path = RQ_ROOT / "plots" / "step07_trajectory_probability_data.csv"
df_prob = pd.read_csv(prob_data_path)
print(f"  Loaded {len(df_prob)} rows from step07_trajectory_probability_data.csv")
print(f"  Columns: {list(df_prob.columns)}")

# Create figure
fig_prob, ax_prob = plt.subplots(figsize=(10, 6))

# Plot each congruence category
for congruence in ["common", "congruent", "incongruent"]:
    group_data = df_prob[df_prob["congruence"] == congruence].sort_values("time")

    color = COLORS.get(congruence, "#333333")
    label = congruence.capitalize()

    # Convert probability to percentage for display
    mean_pct = group_data["prob_mean"] * 100
    ci_lower_pct = group_data["CI_lower"] * 100
    ci_upper_pct = group_data["CI_upper"] * 100

    # Plot mean line with markers
    ax_prob.plot(
        group_data["time"],
        mean_pct,
        "o-",
        color=color,
        linewidth=2.5,
        markersize=8,
        label=label
    )

    # Add confidence interval band
    ax_prob.fill_between(
        group_data["time"],
        ci_lower_pct,
        ci_upper_pct,
        color=color,
        alpha=0.2
    )

# Formatting
ax_prob.set_xlabel("Time Since VR Encoding (hours)", fontweight="bold")
ax_prob.set_ylabel("Probability Correct (%)", fontweight="bold")
ax_prob.set_title("RQ 5.5: Forgetting Trajectories by Schema Congruence - Probability Scale", fontweight="bold", pad=15)
ax_prob.legend(title="Congruence", loc="upper right", framealpha=0.95)
ax_prob.grid(True, alpha=0.3)

# Set y-axis limits to 0-100% range
ax_prob.set_ylim(0, 100)

# Add horizontal reference line at 50% (chance level for binary items)
ax_prob.axhline(y=50, color="gray", linestyle="--", linewidth=1, alpha=0.5, label="_nolegend_")

plt.tight_layout()

# Save probability-scale plot
prob_output_path = RQ_ROOT / "plots" / "trajectory_probability.png"
fig_prob.savefig(prob_output_path, dpi=300, bbox_inches="tight")
plt.close(fig_prob)

print(f"  [PASS] Saved: {prob_output_path}")

# =============================================================================
# SUMMARY
# =============================================================================

print("\n" + "=" * 70)
print("PLOTTING COMPLETE")
print("=" * 70)
print(f"Total plots generated: 2")
print(f"  - plots/trajectory_theta.png (Theta scale)")
print(f"  - plots/trajectory_probability.png (Probability scale - Decision D069)")
print("\nDecision D069 Compliance: BOTH theta-scale AND probability-scale plots generated")
print("All plots saved with 300 DPI publication quality.")
print("=" * 70)
